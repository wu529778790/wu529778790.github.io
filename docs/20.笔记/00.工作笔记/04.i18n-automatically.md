---
title: i18n-automatically
date: 2024-09-06 11:29:26
permalink: /pages/2c161cdd6d53c/
categories:
  - 笔记
  - 工作笔记
tags:
  - 
---


## 第一版实现思路

```js
const vscode = require("vscode");
const { generateUniqueId } = require("../utils");

/**
 * 扫描当前文件，看有几处中文,替换汉语为uuid
 */
module.exports = () => {
  const activeTextEditor = vscode.window.activeTextEditor;
  const document = activeTextEditor.document;
  let text = document.getText();

  // 匹配template标签
  const templateRegex = /<template[^>]*>(.*?)<\/template>/gs;
  const templateMatches = text.match(templateRegex);
  // 记录替换过的中文
  let uniqueIds = {};
  // 生成文件uuid
  const fileUuid = generateUniqueId();
  // 记录template标签的中文个数
  let templateChineseMatches = 0;

  if (templateMatches) {
    templateMatches.forEach((templateMatch) => {
      // 扫描<template>标签中的中文
      const chineseRegex = /[\u4e00-\u9fa5]+/g;
      const chineseMatches = templateMatch.match(chineseRegex);
      if (chineseMatches) {
        console.log("template标签下的中文", chineseMatches);
        templateChineseMatches = chineseMatches.length;
        chineseMatches.forEach((chineseMatch, index) => {
          const uuid = `${fileUuid}-${index}`;
          text = text.replace(chineseMatch, `{{ $t('${uuid}') }}`);
          uniqueIds[uuid] = chineseMatch;
        });
      }
    });
  }

  // 匹配script标签
  const scriptRegex = /<script[^>]*>(.*?)<\/script>/gs;
  const scriptMatches = text.match(scriptRegex);
  if (scriptMatches) {
    scriptMatches.forEach((scriptMatch) => {
      // 扫描<script>标签中的中文
      const chineseRegex = /[\u4e00-\u9fa5]+/g;
      const chineseMatches = scriptMatch.match(chineseRegex);
      if (chineseMatches) {
        console.log("script标签下的中文", chineseMatches);
        chineseMatches.forEach((chineseMatch, index) => {
          const uuid = `${fileUuid}-${templateChineseMatches + index}`;
          text = text.replace(chineseMatch, `i18n.t('${uuid}')`);
          uniqueIds[uuid] = chineseMatch;
        });
      }
    });
  }

  // 保存替换的中文到文件
  const workspaceFolders = vscode.workspace.workspaceFolders;
  const rootPath = workspaceFolders[0].uri.fsPath;
  const configFilePath = rootPath + "/zh.json";
  vscode.workspace.fs.writeFile(
    vscode.Uri.file(configFilePath),
    Buffer.from(JSON.stringify(uniqueIds, null, 2))
  );
  uniqueIds = {};

  activeTextEditor.edit((editBuilder) => {
    // 使用 editBuilder 进行替换操作
    editBuilder.replace(
      // 创建一个新的 vscode.Range 对象，指定要替换的范围
      new vscode.Range(
        // 范围的起始行，从第一行开始
        0,
        // 范围的起始字符位置，从第一个字符开始
        0,
        // 范围的结束行，为文档的总行数
        document.lineCount,
        // 范围的结束字符位置，为文档最后一行的字符数
        document.getText().length
      ),
      // 要插入的新文本
      text
    );
  });
  // 保存修改
  activeTextEditor.document.save();
  // 更新 activeTextEditor
  vscode.window.showTextDocument(activeTextEditor.document);
};
```

上面的方案有一个问题，如果在文件中有重复的中文内容，使用replace方法进行替换时，可能会出现错误的替换结果。

以下是一些可能的解决方案来避免这种情况：

一、在替换前进行检查和区分

在进行替换之前，可以先对所有找到的中文内容进行遍历，为每个重复的中文内容生成不同的唯一 ID。

例如，可以在原来的基础上增加一个计数器，对于每一个重复的中文，计数器递增，然后将计数器的值加入到唯一 ID 的生成中。

这样可以确保即使有重复的中文，它们也会被替换为不同的 UUID 形式。

二、使用更复杂的替换方法

可以考虑使用循环和手动替换的方式，而不是直接使用replace方法。

遍历找到的所有中文内容，对于每一个中文，检查文本中是否存在该中文，如果存在则进行替换，并确保只替换第一次出现的中文。

这样可以更加精确地控制替换的过程，避免错误的替换。

三、记录替换位置

在进行替换时，记录已经替换过的位置。

当遇到重复的中文时，可以跳过已经替换过的位置，继续在后面的文本中进行替换。

这样可以确保每个中文只被替换一次，避免错误的替换。

我决定用位置替换的方式，因为这样可以避免错误的替换。

```js
chineseMatches.forEach((chineseMatch, index) => {
    const startIndex = templateMatch.indexOf(chineseMatch);
    const endIndex = startIndex + chineseMatch.length;
    const uuid = `${fileUuid}-${index}`;
    const replacement = `{{ $t('${uuid}') }}`;
    templateMatch =
    templateMatch.slice(0, startIndex) +
    replacement +
    templateMatch.slice(endIndex);
    uniqueIds[uuid] = chineseMatch;
});
text = text.replace(templateRegex.exec(text)[0], templateMatch);
```

```js
chineseMatches.forEach((chineseMatch, index) => {
    const startIndex = scriptMatch.indexOf(chineseMatch);
    const endIndex = startIndex + chineseMatch.length;
    const uuid = `${fileUuid}-${templateChineseMatches + index}`;
    const replacement = `i18n.t('${uuid}')`;
    scriptMatch =
    scriptMatch.slice(0, startIndex) +
    replacement +
    scriptMatch.slice(endIndex);
    uniqueIds[uuid] = chineseMatch;
});
text = text.replace(scriptRegex.exec(text)[0], scriptMatch);
```

```js

```
