<p data-nodeid="39436" class="">é€šè¿‡ä¸Šä¸€è®²çš„å†…å®¹ï¼Œç›¸ä¿¡ä½ å·²ç»äº†è§£äº†ç°ä»£åŒ–æ„å»ºæµç¨‹å’Œå¤„ç†å†…å®¹ã€‚è¿™ä¸€è®²ï¼Œæˆ‘å°†ç»“åˆ Webpack ä¸ºä¸»çš„æˆç†Ÿæ–¹æ¡ˆç°é˜¶æ®µçš„â€œä¸è¶³â€ï¼Œä»æºç å®ç°è§’åº¦å¸¦ä½ åˆ†æ Vite çš„è®¾è®¡å“²å­¦ï¼ŒåŒæ—¶ä¸ºâ€œè§£æ Webpack æºç ï¼Œå®ç°è‡ªå·±çš„æ„å»ºå·¥å…·â€ä¸€è®²å†…å®¹æ‰“ä¸‹åŸºç¡€ï¼Œå¾ªåºæ¸è¿›ï¼Œæœ€ç»ˆä½ å°†èƒ½å¤Ÿå¼€å‘ä¸€ä¸ªè‡ªå·±çš„æ„å»ºå·¥å…·ã€‚</p>
<h3 data-nodeid="39437">Vite çš„â€œæ¨ªç©ºå‡ºä¸–â€</h3>
<p data-nodeid="39438">Vite æ˜¯ç”± Vue ä½œè€…å°¤é›¨æºªå¼€å‘çš„ Web å¼€å‘å·¥å…·ï¼Œå°¤é›¨æºªåœ¨å¾®åšä¸Šæ¨å¹¿æ—¶å¯¹ Vite åšäº†ç®€çŸ­ä»‹ç»ï¼š</p>
<blockquote data-nodeid="39439">
<p data-nodeid="39440">Viteï¼Œä¸€ä¸ªåŸºäºæµè§ˆå™¨åŸç”Ÿ ES imports çš„å¼€å‘æœåŠ¡å™¨ã€‚åˆ©ç”¨æµè§ˆå™¨å»è§£æ importsï¼Œåœ¨æœåŠ¡å™¨ç«¯æŒ‰éœ€ç¼–è¯‘è¿”å›ï¼Œå®Œå…¨è·³è¿‡äº†æ‰“åŒ…è¿™ä¸ªæ¦‚å¿µï¼ŒæœåŠ¡å™¨éšèµ·éšç”¨ã€‚åŒæ—¶ä¸ä»…æœ‰ Vue æ–‡ä»¶æ”¯æŒï¼Œè¿˜æå®šäº†çƒ­æ›´æ–°ï¼Œè€Œä¸”çƒ­æ›´æ–°çš„é€Ÿåº¦ä¸ä¼šéšç€æ¨¡å—å¢å¤šè€Œå˜æ…¢ã€‚é’ˆå¯¹ç”Ÿäº§ç¯å¢ƒåˆ™å¯ä»¥æŠŠåŒä¸€ä»½ä»£ç ç”¨ Rollup æ‰“åŒ…ã€‚è™½ç„¶ç°åœ¨è¿˜æ¯”è¾ƒç²—ç³™ï¼Œä½†è¿™ä¸ªæ–¹å‘æˆ‘è§‰å¾—æ˜¯æœ‰æ½œåŠ›çš„ï¼Œåšå¾—å¥½å¯ä»¥å½»åº•è§£å†³æ”¹ä¸€è¡Œä»£ç ç­‰åŠå¤©çƒ­æ›´æ–°çš„é—®é¢˜ã€‚</p>
</blockquote>
<p data-nodeid="39441">ä»è¿™æ®µè¯ä¸­æˆ‘ä»¬èƒ½å¤Ÿæç‚¼ä¸€äº›å…³é”®ç‚¹ï¼š</p>
<ul data-nodeid="39442">
<li data-nodeid="39443">
<p data-nodeid="39444">Vite åŸºäº ESMï¼Œå› æ­¤å®ç°äº†å¿«é€Ÿå¯åŠ¨å’Œå³æ—¶æ¨¡å—çƒ­æ›´æ–°èƒ½åŠ›ï¼›</p>
</li>
<li data-nodeid="39445">
<p data-nodeid="39446">Vite åœ¨æœåŠ¡ç«¯å®ç°äº†æŒ‰éœ€ç¼–è¯‘ã€‚</p>
</li>
</ul>
<p data-nodeid="39447">ç»éªŒä¸°å¯Œçš„å¼€å‘è€…é€šè¿‡ä¸Šè¿°ä»‹ç»ï¼Œä¼¼ä¹å°±èƒ½ç»™å‡º Vite çš„åŸºæœ¬æµç¨‹ï¼Œç”šè‡³å¯ä»¥è¯´å¾—æ›´ç›´ç™½ä¸€äº›ï¼š<strong data-nodeid="39585">Vite åœ¨å¼€å‘ç¯å¢ƒä¸‹å¹¶æ²¡æœ‰æ‰“åŒ…å’Œæ„å»ºè¿‡ç¨‹</strong>ã€‚</p>
<p data-nodeid="39448">å¼€å‘è€…åœ¨ä»£ç ä¸­å†™åˆ°çš„ ESM å¯¼å…¥è¯­æ³•ä¼šç›´æ¥å‘é€ç»™æœåŠ¡å™¨ï¼Œè€ŒæœåŠ¡å™¨ä¹Ÿç›´æ¥å°† ESM æ¨¡å—å†…å®¹è¿è¡Œå¤„ç†åï¼Œä¸‹å‘ç»™æµè§ˆå™¨ã€‚æ¥ç€ï¼Œç°ä»£æµè§ˆå™¨é€šè¿‡è§£æ script moduleï¼Œå¯¹æ¯ä¸€ä¸ª import åˆ°çš„æ¨¡å—è¿›è¡Œ HTTP è¯·æ±‚ï¼ŒæœåŠ¡å™¨ç»§ç»­å¯¹è¿™äº› HTTP è¯·æ±‚è¿›è¡Œå¤„ç†å¹¶å“åº”ã€‚</p>
<h3 data-nodeid="39449">Vite å®ç°åŸç†è§£è¯»</h3>
<p data-nodeid="39450">Vite æ€æƒ³æ¯”è¾ƒå®¹æ˜“ç†è§£ï¼Œå®ç°èµ·æ¥ä¹Ÿå¹¶ä¸å¤æ‚ã€‚æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°±å¯¹ Vite æºç è¿›è¡Œåˆ†æï¼Œå¸®åŠ©ä½ æ›´å¥½åœ°ä½“ä¼šå®ƒçš„è®¾è®¡å“²å­¦å’Œå®ç°æŠ€å·§ã€‚</p>
<p data-nodeid="39451">é¦–å…ˆï¼Œæˆ‘ä»¬æ‰“é€ ä¸€ä¸ªå­¦ä¹ ç¯å¢ƒï¼Œåˆ›å»ºä¸€ä¸ªåŸºäº Vite çš„åº”ç”¨ï¼Œå¹¶å¯åŠ¨ï¼š</p>
<pre class="lang-java" data-nodeid="39452"><code data-language="java">npm init vite-app vite-app
cd vite-app
npm install
npm run dev
</code></pre>
<p data-nodeid="39453">å¾—åˆ°ä»¥ä¸‹ç›®å½•ç»“æ„å’Œé¡µé¢å†…å®¹ï¼š</p>
<p data-nodeid="39454"><img src="https://s0.lgstatic.com/i/image/M00/8C/18/Ciqc1F_ltOCAMzS3AAHqGo5sIeo562.png" alt="Lark20201225-174521.png" data-nodeid="39593"></p>
<p data-nodeid="39455"><img src="https://s0.lgstatic.com/i/image2/M01/03/A7/Cip5yF_gX_iAUku7AAK-5yeYi0A500.png" alt="Drawing 1.png" data-nodeid="39596"></p>
<p data-nodeid="39456">å…¶ä¸­æµè§ˆå™¨è¯·æ±‚ï¼š<code data-backticks="1" data-nodeid="39598">http://localhost:3000/</code>ï¼Œå¾—åˆ°çš„å†…å®¹å³æ˜¯æˆ‘ä»¬åº”ç”¨é¡¹ç›®ä¸­çš„ index.html å†…å®¹ã€‚</p>
<p data-nodeid="39457">åœ¨é¡¹ç›® packaga.json ä¸­ï¼Œæˆ‘ä»¬çœ‹åˆ°ï¼š</p>
<pre class="lang-java" data-nodeid="39458"><code data-language="java"><span class="hljs-string">"scripts"</span>: {
    <span class="hljs-string">"dev"</span>: <span class="hljs-string">"vite"</span>,
    <span class="hljs-comment">// ...</span>
 },
</code></pre>
<p data-nodeid="39459">æ‰¾åˆ° Vite æºç ä¸­ï¼Œ<a href="https://github.com/vitejs/vite/blob/master/src/node/cli.ts#L66" data-nodeid="39604">å‘½ä»¤è¡Œå®ç°éƒ¨åˆ†ï¼š</a></p>
<pre class="lang-java" data-nodeid="39460"><code data-language="java"><span class="hljs-keyword">if</span> (!options.command || options.command === <span class="hljs-string">'serve'</span>) {
	runServe(options)
} <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (options.command === <span class="hljs-string">'build'</span>) {
	runBuild(options)
} <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (options.command === <span class="hljs-string">'optimize'</span>) {
	runOptimize(options)
} <span class="hljs-keyword">else</span> {
	console.error(chalk.red(`unknown command: ${options.command}`))
	process.exit(<span class="hljs-number">1</span>)
}
</code></pre>
<p data-nodeid="39461">ä¸Šé¢ä»£ç ï¼Œæ ¹æ®ä¸åŒçš„å‘½ä»¤è¡Œå‘½ä»¤ï¼Œæ‰§è¡Œä¸åŒçš„å…¥å£å‡½æ•°ã€‚</p>
<p data-nodeid="39462">åœ¨å¼€å‘æ¨¡å¼ä¸‹ï¼ŒVite é€šè¿‡ runServe æ–¹æ³•ï¼Œå¯åŠ¨äº†ä¸€ä¸ª koaServerï¼Œæ¥å®ç°å¯¹æµè§ˆå™¨è¯·æ±‚çš„å“åº”ï¼Œ<a href="https://github.com/vitejs/vite/blob/c3ef4f64ec09c6916f4e6b9764362a23843b98b6/src/node/cli.ts#L131" data-nodeid="39609">runServer å®ç°</a>å¦‚ä¸‹ï¼š</p>
<pre class="lang-java" data-nodeid="39463"><code data-language="java"><span class="hljs-keyword">const</span> server = require(<span class="hljs-string">'./server'</span>).createServer(options)
</code></pre>
<p data-nodeid="39464"><a href="https://github.com/vitejs/vite/blob/c3ef4f64ec09c6916f4e6b9764362a23843b98b6/src/node/server/index.ts#L50" data-nodeid="39613">createServer æ–¹æ³•å®ç°</a>ï¼Œæˆ‘ä»¬å¯ä»¥ç²¾ç®€ä¸ºä»¥ä¸‹å†…å®¹ï¼š</p>
<pre class="lang-java" data-nodeid="39465"><code data-language="java"><span class="hljs-function">export function <span class="hljs-title">createServer</span><span class="hljs-params">(config: ServerConfig)</span>: Server </span>{
  <span class="hljs-keyword">const</span> {
    root = process.cwd(),
    configureServer = [],
    resolvers = [],
    alias = {},
    transforms = [],
    vueCustomBlockTransforms = {},
    optimizeDeps = {},
    enableEsbuild = <span class="hljs-keyword">true</span>
  } = config
  <span class="hljs-comment">//&nbsp;åˆ›å»º Koa å®ä¾‹</span>
  <span class="hljs-keyword">const</span> app = <span class="hljs-keyword">new</span> Koa&lt;State, Context&gt;()
  <span class="hljs-keyword">const</span> server = resolveServer(config, app.callback())
  <span class="hljs-keyword">const</span> resolver = createResolver(root, resolvers, alias)
  <span class="hljs-comment">// ç›¸å…³ä¸Šä¸‹æ–‡ä¿¡æ¯&nbsp;</span>
  <span class="hljs-keyword">const</span> context: ServerPluginContext = {
    root,
    app,
    server,
    resolver,
    config,
    port: config.port || <span class="hljs-number">3000</span>
  }
  <span class="hljs-comment">// ä¸€ä¸ªç®€å•ä¸­é—´ä»¶ï¼Œæ‰©å…… context ä¸Šä¸‹æ–‡å†…å®¹</span>
  app.use((ctx, next) =&gt; {
    Object.assign(ctx, context)
    ctx.read = cachedRead.bind(<span class="hljs-keyword">null</span>, ctx)
    <span class="hljs-keyword">return</span> next()
  })
  <span class="hljs-keyword">const</span> resolvedPlugins = [
    <span class="hljs-comment">// ...</span>
  ]

  resolvedPlugins.forEach((m) =&gt; m &amp;&amp; m(context))
  <span class="hljs-keyword">const</span> listen = server.listen.bind(server)
  server.listen = (async (port: number, ...args: any[]) =&gt; {
    <span class="hljs-keyword">if</span> (optimizeDeps.auto !== <span class="hljs-keyword">false</span>) {
      <span class="hljs-function">await <span class="hljs-title">require</span><span class="hljs-params">(<span class="hljs-string">'../optimizer'</span>)</span>.<span class="hljs-title">optimizeDeps</span><span class="hljs-params">(config)</span>
    }
    <span class="hljs-keyword">const</span> listener </span>= listen(port, ...args)
    context.port = server.address().port
    <span class="hljs-keyword">return</span> listener
  }) as any
  <span class="hljs-keyword">return</span> server
}
</code></pre>
<p data-nodeid="39466">æµè§ˆå™¨åœ¨è®¿é—®<code data-backticks="1" data-nodeid="39616">http://localhost:3000/</code>åï¼Œå¾—åˆ°äº†ä¸»ä½“ä¸ºï¼š</p>
<pre class="lang-java" data-nodeid="39467"><code data-language="java">&lt;body&gt;
  &lt;di v id="app"&gt;&lt;/div&gt;
  &lt;script type="module" src="/src/main.js"&gt;&lt;/script&gt;
&lt;/body&gt;
</code></pre>
<p data-nodeid="39468">çš„å†…å®¹ã€‚</p>
<p data-nodeid="39469">ä¾æ® ESM è§„èŒƒåœ¨æµè§ˆå™¨ script æ ‡ç­¾ä¸­çš„å®ç°ï¼Œå¯¹äº<code data-backticks="1" data-nodeid="39620">&lt;script type="module" src="./bar.js"&gt;&lt;/script&gt;</code>å†…å®¹ï¼š<strong data-nodeid="39626">å½“å‡ºç° script æ ‡ç­¾ type å±æ€§ä¸º module æ—¶ï¼Œæµè§ˆå™¨å°†ä¼šè¯·æ±‚æ¨¡å—ç›¸åº”å†…å®¹</strong>ã€‚</p>
<p data-nodeid="39470">å¦ä¸€ç§ ESM è§„èŒƒåœ¨æµè§ˆå™¨ script æ ‡ç­¾ä¸­çš„å®ç°ä¸ºï¼š</p>
<pre class="lang-java" data-nodeid="39471"><code data-language="java">&lt;script type="module"&gt;
  import { bar } from './bar.jsâ€˜
&lt;/script&gt;
</code></pre>
<p data-nodeid="39472">æµè§ˆå™¨ä¼šå‘èµ· HTTP è¯·æ±‚ï¼Œè¯·æ±‚ HTTP Server æ‰˜ç®¡çš„ bar.jsã€‚</p>
<p data-nodeid="39473">æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œç»è¿‡ Vite Server å¤„ç† http://localhost:3000/src/main.js è¯·æ±‚åï¼Œæœ€ç»ˆè¿”å›äº†ï¼š</p>
<p data-nodeid="39474"><img src="https://s0.lgstatic.com/i/image/M00/8C/18/Ciqc1F_ltQGAaQZkAAXD68sxUe4161.png" alt="Lark20201225-174524.png" data-nodeid="39632"></p>
<p data-nodeid="39475">è¿”å›å†…å®¹å’Œæˆ‘ä»¬é¡¹ç›®ä¸­çš„ ./src/main.js ç•¥æœ‰å·®åˆ«ï¼š</p>
<pre class="lang-java" data-nodeid="39476"><code data-language="java"><span class="hljs-keyword">import</span> { createApp } from <span class="hljs-string">'vue'</span>
<span class="hljs-keyword">import</span> App from <span class="hljs-string">'./App.vue'</span>
<span class="hljs-keyword">import</span> <span class="hljs-string">'./index.css'</span>
</code></pre>
<p data-nodeid="39477">ç°åœ¨å˜ä¸ºï¼š</p>
<pre class="lang-java" data-nodeid="39478"><code data-language="java"><span class="hljs-keyword">import</span> { createApp } from <span class="hljs-string">'/@modules/vue.js'</span>
<span class="hljs-keyword">import</span> App from <span class="hljs-string">'/src/App.vue'</span>
<span class="hljs-keyword">import</span> <span class="hljs-string">'/src/index.css?import'</span>
</code></pre>
<p data-nodeid="39479">è¿™é‡Œæˆ‘ä»¬æ‹†æˆä¸¤éƒ¨åˆ†æ¥çœ‹ã€‚</p>
<p data-nodeid="39480">å…¶ä¸­<code data-backticks="1" data-nodeid="39637">import { createApp } from 'vue'</code>æ”¹ä¸º<code data-backticks="1" data-nodeid="39639">import { createApp } from '/@modules/vue.js'</code>ï¼ŒåŸå› å¾ˆæ˜æ˜¾ï¼š<strong data-nodeid="39656">import å¯¹åº”çš„è·¯å¾„åªæ”¯æŒ "/""./"æˆ–è€… "../" å¼€å¤´çš„å†…å®¹ï¼Œç›´æ¥ä½¿ç”¨æ¨¡å—å importï¼Œä¼šç«‹å³æŠ¥é”™</strong>ã€‚</p>
<p data-nodeid="39481">æ‰€ä»¥åœ¨ Vite Server å¤„ç†è¯·æ±‚æ—¶ï¼Œé€šè¿‡ serverPluginModuleRewrite è¿™ä¸ªä¸­é—´ä»¶æ¥ç»™ import from 'A' çš„ A æ·»åŠ  /@module/ å‰ç¼€ä¸º from '/@modules/A'ï¼Œ<a href="https://github.com/vitejs/vite/blob/master/src/node/server/index.ts#L97" data-nodeid="39668">æºç éƒ¨åˆ†å¯¹åº”</a>ï¼š</p>
<pre class="lang-java" data-nodeid="39482"><code data-language="java"><span class="hljs-keyword">const</span> resolvedPlugins = [
  <span class="hljs-comment">// ...</span>
  moduleRewritePlugin,
  <span class="hljs-comment">// ...</span>
]
resolvedPlugins.forEach((m) =&gt; m &amp;&amp; m(context))
</code></pre>
<p data-nodeid="39483">è€Œ moduleRewritePlugin æ’ä»¶çš„<a href="https://github.com/vitejs/vite/blob/c3ef4f64ec09c6916f4e6b9764362a23843b98b6/src/node/server/serverPluginModuleRewrite.ts#L48" data-nodeid="39673">å®ç°</a>ä¹Ÿå¹¶ä¸å›°éš¾ï¼Œä¸»è¦é€šè¿‡ <a href="https://github.com/vitejs/vite/blob/c3ef4f64ec09c6916f4e6b9764362a23843b98b6/src/node/server/serverPluginModuleRewrite.ts#L120" data-nodeid="39677">rewriteImports æ–¹æ³•</a>ï¼Œæ¥æ‰§è¡Œ <a href="https://github.com/vitejs/vite/blob/c3ef4f64ec09c6916f4e6b9764362a23843b98b6/src/node/server/serverPluginModuleRewrite.ts#L259" data-nodeid="39681">resolveImport æ–¹æ³•</a>ï¼Œå¹¶è¿›è¡Œæ”¹å†™ã€‚è¿™é‡Œå·²ç»æ·»åŠ äº†ç›¸å…³æºç é“¾æ¥ï¼Œæˆ‘ä»¬ä¸å†ä¸€ä¸€å±•å¼€ï¼Œä½ å¯ä»¥åœ¨è¯¾åè¿›ä¸€æ­¥å­¦ä¹ ã€‚</p>
<p data-nodeid="39484">æ•´ä¸ªè¿‡ç¨‹å’Œè°ƒç”¨é“¾è·¯è¾ƒé•¿ï¼Œæˆ‘å¯¹ Vite å¤„ç† import æ–¹æ³•åšä¸€ä¸ªç®€å•æ€»ç»“ï¼š</p>
<ul data-nodeid="39485">
<li data-nodeid="39486">
<p data-nodeid="39487">åœ¨ koa ä¸­é—´ä»¶é‡Œè·å–è¯·æ±‚ path å¯¹åº”çš„ body å†…å®¹ï¼›</p>
</li>
<li data-nodeid="39488">
<p data-nodeid="39489">é€šè¿‡ <a href="https://github.com/guybedford/es-module-lexer" data-nodeid="39688">es-module-lexer</a> è§£æèµ„æº ASTï¼Œå¹¶æ‹¿åˆ° import çš„å†…å®¹ï¼›</p>
</li>
<li data-nodeid="39490">
<p data-nodeid="39491">å¦‚æœåˆ¤æ–­ import çš„èµ„æºæ˜¯ç»å¯¹è·¯å¾„ï¼Œå³å¯è®¤ä¸ºè¯¥èµ„æºä¸º npm æ¨¡å—ï¼Œå¹¶è¿”å›å¤„ç†åçš„èµ„æºè·¯å¾„ã€‚æ¯”å¦‚ä¸Šè¿°ä»£ç ä¸­ï¼Œvue â†’ /@modules/vueã€‚</p>
</li>
</ul>
<p data-nodeid="39492">å¯¹äºå½¢å¦‚ï¼š<code data-backticks="1" data-nodeid="39692">import App from './App.vue'</code>å’Œ<code data-backticks="1" data-nodeid="39694">import './index.css'</code>çš„å¤„ç†ï¼Œä¸ä¸Šè¿°æƒ…å†µç±»ä¼¼ï¼š</p>
<ul data-nodeid="39493">
<li data-nodeid="39494">
<p data-nodeid="39495">åœ¨ koa ä¸­é—´ä»¶é‡Œè·å–è¯·æ±‚ path å¯¹åº”çš„ body å†…å®¹ï¼›</p>
</li>
<li data-nodeid="39496">
<p data-nodeid="39497">é€šè¿‡ <a href="https://github.com/guybedford/es-module-lexer" data-nodeid="39700">es-module-lexer</a> è§£æèµ„æº ASTï¼Œå¹¶æ‹¿åˆ° import çš„å†…å®¹ï¼›</p>
</li>
<li data-nodeid="39498">
<p data-nodeid="39499">å¦‚æœåˆ¤æ–­ import çš„èµ„æºæ˜¯ç›¸å¯¹è·¯å¾„ï¼Œå³å¯è®¤ä¸ºè¯¥èµ„æºä¸ºé¡¹ç›®åº”ç”¨ä¸­èµ„æºï¼Œå¹¶è¿”å›å¤„ç†åçš„èµ„æºè·¯å¾„ã€‚æ¯”å¦‚ä¸Šè¿°ä»£ç ä¸­ï¼Œ./App.vue â†’ /src/App.vueã€‚</p>
</li>
</ul>
<p data-nodeid="39500">æ¥ä¸‹æ¥æµè§ˆå™¨æ ¹æ® main.js çš„å†…å®¹ï¼Œåˆ†åˆ«è¯·æ±‚ï¼š</p>
<pre class="lang-java" data-nodeid="39501"><code data-language="java">/<span class="hljs-meta">@modules</span>/vue.js
/src/App.vue
/src/index.css?<span class="hljs-keyword">import</span>
</code></pre>
<p data-nodeid="39502">å¯¹äº /@module/ ç±»è¯·æ±‚è¾ƒä¸ºå®¹æ˜“ï¼Œæˆ‘ä»¬åªéœ€è¦å®Œæˆä¸‹é¢ä¸‰æ­¥ï¼š</p>
<ul data-nodeid="39503">
<li data-nodeid="39504">
<p data-nodeid="39505">åœ¨ koa ä¸­é—´ä»¶é‡Œè·å–è¯·æ±‚ path å¯¹åº”çš„ body å†…å®¹ï¼›</p>
</li>
<li data-nodeid="39506">
<p data-nodeid="39507">åˆ¤æ–­è·¯å¾„æ˜¯å¦ä»¥ /@module/ å¼€å¤´ï¼Œå¦‚æœæ˜¯ï¼Œå–å‡ºåŒ…åï¼ˆè¿™é‡Œä¸º vue.jsï¼‰ï¼›</p>
</li>
<li data-nodeid="39508">
<p data-nodeid="39509">å» node_modules æ–‡ä»¶ä¸­æ‰¾åˆ°å¯¹åº”çš„ npm åº“ï¼Œå¹¶è¿”å›å†…å®¹ã€‚</p>
</li>
</ul>
<p data-nodeid="39510">ä¸Šè¿°æ­¥éª¤åœ¨ Vite ä¸­ä½¿ç”¨ serverPluginModuleResolve ä¸­é—´ä»¶å®ç°ï¼Œç‚¹å‡»è¿™é‡Œå¯ä»¥è®¿é—®<a href="https://github.com/vitejs/vite/blob/c3ef4f64ec09c6916f4e6b9764362a23843b98b6/src/node/server/serverPluginModuleResolve.ts#L22" data-nodeid="39713">å¯¹åº”æºç </a>ã€‚</p>
<p data-nodeid="39511">æ¥ç€ï¼Œå°±æ˜¯å¯¹ /src/App.vue ç±»è¯·æ±‚è¿›è¡Œå¤„ç†ï¼Œè¿™å°±æ¶‰åŠ Vite æœåŠ¡å™¨çš„ç¼–è¯‘èƒ½åŠ›äº†ã€‚</p>
<p data-nodeid="39512">æˆ‘ä»¬å…ˆçœ‹ç»“æœï¼Œå¯¹æ¯”é¡¹ç›®ä¸­çš„ App.vueï¼Œæµè§ˆå™¨è¯·æ±‚å¾—åˆ°çš„ç»“æœæ˜¾ç„¶å‡ºç°äº†å¤§å˜æ ·ï¼š</p>
<p data-nodeid="39513"><img src="https://s0.lgstatic.com/i/image/M00/8B/C6/Ciqc1F_gYEGAL6S2AASUUhepUGQ785.png" alt="Drawing 3.png" data-nodeid="39719"></p>
<p data-nodeid="39514">å®é™…ä¸Šï¼ŒApp.vue è¿™æ ·çš„å•æ–‡ä»¶ç»„ä»¶å¯¹åº” scriptã€style å’Œ templateï¼Œåœ¨ç»è¿‡ Vite Server å¤„ç†æ—¶ï¼ŒæœåŠ¡ç«¯å¯¹ scriptã€style å’Œ template ä¸‰éƒ¨åˆ†åˆ†åˆ«å¤„ç†ï¼Œå¯¹åº”ä¸­é—´ä»¶ä¸º <a href="https://github.com/vitejs/vite/blob/c3ef4f64ec09c6916f4e6b9764362a23843b98b6/src/node/server/serverPluginVue.ts" data-nodeid="39723">serverPluginVue</a>ã€‚è¿™ä¸ªä¸­é—´ä»¶çš„å®ç°å¾ˆç®€å•ï¼Œå³<strong data-nodeid="39733">å¯¹ .vue æ–‡ä»¶è¯·æ±‚è¿›è¡Œå¤„ç†ï¼Œé€šè¿‡ parseSFC æ–¹æ³•è§£æå•æ–‡ä»¶ç»„ä»¶ï¼Œå¹¶é€šè¿‡ compileSFCMain æ–¹æ³•å°†å•æ–‡ä»¶ç»„ä»¶æ‹†åˆ†</strong>ä¸ºå½¢å¦‚ä¸Šå›¾å†…å®¹ï¼Œå¯¹åº”ä¸­é—´ä»¶å…³é”®å†…å®¹å¯åœ¨æºç  vuePlugin ä¸­æ‰¾åˆ°ã€‚æºç ä¸­ï¼Œæ¶‰åŠ <a href="https://github.com/vitejs/vite/blob/c3ef4f64ec09c6916f4e6b9764362a23843b98b6/src/node/server/serverPluginVue.ts#L377" data-nodeid="39731">parseSFC</a> å…·ä½“æ‰€åšçš„äº‹æƒ…ï¼Œæ˜¯è°ƒç”¨ @vue/compiler-sfc è¿›è¡Œå•æ–‡ä»¶ç»„ä»¶è§£æã€‚ç²¾ç®€ä¸ºæˆ‘è‡ªå·±çš„é€»è¾‘ï¼Œå¸®åŠ©ä½ ç†è§£ï¼š</p>
<pre class="lang-java" data-nodeid="39515"><code data-language="java"><span class="hljs-keyword">if</span> (!query.type) {
  ctx.body = `
    <span class="hljs-keyword">const</span> __script = ${descriptor.script.content.replace(<span class="hljs-string">'export default '</span>, <span class="hljs-string">''</span>)}
    <span class="hljs-comment">// å•æ–‡ä»¶ç»„ä»¶ä¸­ï¼Œå¯¹äº style éƒ¨åˆ†çš„ç¼–è¯‘ï¼Œç¼–è¯‘ä¸ºå¯¹åº” style æ ·å¼çš„ import è¯·æ±‚</span>
    ${descriptor.styles.length ? `<span class="hljs-keyword">import</span> <span class="hljs-string">"${url}?type=style"</span>` : <span class="hljs-string">''</span>}
    <span class="hljs-comment">// å•æ–‡ä»¶ç»„ä»¶ä¸­ï¼Œå¯¹äº template éƒ¨åˆ†çš„ç¼–è¯‘ï¼Œç¼–è¯‘ä¸ºå¯¹åº” template æ ·å¼çš„ import è¯·æ±‚</span>
    <span class="hljs-keyword">import</span> { render as __render } from <span class="hljs-string">"${url}?type=template"</span>
    <span class="hljs-comment">// æ¸²æŸ“ template çš„å†…å®¹</span>
    __script.render = __render;
    export <span class="hljs-keyword">default</span> __script;
  `;
}
</code></pre>
<p data-nodeid="39516">æ€»è€Œè¨€ä¹‹ï¼Œæ¯ä¸€ä¸ª .vue å•æ–‡ä»¶ç»„ä»¶éƒ½è¢«æ‹†åˆ†æˆå¤šä¸ªè¯·æ±‚ã€‚æ¯”å¦‚å¯¹åº”ä¸Šé¢åœºæ™¯ï¼Œæµè§ˆå™¨æ¥æ”¶åˆ° App.vue å¯¹åº”çš„å®é™…å†…å®¹åï¼Œå‘å‡º HelloWorld.vue ä»¥åŠ App.vue?type=template çš„è¯·æ±‚ï¼ˆé€šè¿‡ type è¿™ä¸ª query æ¥è¡¨ç¤ºæ˜¯ template è¿˜æ˜¯ styleï¼‰ã€‚koa server è¿›è¡Œåˆ†åˆ«å¤„ç†å¹¶è¿”å›ï¼Œè¿™äº›è¯·æ±‚ä¾ç„¶åˆ†åˆ«è¢«ä¸Šé¢æåˆ°çš„ serverPluginVue ä¸­é—´ä»¶å¤„ç†ï¼šå¯¹äº template çš„è¯·æ±‚ï¼ŒæœåŠ¡ä½¿ç”¨ @vue/compiler-dom è¿›è¡Œç¼–è¯‘ template å¹¶è¿”å›å†…å®¹ã€‚</p>
<p data-nodeid="39517">ç²¾ç®€ä¸ºæˆ‘è‡ªå·±çš„é€»è¾‘ï¼Œå¸®åŠ©ä½ ç†è§£ï¼š</p>
<pre class="lang-java" data-nodeid="39518"><code data-language="java"><span class="hljs-keyword">if</span> (query.type === <span class="hljs-string">'template'</span>) {
	<span class="hljs-keyword">const</span> template = descriptor.template;
	<span class="hljs-keyword">const</span> render = require(<span class="hljs-string">'@vue/compiler-dom'</span>).compile(template.content, {
	  mode: <span class="hljs-string">'module'</span>,
	}).code;
	ctx.type = <span class="hljs-string">'application/javascript'</span>;
	ctx.body = render;
}
</code></pre>
<p data-nodeid="39519">å¯¹äºä¸Šé¢æåˆ°çš„ http://localhost:3000/src/index.css?import è¯·æ±‚ç¨å¾®ç‰¹æ®Šï¼Œéœ€é€šè¿‡ serverPluginVue æ¥å®ç°è§£æï¼š</p>
<pre class="lang-java" data-nodeid="39520"><code data-language="java"><span class="hljs-comment">//&nbsp;style ç±»å‹è¯·æ±‚</span>
<span class="hljs-keyword">if</span> (query.type === <span class="hljs-string">'style'</span>) {
  <span class="hljs-keyword">const</span> index = Number(query.index)
  <span class="hljs-keyword">const</span> styleBlock = descriptor.styles[index]
  <span class="hljs-keyword">if</span> (styleBlock.src) {
    filePath = <span class="hljs-function">await <span class="hljs-title">resolveSrcImport</span><span class="hljs-params">(root, styleBlock, ctx, resolver)</span>
  }
  <span class="hljs-keyword">const</span> id </span>= hash_sum(publicPath)
  <span class="hljs-comment">//&nbsp;è°ƒç”¨ compileSFCStyle æ–¹æ³•ç¼–è¯‘å½“æ–‡ä»¶ç»„ä»¶æ ·å¼éƒ¨åˆ†</span>
  <span class="hljs-keyword">const</span> result = <span class="hljs-function">await <span class="hljs-title">compileSFCStyle</span><span class="hljs-params">(
    root,
    styleBlock,
    index,
    filePath,
    publicPath,
    config
  )</span>
  ctx.type </span>= <span class="hljs-string">'js'</span>
  <span class="hljs-comment">//&nbsp;è¿”å›æ ·å¼å†…å®¹</span>
  ctx.body = codegenCss(`${id}-${index}`, result.code, result.modules)
  <span class="hljs-keyword">return</span> etagCacheCheck(ctx)
}
</code></pre>
<p data-nodeid="39521">è°ƒç”¨ <a href="https://github.com/vitejs/vite/blob/38f811c5b077f437ffff072276531e8f75953e94/src/node/server/serverPluginCss.ts" data-nodeid="39740">serverPluginCss</a> ä¸­é—´ä»¶çš„ codegenCss æ–¹æ³•ï¼š</p>
<pre class="lang-java" data-nodeid="39522"><code data-language="java"><span class="hljs-function">export function <span class="hljs-title">codegenCss</span><span class="hljs-params">(
  id: string,
  css: string,
  modules?: Record&lt;string, string&gt;
)</span>: string </span>{
  <span class="hljs-comment">// æ ·å¼ä»£ç æ¨¡æ¿</span>
  let code =
    `<span class="hljs-keyword">import</span> { updateStyle } from <span class="hljs-string">"${clientPublicPath}"</span>\n` +
    `<span class="hljs-keyword">const</span> css = ${JSON.stringify(css)}\n` +
    `updateStyle(${JSON.stringify(id)}, css)\n`
  <span class="hljs-keyword">if</span> (modules) {
    code += dataToEsm(modules, { namedExports: <span class="hljs-keyword">true</span> })
  } <span class="hljs-keyword">else</span> {
    code += `export <span class="hljs-keyword">default</span> css`
  }
  <span class="hljs-keyword">return</span> code
}
</code></pre>
<p data-nodeid="39523">è¯¥æ–¹æ³•ä¼šåœ¨æµè§ˆå™¨ä¸­æ‰§è¡Œ updateStyle æ–¹æ³•ï¼Œ<a href="https://github.com/vitejs/vite/blob/c3ef4f64ec09c6916f4e6b9764362a23843b98b6/src/client/client.ts#L170" data-nodeid="39745">æºç </a>å¦‚ä¸‹ï¼š</p>
<pre class="lang-java" data-nodeid="39524"><code data-language="java"><span class="hljs-keyword">const</span> supportsConstructedSheet = (() =&gt; {
  <span class="hljs-keyword">try</span> {
    <span class="hljs-comment">// ç”Ÿæˆ CSSStyleSheet å®ä¾‹ï¼Œè¯•æ¢æ˜¯å¦æ”¯æŒ ConstructedSheet</span>
    <span class="hljs-keyword">new</span> CSSStyleSheet()
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">true</span>
  } <span class="hljs-keyword">catch</span> (e) {}
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">false</span>
})()
<span class="hljs-function">export function <span class="hljs-title">updateStyle</span><span class="hljs-params">(id: string, content: string)</span> </span>{
  let style = sheetsMap.get(id)
  <span class="hljs-keyword">if</span> (supportsConstructedSheet &amp;&amp; !content.includes(<span class="hljs-string">'@import'</span>)) {
    <span class="hljs-keyword">if</span> (style &amp;&amp; !(style <span class="hljs-keyword">instanceof</span> CSSStyleSheet)) {
      removeStyle(id)
      style = undefined
    }
    <span class="hljs-keyword">if</span> (!style) {
      <span class="hljs-comment">// ç”Ÿæˆ CSSStyleSheet å®ä¾‹</span>
      style = <span class="hljs-keyword">new</span> CSSStyleSheet()
      style.replaceSync(content)
      document.adoptedStyleSheets = [...document.adoptedStyleSheets, style]
    } <span class="hljs-keyword">else</span> {
      style.replaceSync(content)
    }
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-keyword">if</span> (style &amp;&amp; !(style <span class="hljs-keyword">instanceof</span> HTMLStyleElement)) {
      removeStyle(id)
      style = undefined
    }
    <span class="hljs-keyword">if</span> (!style) {
      <span class="hljs-comment">// ç”Ÿæˆæ–°çš„ style æ ‡ç­¾å¹¶æ’å…¥åˆ° document æŒ¡ä½</span>
      style = document.createElement(<span class="hljs-string">'style'</span>)
      style.setAttribute(<span class="hljs-string">'type'</span>, <span class="hljs-string">'text/css'</span>)
      style.innerHTML = content
      document.head.appendChild(style)
    } <span class="hljs-keyword">else</span> {
      style.innerHTML = content
    }
  }
  sheetsMap.set(id, style)
}
</code></pre>
<p data-nodeid="39525">æœ€ç»ˆå®Œæˆåœ¨æµè§ˆå™¨ä¸­æ’å…¥æ ·å¼ã€‚</p>
<p data-nodeid="39526">è‡³æ­¤ï¼Œæˆ‘ä»¬è§£æå¹¶åˆ—ä¸¾äº†è¾ƒå¤šæºç å†…å®¹ã€‚ä»¥ä¸Šå†…å®¹éœ€è¦ä½ è·Ÿç€æ€è·¯ï¼Œä¸€æ­¥æ­¥æ¢³ç†ï¼Œæˆ‘ä¹Ÿå¼ºçƒˆå»ºè®®ä½ æ‰“å¼€ Vite æºç è‡ªå·±åŠ¨æ‰‹å‰–æã€‚å¦‚æœçœ‹åˆ°è¿™é‡Œä½ ä»ç„¶ä¹Ÿæœ‰äº›â€œäº‘é‡Œé›¾é‡Œâ€ï¼Œä¸è¦å¿ƒæ€¥ï¼Œç»“åˆæˆ‘ä¸‹é¢è¿™ä¸ªå›¾ç¤ºï¼Œå†æ¬¡è¿›è¡Œé˜…è¯»ï¼Œç›¸ä¿¡ä¼šæ›´æœ‰æ”¶è·ã€‚</p>
<p data-nodeid="39527">Vite è¿™ç§ bundleless æ–¹æ¡ˆçš„è¿è¡ŒåŸç†å›¾ï¼š</p>
<p data-nodeid="39528"><img src="https://s0.lgstatic.com/i/image2/M01/03/FB/Cip5yF_ltUqAV2zLAADo9NOnOvk745.png" alt="Lark20201225-174527.png" data-nodeid="39752"></p>
<p data-nodeid="39529"><img src="https://s0.lgstatic.com/i/image/M00/8C/18/Ciqc1F_ltVCAEgT6AAERxP80SRw964.png" alt="Lark20201225-174517.png" data-nodeid="39755"></p>
<p data-nodeid="39530">æ¥ä¸‹æ¥æˆ‘ä»¬å†åšä¸€äº›æ›´ç»†èŠ‚çš„æ€»ç»“ã€‚</p>
<ul data-nodeid="39531">
<li data-nodeid="39532">
<p data-nodeid="39533">Vite åˆ©ç”¨æµè§ˆå™¨åŸç”Ÿæ”¯æŒ ESM è¿™ä¸€ç‰¹æ€§ï¼Œçœç•¥äº†å¯¹æ¨¡å—çš„æ‰“åŒ…ï¼Œä¹Ÿå°±ä¸éœ€è¦ç”Ÿæˆ bundleï¼Œå› æ­¤åˆæ¬¡å¯åŠ¨æ›´å¿«ï¼ŒHMR ç‰¹æ€§å‹å¥½ã€‚</p>
</li>
<li data-nodeid="39534">
<p data-nodeid="39535">Vite å¼€å‘æ¨¡å¼ä¸‹ï¼Œé€šè¿‡å¯åŠ¨ koa æœåŠ¡å™¨ï¼Œåœ¨æœåŠ¡ç«¯å®Œæˆæ¨¡å—çš„æ”¹å†™ï¼ˆæ¯”å¦‚å•æ–‡ä»¶çš„è§£æç¼–è¯‘ç­‰ï¼‰å’Œè¯·æ±‚å¤„ç†ï¼Œå®ç°çœŸæ­£çš„æŒ‰éœ€ç¼–è¯‘ã€‚</p>
</li>
<li data-nodeid="39536">
<p data-nodeid="39537">Vite Server æ‰€æœ‰é€»è¾‘åŸºæœ¬éƒ½ä¾èµ–ä¸­é—´ä»¶å®ç°ã€‚è¿™äº›ä¸­é—´ä»¶ï¼Œæ‹¦æˆªè¯·æ±‚ä¹‹åï¼Œå®Œæˆäº†å¦‚ä¸‹å†…å®¹ï¼š</p>
<ul data-nodeid="39538">
<li data-nodeid="39539">
<p data-nodeid="39540">å¤„ç† ESM è¯­æ³•ï¼Œæ¯”å¦‚å°†ä¸šåŠ¡ä»£ç ä¸­çš„ import ç¬¬ä¸‰æ–¹ä¾èµ–è·¯å¾„è½¬ä¸ºæµè§ˆå™¨å¯è¯†åˆ«çš„ä¾èµ–è·¯å¾„ï¼›</p>
</li>
<li data-nodeid="39541">
<p data-nodeid="39542">å¯¹ .tsã€.vue ç­‰æ–‡ä»¶è¿›è¡Œå³æ—¶ç¼–è¯‘ï¼›</p>
</li>
<li data-nodeid="39543">
<p data-nodeid="39544">å¯¹ Sass/Less çš„éœ€è¦é¢„ç¼–è¯‘çš„æ¨¡å—è¿›è¡Œç¼–è¯‘ï¼›</p>
</li>
<li data-nodeid="39545">
<p data-nodeid="39546">å’Œæµè§ˆå™¨ç«¯å»ºç«‹ socket è¿æ¥ï¼Œå®ç° HMRã€‚</p>
</li>
</ul>
</li>
</ul>
<h4 data-nodeid="39547">Vite HMR å®ç°åŸç†</h4>
<p data-nodeid="39548">Vite çš„æ‰“åŒ…å‘½ä»¤ä½¿ç”¨äº† Rollup è¿›è¡Œï¼Œè¿™é‡Œå¹¶æ²¡æœ‰ä»€ä¹ˆç‰¹åˆ«ä¹‹å¤„ï¼Œæˆ‘ä»¬ä¸å†å±•å¼€è®²è§£ã€‚è€Œ Vite çš„ HMR ç‰¹æ€§ï¼Œä¸»è¦æ˜¯å›´ç»•ç€ï¼š</p>
<ul data-nodeid="39549">
<li data-nodeid="39550">
<p data-nodeid="39551">é€šè¿‡ watcher ç›‘å¬æ–‡ä»¶æ”¹åŠ¨</p>
</li>
<li data-nodeid="39552">
<p data-nodeid="39553">é€šè¿‡ server ç«¯ç¼–è¯‘èµ„æºï¼Œå¹¶æ¨é€æ–°æ¨¡å—å†…å®¹ç»™æµè§ˆå™¨</p>
</li>
<li data-nodeid="39554">
<p data-nodeid="39555">æµè§ˆå™¨æ”¶åˆ°æ–°çš„æ¨¡å—å†…å®¹ï¼Œæ‰§è¡Œæ¡†æ¶å±‚é¢çš„ rerender/reload</p>
</li>
</ul>
<p data-nodeid="39556">ä¸‰æ­¥è¿›è¡Œã€‚</p>
<p data-nodeid="39557">å½“æµè§ˆå™¨è¯·æ±‚ HTML é¡µé¢æ—¶ï¼ŒæœåŠ¡ç«¯é€šè¿‡ <a href="https://github.com/vitejs/vite/blob/master/src/node/server/serverPluginHtml.ts" data-nodeid="39773">serverPluginHtml</a> æ’ä»¶å‘ HTML å†…å®¹æ³¨å…¥ä¸€æ®µè„šæœ¬ã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œ index.html ä¸­å°±æœ‰ä¸€æ®µå¼•å…¥ /vite/client ä»£ç ï¼Œè¿›è¡Œ WebSocket çš„æ³¨å†Œå’Œç›‘å¬ã€‚</p>
<p data-nodeid="39558"><img src="https://s0.lgstatic.com/i/image/M00/8B/C7/Ciqc1F_gZk-AeTAnAAK2AAgChPQ413.png" alt="Drawing 6.png" data-nodeid="39777"></p>
<p data-nodeid="39559"><img src="https://s0.lgstatic.com/i/image/M00/8B/D2/CgqCHl_gZlWAHmvqAAgRairyZ98357.png" alt="Drawing 7.png" data-nodeid="39780"></p>
<p data-nodeid="39560">å¯¹äº /vite/client è¯·æ±‚çš„å¤„ç†ï¼ŒæœåŠ¡ç«¯ç”± <a href="https://github.com/vitejs/vite/blob/a47429dabea12e8aa5f4a21209846aaf857d5be0/src/node/server/serverPluginClient.ts" data-nodeid="39784">serverPluginClient</a> æ’ä»¶è¿›è¡Œå¤„ç†ï¼š</p>
<pre class="lang-java" data-nodeid="39561"><code data-language="java">export <span class="hljs-keyword">const</span> clientPlugin: ServerPlugin = ({ app, config }) =&gt; {
  <span class="hljs-keyword">const</span> clientCode = fs
    .readFileSync(clientFilePath, <span class="hljs-string">'utf-8'</span>)
    .replace(`__MODE__`, JSON.stringify(config.mode || <span class="hljs-string">'development'</span>))
    .replace(
      `__DEFINES__`,
      JSON.stringify({
        ...defaultDefines,
        ...config.define
      })
    )
  <span class="hljs-comment">// ç›¸åº”ä¸­é—´ä»¶å¤„ç†</span>
  app.use(async (ctx, next) =&gt; {
    <span class="hljs-keyword">if</span> (ctx.path === clientPublicPath) {
      ctx.type = <span class="hljs-string">'js'</span>
      ctx.status = <span class="hljs-number">200</span>
      <span class="hljs-comment">// è¿”å›å…·ä½“å†…å®¹</span>
      ctx.body = clientCode.replace(`__PORT__`, ctx.port.toString())
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-comment">// å…¼å®¹å†å²é€»è¾‘ï¼Œå¹¶è¿›è¡Œé”™è¯¯æç¤º</span>
      <span class="hljs-keyword">if</span> (ctx.path === legacyPublicPath) {
        console.error(
          chalk.red(
            `[vite] client <span class="hljs-keyword">import</span> path has changed from <span class="hljs-string">"/vite/hmr"</span> to <span class="hljs-string">"/vite/client"</span>. ` +
              `please update your code accordingly.`
          )
        )
      }
      <span class="hljs-keyword">return</span> next()
    }
  })
}
</code></pre>
<p data-nodeid="39562">è¿”å›çš„ /vite/src/client/client.js ä»£ç åœ¨æµè§ˆå™¨ç«¯ä¸»è¦é€šè¿‡ WebSocket ç›‘å¬äº†ä¸€äº›æ›´æ–°çš„ç±»å‹ï¼ˆvue ç»„ä»¶æ›´æ–°/vue template æ›´æ–°/vue style æ›´æ–°/css æ›´æ–°/css ç§»é™¤/js æ›´æ–°/é¡µé¢ roloadï¼‰ï¼Œåˆ†åˆ«è¿›è¡Œå¤„ç†ã€‚</p>
<p data-nodeid="39563">åœ¨æœåŠ¡ç«¯ï¼Œé€šè¿‡ <a href="https://www.npmjs.com/package/chokidar" data-nodeid="39790">chokidar</a> åˆ›å»ºäº†ä¸€ä¸ªç›‘å¬æ–‡ä»¶æ”¹åŠ¨çš„ watcher æ¥ç›‘å¬æ–‡ä»¶æ”¹åŠ¨ï¼š</p>
<pre class="lang-java" data-nodeid="39564"><code data-language="java"><span class="hljs-keyword">const</span> watcher = chokidar.watch(root, {
	ignored: [/node_modules/, /\.git/],
	<span class="hljs-comment">// #610</span>
	awaitWriteFinish: {
	  stabilityThreshold: <span class="hljs-number">100</span>,
	  pollInterval: <span class="hljs-number">10</span>
	}
}) as HMRWatcher
</code></pre>
<p data-nodeid="39565">å¹¶é€šè¿‡ <a href="https://github.com/vitejs/vite/blob/master/src/node/server/serverPluginHmr.ts" data-nodeid="39795">serverPluginHmr</a> å‘å¸ƒå˜åŠ¨ï¼Œé€šçŸ¥æµè§ˆå™¨ã€‚</p>
<p data-nodeid="39566">æ›´å¤šæºç ä¸å†ä¸€ä¸€è´´å‡ºã€‚è¿™é‡Œæˆ‘æ€»ç»“äº†ä¸€å¼ æµç¨‹å›¾ä¾›ä½ å‚è€ƒï¼š</p>
<p data-nodeid="39809" class=""><img src="https://s0.lgstatic.com/i/image2/M01/03/FD/CgpVE1_ltm6AN8nCAAMSQ8AjILg631.png" alt="Lark20201225-175233.png" data-nodeid="39813"></p>
<div data-nodeid="39810"><p style="text-align:center">Vite å®ç° HMR æµç¨‹å›¾</p></div>


<h3 data-nodeid="39569">æ€»ç»“</h3>
<p data-nodeid="39570">è¿™ä¸€è®²æˆ‘ä»¬èšç„¦ Vite å®ç°ï¼Œåˆ†æäº†å¦‚ä½•åˆ©ç”¨ ESMï¼Œæ„å»ºä¸€ä¸ª bundleless é£æ ¼çš„ç°ä»£åŒ–å¼€å‘å·¥ç¨‹æ–¹æ¡ˆã€‚æºç å†…å®¹è¾ƒå¤šï¼Œä¹Ÿæ¶‰åŠä¸€å®šå·¥ç¨‹åŒ–æ¶æ„è®¾è®¡å†…å®¹ï¼Œä½† Vite å®ç°æµç¨‹æ¸…æ™°ï¼Œæ˜“è¯»æ€§é«˜ï¼Œæ˜¯æºç é˜…è¯»ç±»å¾ˆå¥½çš„èµ„æºã€‚</p>
<p data-nodeid="39571">äº‹å®ä¸Šï¼ŒVite ä¾èµ–ä¼˜åŒ–çš„çµæ„Ÿæ¥è‡ª <a href="https://www.snowpack.dev/" data-nodeid="39806">Snowpack</a>ï¼Œè¿™ç±» bundleless å·¥å…·ä¹Ÿä»£è¡¨ç€ä¸€ç§æ–°è¶‹åŠ¿ã€æ–°æ–¹å‘ã€‚æˆ‘è®¤ä¸ºï¼ŒæŠ€æœ¯åŠŸåº•æ˜¯å¾ˆé‡è¦çš„ä¸€æ–¹é¢ï¼Œè€ŒæŠ€æœ¯æ•æ„Ÿåº¦çš„åŸ¹å…»ä¹Ÿéå¸¸å…³é”®ã€‚å¸Œæœ›ä¸ä½ å…±å‹‰ï¼</p>
<p data-nodeid="39572" class="">åˆ°æ­¤ï¼Œæ–°ç¼–è¯‘å·¥å…·ç†å¿µâ€”â€”Vite æˆ‘ä»¬å°±ä»‹ç»åˆ°è¿™é‡Œã€‚æ¥ä¸‹æ¥æˆ‘ä»¬å°†è¿›å…¥ä»£ç é™çº§ç¼–è¯‘ç¯èŠ‚çš„å­¦ä¹ ï¼Œæˆ‘ä»¬ä¸‹ä¸€è®²å†è§ã€‚</p>

---

### ç²¾é€‰è¯„è®º

##### **é¾™ï¼š
> è€å¸ˆæˆ‘æƒ³é—®ä¸‹Vite æ˜¯æ€ä¹ˆä¿è¯devç¯å¢ƒå’Œç”Ÿäº§ç¯å¢ƒï¼Œæœ€åå¾—åˆ°çš„ç»“æœæ˜¯ä¸€æ ·çš„å•Šï¼Œä¼šä¸ä¼šå‡ºç°devçœ‹åˆ°çš„æ˜¯ä¸€ç§ç°è±¡ï¼Œç”Ÿäº§ç¯å¢ƒçœ‹åˆ°çš„æ˜¯å¦ä¸€ç§ç°è±¡è¿˜æœ‰å¦‚æœæˆ‘åŒæ—¶import ä¸¤ä¸ªjsæ–‡ä»¶ï¼Œè¿™ä¸¤ä¸ªæ–‡ä»¶çš„åŠ è½½æ‰§è¡Œé¡ºåºä¼šæœ‰å…ˆåå—ï¼Ÿæ˜¯å¿…é¡»å‰ä¸€ä¸ªåŠ è½½å®Œæˆåï¼Œæ‰ä¼šå»importå¦å¤–ä¸€ä¸ªå—ï¼Ÿ

 ###### &nbsp;&nbsp;&nbsp; è®²å¸ˆå›å¤ï¼š
> &nbsp;&nbsp;&nbsp; ä¸æ˜¯çš„ï¼Œè¯·æ±‚ä¸ä¸€å®šæ˜¯ä¸²è¡Œå…³ç³»ï¼Œè¿™ä¸ªå¯ä»¥è‡ªå·±åŠ¨æ‰‹è¯•éªŒä¸€ä¸‹

##### **é¾™ï¼š
> è€å¸ˆæˆ‘æœ‰å‡ ä¸ªç–‘æƒ‘ç‚¹1 Vite æ˜¯æ€ä¹ˆä¿è¯æœ¬åœ°ç¯å¢ƒè¿è¡Œå‡ºçš„ç»“æœå’Œæœ€åç”Ÿäº§ç¯å¢ƒæ˜¯ä¸€è‡´çš„å•Š2 æˆ‘åœ¨ä¸€ä¸ªjsæ–‡ä»¶ä¸­ï¼ŒåŒæ—¶æœ‰ä¸¤ä¸ªimportï¼Œè¿™ä¸ªjså°±ä¼šå¯¼è‡´å‘é€ä¸¤ä¸ªè¯·æ±‚ï¼Œæ˜¯ä¸æ˜¯åªæœ‰ç­‰ä¸€ä¸ªè¯·æ±‚å‘é€æ¥æ”¶åˆ°è¿”å›ä»¥åï¼Œæ‰å›å»å‘é€ä¸‹ä¸€ä¸ªè¯·æ±‚ï¼Œæ˜¯ä¸€ç§åŒæ­¥çš„è¡Œä¸º

 ###### &nbsp;&nbsp;&nbsp; è®²å¸ˆå›å¤ï¼š
> &nbsp;&nbsp;&nbsp; ä¸æ˜¯çš„ï¼Œè¯·æ±‚ä¸ä¸€å®šæ˜¯ä¸²è¡Œå…³ç³»ï¼Œè¿™ä¸ªå¯ä»¥è‡ªå·±åŠ¨æ‰‹è¯•éªŒä¸€ä¸‹

##### **å‹‡ï¼š
> vite@2.xä¸ä½¿ç”¨koaæ¥åˆ›å»ºæœåŠ¡å’Œç®¡ç†ä¸­é—´ä»¶äº†ï¼Œè€Œæ˜¯ä½¿ç”¨connectã€‚æ˜¯å¤„äºä»€ä¹ˆè€ƒè™‘å‘¢ï¼ŸTJä¸ç»´æŠ¤Koaäº†å“‡

 ###### &nbsp;&nbsp;&nbsp; è®²å¸ˆå›å¤ï¼š
> &nbsp;&nbsp;&nbsp; è¿™æ˜¯ç›®å‰çœ‹åˆ°æœ€å¥½çš„é—®é¢˜ä¹‹ä¸€ï¼Œä¸è¿‡æé—®è€…åº”è¯¥æ›´è¿›ä¸€æ­¥ï¼Œæå‡è‡ªå·±è§£å†³é—®é¢˜ï¼Œæ‰¾åˆ°ç­”æ¡ˆçš„èƒ½åŠ›ã€‚å…·ä½“åŸå› åœ¨ https://github.com/vitejs/vite/blob/91dbb017091c175a54bcd1c93a69f8458d1bde8d/docs/guide/migration.md#for-plugin-authors ä¸­æœ‰æ‰€ä½“ç°äº†å…¶å®ï¼Œç®€å•æ€»ç»“ä¸€ä¸‹æ˜¯ vite@2.x ä¸»è¦æ˜¯ç”¨åŸºäº hooks çš„æ’ä»¶ï¼Œå¯¹äº koa ä¸­é—´ä»¶çš„éœ€æ±‚å¤§å¹…åº¦å‡å°‘ï¼Œä»ä¾èµ–æˆæœ¬ä¸Šçœ‹ï¼Œold school çš„ connect å³å¯æ–¹ä¾¿è½»å·§æ»¡è¶³éœ€æ±‚äº†

##### *é”‹ï¼š
> ä»€ä¹ˆæ—¶å€™æ›´æ–°å‘€

 ###### &nbsp;&nbsp;&nbsp; ç¼–è¾‘å›å¤ï¼š
> &nbsp;&nbsp;&nbsp; æ¯å‘¨ä¸€ã€ä¸‰æ›´æ–°å“ˆ~

##### **8621ï¼š
> ç¬¬ä¸€ä¸ªæå‡ºbundlelessç†å¿µçš„äººï¼Œç»å¯¹æ˜¯ååˆ†å–„äºæ€è€ƒçš„äººã€‚

##### **å‹‡ï¼š
> SnowPackå’ŒViteçš„åŒºåˆ«ä¸»è¦æ˜¯å¯¹æ‰“åŒ…çš„å¤„ç†å—ï¼ŸViteæ˜¯ä½¿ç”¨Rollupæ¥buildï¼ŒViteè¿˜æ˜¯ä½¿ç”¨Webpackæ¥å®Œæˆbuildã€‚åç»­ä¼šå¯¹è¿™ä¸¤è€…çš„åŒºåˆ«å±•å¼€è®²è§£å—ï¼Ÿ

 ###### &nbsp;&nbsp;&nbsp; è®²å¸ˆå›å¤ï¼š
> &nbsp;&nbsp;&nbsp; å¯¹äº SnowPackå’ŒViteçš„å‘å±•è·¯çº¿å…¶å®æ˜¯æ¯”è¾ƒæœ‰è¶£çš„è¯é¢˜ï¼Œä¹Ÿä¼šéšç€æ—¶é—´æ¼”è¿›æœ‰æ‰€å˜åŒ–ã€‚å¯ä»¥ä¸æˆ‘ä¿æŒè”ç³»ï¼Œéšæ—¶æ²Ÿé€š

##### **0231ï¼š
> å¤§ä½¬å¤ªå¼ºäº†ï¼Œå¤§ä½¬æ˜¯å‚è€ƒäº†ç›¸å…³æ–‡ç« è¿›è¡Œçš„å­¦ä¹ ï¼Œè¿˜æ˜¯ç›´æ¥æ¢³ç†æºç è¿›è¡Œçš„åˆ†æ

 ###### &nbsp;&nbsp;&nbsp; è®²å¸ˆå›å¤ï¼š
> &nbsp;&nbsp;&nbsp; çŸ¥è¯†è·å–æ–¹å¼ï¼šçœ‹æºç ï¼Œçœ‹å®˜ç½‘ï¼Œå» github æ issue/prï¼Œå¤šå‚ä¸å›½é™…ç¤¾åŒºè®¨è®ºï¼Œå›½å†…æ¯•ç«Ÿé¢æ¯”è¾ƒæœ‰é™

##### **è´¤ï¼š
> å­¦åˆ°äº†, éƒ½æ²¡å¬è¯´è¿‡ Vite, æˆ‘æ˜¯ä¸æ˜¯å¤ªèœäº†ğŸ˜‚

 ###### &nbsp;&nbsp;&nbsp; ç¼–è¾‘å›å¤ï¼š
> &nbsp;&nbsp;&nbsp; ä¸æ˜¯å“¦ï¼Œå­¦ä¹ æ˜¯ä¸ªæŒä¹…çš„è¿‡ç¨‹ï¼Œæ¯ä¸ªçŸ¥è¯†éƒ½æ˜¯ä»æ— åˆ°æœ‰ã€‚ç°åœ¨æŒæ¡ä¹Ÿä¸æ™šå‘~

##### cxlï¼š
> è¯·é—®ä¸‹è€å¸ˆï¼Œreactæœ‰bundlesså—

 ###### &nbsp;&nbsp;&nbsp; è®²å¸ˆå›å¤ï¼š
> &nbsp;&nbsp;&nbsp; æœ‰çš„ï¼Œvite å¯ä»¥æ”¹é€ æ”¯æŒï¼Œå¦å¤–å»ºè®®æ‰¾ä¸€ä¸‹ snowpack çš„ react æ–¹æ¡ˆ

