(window.webpackJsonp=window.webpackJsonp||[]).push([[287],{626:function(n,e,a){"use strict";a.r(e);var t=a(4),i=Object(t.a)({},(function(){var n=this,e=n._self._c;return e("ContentSlotsDistributor",{attrs:{"slot-key":n.$parent.slotKey}},[e("p",[n._v("近期公司需要针对分享流程进行优化，其中一点就是前端 H5 检测是否安装应用，来进行不同的判断（下载或直接跳转到 app 中）。原理很简单：创建一个 iframe 去打开 uri。如果打开 app 成功网页进入后台，再切换回来时间会超过 2.5s。利用时间去检测。下面来看具体实现过程：")]),n._v(" "),e("h2",{attrs:{id:"你可能会遇到的问题"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#你可能会遇到的问题"}},[n._v("#")]),n._v(" 你可能会遇到的问题")]),n._v(" "),e("ul",[e("li",[n._v("什么是 uri，获取 uri 需要哪些帮助？")]),n._v(" "),e("li",[n._v("安卓中应用切换到后台， 计时器仍会不断运行有什么解决方法？")]),n._v(" "),e("li",[n._v("微信中不支持第三方 uri,下载应用。怎么解决来完成跳转到自身 app。")])]),n._v(" "),e("h2",{attrs:{id:"uri-获取"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#uri-获取"}},[n._v("#")]),n._v(" uri 获取")]),n._v(" "),e("p",[n._v("这里的 uri,指得就是通过 Url scheme 来实现的 H5 与安卓、苹果应用之间的跳转链接。")]),n._v(" "),e("p",[n._v("我们需要找到客户端的同事，来获取如下格式的链接。")]),n._v(" "),e("div",{staticClass:"language- extra-class"},[e("pre",[e("code",[n._v("xx://'跳转页面'/'携带参数'\n")])])]),e("p",[n._v("url 就是我们平常理解的链接。\nscheme 是指 url 链接中的最初位置，就是上边链接中 ‘xx’的位置。\n详细介绍可以看这里："),e("a",{attrs:{href:"https://sspai.com/post/31500",target:"_blank",rel:"noopener noreferrer"}},[n._v("https://sspai.com/post/31500"),e("OutboundLink")],1)]),n._v(" "),e("p",[n._v("用这个链接我们可以跳转到 应用中的某个页面,并可以携带一定的参数。这个是我们实现这个功能的前提哟。")]),n._v(" "),e("h2",{attrs:{id:"具体实现"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#具体实现"}},[n._v("#")]),n._v(" 具体实现")]),n._v(" "),e("h3",{attrs:{id:"第一步-通过-iframe-打开-app"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#第一步-通过-iframe-打开-app"}},[n._v("#")]),n._v(" 第一步：通过 iframe 打开 App")]),n._v(" "),e("div",{staticClass:"language- extra-class"},[e("pre",[e("code",[n._v("Android平台则各个app厂商差异很大，比如Chrome从25及以后就不再支持通过js触发（非用户点击），所以这里使用iframe src地址等来触发scheme。\n\n//在iframe 中打开APP\nvar ifr = document.createElement('iframe');\nifr.src = openUrl;\nifr.style.display = 'none';\n")])])]),e("h3",{attrs:{id:"第二步-判断是否安装某应用"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#第二步-判断是否安装某应用"}},[n._v("#")]),n._v(" 第二步：判断是否安装某应用")]),n._v(" "),e("div",{staticClass:"language- extra-class"},[e("pre",[e("code",[n._v("原理：若通过url scheme 打开app成功，那么当前h5会进入后台，通过计时器会有明显延迟。利用时间来判断。\n\n//检查app是否打开\nfunction checkOpen(cb){\n    var _clickTime = +(new Date());\n    function check(elsTime) {\n        if ( elsTime > 3000 || document.hidden || document.webkitHidden) {\n            cb(1);\n        } else {\n            cb(0);\n        }\n    }\n    //启动间隔20ms运行的定时器，并检测累计消耗时间是否超过3000ms，超过则结束\n    var _count = 0, intHandle;\n    intHandle = setInterval(function(){\n        _count++;\n        var elsTime = +(new Date()) - _clickTime;\n        if (_count>=100 || elsTime > 3000 ) {\n            clearInterval(intHandle);\n            check(elsTime);\n        }\n    }, 20);\n}\n")])])]),e("p",[n._v("注意：\n_由于安卓手机,页面进入后台，定时器 setTimeout 仍会不断运行，所以这里使用 setInterval,较小间隔时间重复多次。来根据累计时间判断\n_ cb 为回调函数，根据返回 0 or 1 来判断是否安装。 * document.hidden 对大于 4.4webview 支持很好，为页面可见性 api。")]),n._v(" "),e("h3",{attrs:{id:"第三步-微信中实现打开-or-下载应用效果"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#第三步-微信中实现打开-or-下载应用效果"}},[n._v("#")]),n._v(" 第三步：微信中实现打开 or 下载应用效果")]),n._v(" "),e("div",{staticClass:"language- extra-class"},[e("pre",[e("code",[n._v("这里使用的是应用宝微链接实现。\n\nif (callback) {\n  //客户端检测微信直接跳应用宝链接\n  var browser = BrowserInfo();\n  //使用微链接\n  var encodeUri = encodeURIComponent('你的uri');\n\n  if (browser.isWeixin) {\n    window.location.href = '你的微链url&android_schema='+encodeUri;\n\n  }else{\n    checkOpen(function(opened){\n        callback && callback(opened);\n    });\n\n  }\n}\n")])])]),e("p",[n._v("注意点：\n_微链接是应用宝提供的，可以在后台获取。\n_ 使用微链接必须做 encodeURIComponent 转义。 * 链接地址在微链接后拼接一个 android_schema 参数加你的 uri。")]),n._v(" "),e("p",[n._v("完整函数：")]),n._v(" "),e("div",{staticClass:"language- extra-class"},[e("pre",[e("code",[n._v("export const openApp = function(openUrl, callback) {\n    //检查app是否打开\n    function checkOpen(cb){\n        var _clickTime = +(new Date());\n        function check(elsTime) {\n            if ( elsTime > 3000 || document.hidden || document.webkitHidden) {\n                cb(1);\n            } else {\n                cb(0);\n            }\n        }\n        //启动间隔20ms运行的定时器，并检测累计消耗时间是否超过3000ms，超过则结束\n        var _count = 0, intHandle;\n        intHandle = setInterval(function(){\n            _count++;\n            var elsTime = +(new Date()) - _clickTime;\n            if (_count>=100 || elsTime > 3000 ) {\n                clearInterval(intHandle);\n                check(elsTime);\n            }\n        }, 20);\n    }\n\n    //在iframe 中打开APP\n    var ifr = document.createElement('iframe');\n    ifr.src = openUrl;\n    ifr.style.display = 'none';\n\n    if (callback) {\n      //客户端检测微信直接跳应用宝链接\n      var browser = BrowserInfo();\n      //使用微链接\n      var encodeUri = encodeURIComponent(openUrl);\n\n      if (browser.isWeixin) {\n        window.location.href = '你的微链url&android_schema='+encodeUri;\n      }else{\n        checkOpen(function(opened){\n            callback && callback(opened);\n        });\n\n      }\n    }\n\n    document.body.appendChild(ifr);\n    setTimeout(function() {\n        document.body.removeChild(ifr);\n    }, 2000);\n\n}\n")])])]),e("p",[n._v("其他：\n函数中调用的 BrowserInfo 是一个简单的客户端检测。具体如下：")]),n._v(" "),e("div",{staticClass:"language- extra-class"},[e("pre",[e("code",[n._v("/**\n * 客户端检测\n */\nexport const BrowserInfo = function() {\n  var json = {\n    userAgent: navigator.userAgent.toLowerCase(),\n    isAndroid: Boolean(navigator.userAgent.match(/android/ig)),\n    isIphone: Boolean(navigator.userAgent.match(/iphone|ipod/ig)),\n    isIpad: Boolean(navigator.userAgent.match(/ipad/ig)),\n    isWeixin: Boolean(navigator.userAgent.match(/MicroMessenger/ig)),\n  }\n\n  return json;\n}\n")])])]),e("p",[n._v("回调函数的使用：")]),n._v(" "),e("div",{staticClass:"language- extra-class"},[e("pre",[e("code",[n._v('页面中可以通过传递回调函数，来获取返回值；并通过是否传这个参数来做进入页面检测。\n\n\n\n\n\n\n\n\n\n<!DOCTYPE html>\n<html>\n<head>\n    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">\n    <meta name="viewport" content="initial-scale=1.0,user-scalable=no">\n    <title>Js判定移动端是否安装app,若已安装，则打开，未安装则跳转到下载页面</title>\n    <meta name=\'apple-itunes-app\' content=\'app-id=1221201728\'>\n</head>\n<body>\n    <a href="javascript:;" id="openApp">点击打开安装app</a>\n</body>\n</html>\n<script type="text/javascript">\n    document.getElementById(\'openApp\').onclick = function(e){\n\n        if(navigator.userAgent.match(/(iPhone|iPod|iPad);?/i))\n           {\n            window.location.href = "com.baidu.tieba://";//ios app协议(如：com.baidu.tieba://)\n            window.setTimeout(function() {\n                window.location.href = "https://itunes.apple.com/cn/app/id477927812"; //跳转到App store\n            }, 2000)\n           }\n        if(navigator.userAgent.match(/android/i))\n        {\n            window.location.href = "com.baidu.tieba://app";//android app协议(如：com.baidu.tieba://app)\n            window.setTimeout(function() {\n                window.location.href = "https://****.apk";//android 下载地址\n            }, 2000)\n        }\n    };\n<\/script>\n')])])])])}),[],!1,null,null,null);e.default=i.exports}}]);