(window.webpackJsonp=window.webpackJsonp||[]).push([[170],{508:function(t,a,s){"use strict";s.r(a);var n=s(4),e=Object(n.a)({},(function(){var t=this,a=t._self._c;return a("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[a("p",{attrs:{"data-nodeid":"6450"}},[t._v("从这一讲开始，我们将进入核心框架原理与代码设计模式的学习。任何一个动态应用的实现，都离不开前后端的互动配合。前端发送请求获取数据是开发者必不可少的场景。正因为如此，每一个前端项目都有必要接入一个请求库。")]),t._v(" "),a("p",{attrs:{"data-nodeid":"6451"}},[t._v("那么请求库如何设计，才能保证使用者的顺畅？请求逻辑如何抽象成统一请求库，才能避免出现代码混乱堆积，难以维护的现象呢？下面我们就进入正题。")]),t._v(" "),a("h3",{attrs:{"data-nodeid":"6452"}},[t._v("一个请求库需要考虑哪些问题")]),t._v(" "),a("p",{attrs:{"data-nodeid":"6453"}},[t._v("一个请求，纵向向前承载了数据的发送，向后链接了数据的接收和消费，横向还需要处理网络环境和宿主能力，以及业务的扩展需求。因此设计一个好的请求库，首先需要预见可能会发生的问题。下面我们将重点展开几个关键问题。")]),t._v(" "),a("h4",{attrs:{"data-nodeid":"6454"}},[t._v("适配浏览器 or Node.js 环境")]),t._v(" "),a("p",{attrs:{"data-nodeid":"6455"}},[t._v("如今，前端开发不再局限于浏览器层面，Node.js 环境的出现，使得请求库的适配需求变得更加复杂。"),a("strong",{attrs:{"data-nodeid":"6596"}},[t._v("Node.js 基于 V8 JavaScript Engine，顶层对象是 global，不存在 Window 对象和浏览器宿主")]),t._v("，因此使用传统的 XMLHttpRequest/Fetch 在 Node.js 上发送请求是行不通的。对于搭建了 Node.js 环境的前端来说，请求库的设计实现需要考虑是否同时支持在浏览器和 Node.js 两种环境发送请求。在同构的背景下，如何使不同环境的请求库使用体验趋于一致呢？下面我们将会对这部分内容进一步讲解。")]),t._v(" "),a("h4",{attrs:{"data-nodeid":"6456"}},[t._v("XHR or Fetch")]),t._v(" "),a("p",{attrs:{"data-nodeid":"6457"}},[t._v("单就浏览器环境发送请求来说，一般存在两种技术方法：")]),t._v(" "),a("ul",{attrs:{"data-nodeid":"6458"}},[a("li",{attrs:{"data-nodeid":"6459"}},[a("p",{attrs:{"data-nodeid":"6460"}},[a("a",{attrs:{href:"https://xhr.spec.whatwg.org/","data-nodeid":"6601"}},[t._v("XMLHttpRequest 规范")])])]),t._v(" "),a("li",{attrs:{"data-nodeid":"6461"}},[a("p",{attrs:{"data-nodeid":"6462"}},[a("a",{attrs:{href:"https://fetch.spec.whatwg.org/","data-nodeid":"6604"}},[t._v("Fetch 规范")])])])]),t._v(" "),a("p",{attrs:{"data-nodeid":"6463"}},[t._v("我们先简要对比两种技术的使用方式。")]),t._v(" "),a("p",{attrs:{"data-nodeid":"6464"}},[t._v("使用 XMLHttpRequest 发送请求：")]),t._v(" "),a("pre",{staticClass:"lang-java",attrs:{"data-nodeid":"6465"}},[a("code",{attrs:{"data-language":"java"}},[a("span",{staticClass:"hljs-function"},[t._v("function "),a("span",{staticClass:"hljs-title"},[t._v("success")]),a("span",{staticClass:"hljs-params"},[t._v("()")]),t._v(" ")]),t._v("{\n    "),a("span",{staticClass:"hljs-keyword"},[t._v("var")]),t._v(" data = JSON.parse("),a("span",{staticClass:"hljs-keyword"},[t._v("this")]),t._v(".responseText);\n    console.log(data);\n}\n"),a("span",{staticClass:"hljs-function"},[t._v("function "),a("span",{staticClass:"hljs-title"},[t._v("error")]),a("span",{staticClass:"hljs-params"},[t._v("(err)")]),t._v(" ")]),t._v("{\n    console.log("),a("span",{staticClass:"hljs-string"},[t._v("'Error Occurred :'")]),t._v(", err);\n}\n"),a("span",{staticClass:"hljs-keyword"},[t._v("var")]),t._v(" xhr = "),a("span",{staticClass:"hljs-keyword"},[t._v("new")]),t._v(" XMLHttpRequest();\nxhr.onload = success;\nxhr.onerror = error;\nxhr.open("),a("span",{staticClass:"hljs-string"},[t._v("'GET'")]),t._v(", "),a("span",{staticClass:"hljs-string"},[t._v("'https://xxx'")]),t._v(");\nxhr.send();\n")])]),t._v(" "),a("p",{attrs:{"data-nodeid":"6466"}},[t._v("简单来说，XMLHttpRequest 存在一些缺点，比如：")]),t._v(" "),a("ul",{attrs:{"data-nodeid":"6467"}},[a("li",{attrs:{"data-nodeid":"6468"}},[a("p",{attrs:{"data-nodeid":"6469"}},[t._v("配置和使用方式较为烦琐；")])]),t._v(" "),a("li",{attrs:{"data-nodeid":"6470"}},[a("p",{attrs:{"data-nodeid":"6471"}},[t._v("基于事件的异步模型不够友好。")])])]),t._v(" "),a("p",{attrs:{"data-nodeid":"6472"}},[t._v("而 Fetch 的推出，主要也是为了解决上述问题。")]),t._v(" "),a("p",{attrs:{"data-nodeid":"6473"}},[t._v("使用 Fetch 发送一个请求：")]),t._v(" "),a("pre",{staticClass:"lang-java",attrs:{"data-nodeid":"6474"}},[a("code",{attrs:{"data-language":"java"}},[t._v("fetch("),a("span",{staticClass:"hljs-string"},[t._v("'https://xxx'")]),t._v(")\n    .then(function (response) {\n        console.log(response);\n    })\n    ."),a("span",{staticClass:"hljs-keyword"},[t._v("catch")]),t._v("(function (err) {\n        console.log("),a("span",{staticClass:"hljs-string"},[t._v('"Something went wrong!"')]),t._v(", err);\n    });\n")])]),t._v(" "),a("p",{attrs:{"data-nodeid":"6475"}},[t._v("我们可以看到，Fetch 基于 Promise，"),a("strong",{attrs:{"data-nodeid":"6621"}},[t._v("语法更加简洁，语义化更加突出")]),t._v("，但"),a("strong",{attrs:{"data-nodeid":"6622"}},[t._v("兼容性不如 XMLHttpRequest")]),t._v("。")]),t._v(" "),a("p",{attrs:{"data-nodeid":"6476"}},[t._v("对于一个请求库来说，在浏览器端使用 XMLHttpRequest 还是 Fetch？这是一个问题。下面我们通过 axios 的实现具体展开讲解。")]),t._v(" "),a("h4",{attrs:{"data-nodeid":"6477"}},[t._v("功能设计与抽象粒度")]),t._v(" "),a("p",{attrs:{"data-nodeid":"6478"}},[t._v("无论是基于 XMLHttpRequest 还是 Fetch，实现一层封装，屏蔽一些基础能力并暴露给业务方使用，即实现一个请求库，这并不困难。我认为，真正难的是"),a("strong",{attrs:{"data-nodeid":"6630"}},[t._v("请求库的功能设计和抽象粒度")]),t._v("。如果功能设计分层不够清晰，抽象方式不够灵活，很容易产出“屎山代码”。")]),t._v(" "),a("p",{attrs:{"data-nodeid":"6479"}},[t._v("比如，对于请求库来说，是否要处理以下看似通用，但又具有定制性的功能呢？你需要考虑以下功能点：")]),t._v(" "),a("ul",{attrs:{"data-nodeid":"6480"}},[a("li",{attrs:{"data-nodeid":"6481"}},[a("p",{attrs:{"data-nodeid":"6482"}},[t._v("自定义 headers 添加")])]),t._v(" "),a("li",{attrs:{"data-nodeid":"6483"}},[a("p",{attrs:{"data-nodeid":"6484"}},[t._v("统一断网/弱网处理")])]),t._v(" "),a("li",{attrs:{"data-nodeid":"6485"}},[a("p",{attrs:{"data-nodeid":"6486"}},[t._v("接口缓存处理")])]),t._v(" "),a("li",{attrs:{"data-nodeid":"6487"}},[a("p",{attrs:{"data-nodeid":"6488"}},[t._v("接口统一错误提示")])]),t._v(" "),a("li",{attrs:{"data-nodeid":"6489"}},[a("p",{attrs:{"data-nodeid":"6490"}},[t._v("接口统一数据处理")])]),t._v(" "),a("li",{attrs:{"data-nodeid":"6491"}},[a("p",{attrs:{"data-nodeid":"6492"}},[t._v("统一数据层结合")])]),t._v(" "),a("li",{attrs:{"data-nodeid":"6493"}},[a("p",{attrs:{"data-nodeid":"6494"}},[t._v("统一请求埋点")])])]),t._v(" "),a("p",{attrs:{"data-nodeid":"6495"}},[t._v("这些设计问题如果初期不考虑清楚，那么在业务层面，一旦真正使用了设计不良的请求库，很容易遇到不满足业务需求的场景，而沦为手写 Fetch，势必导致代码库中请求方式多种多样，风格不一。")]),t._v(" "),a("p",{attrs:{"data-nodeid":"6496"}},[t._v("这里我们稍微展开，以一个请求库的分层封装为例，其实任何一种通用能力的封装都可以参考下图：")]),t._v(" "),a("p",{attrs:{"data-nodeid":"6497"}},[a("img",{attrs:{src:"https://s0.lgstatic.com/i/image6/M01/02/45/Cgp9HWAdGnOAEUmTAADzvClHn5k247.png",alt:"202125-101326.png","data-nodeid":"6643"}})]),t._v(" "),a("div",{attrs:{"data-nodeid":"6498"}},[a("p",{staticStyle:{"text-align":"center"}},[t._v("请求库分层封装示例图")])]),t._v(" "),a("p",{attrs:{"data-nodeid":"6499"}},[t._v("如图所示，底层能力部分，对应请求库中宿主提供的 XMLHttpRequest 或 Fetch 能力，以及项目中已经内置的框架/类库能力。这一部分对于一个已有项目来说，往往是较难改变或重构的，也是不同项目中可以复用的；而业务层，比如依赖 axios 请求库的更上层封装，我们一般可以分为：")]),t._v(" "),a("ul",{attrs:{"data-nodeid":"6500"}},[a("li",{attrs:{"data-nodeid":"6501"}},[a("p",{attrs:{"data-nodeid":"6502"}},[t._v("项目层")])]),t._v(" "),a("li",{attrs:{"data-nodeid":"6503"}},[a("p",{attrs:{"data-nodeid":"6504"}},[t._v("页面层")])]),t._v(" "),a("li",{attrs:{"data-nodeid":"6505"}},[a("p",{attrs:{"data-nodeid":"6506"}},[t._v("组件层")])])]),t._v(" "),a("p",{attrs:{"data-nodeid":"6507"}},[t._v("三个方面，它们依次递进，完成最终业务消费。底层能力部分，对许多项目来说都可以使用，而"),a("strong",{attrs:{"data-nodeid":"6653"}},[t._v("让不同项目之间的代码质量和开发效率产生差异")]),t._v("的，恰好是容易被轻视的业务级别的封装设计。")]),t._v(" "),a("p",{attrs:{"data-nodeid":"6508"}},[t._v("比如设计者在项目层的封装上，如果做了几乎所有事情，囊括了所有请求相关的规则，很容易使封装复杂，过度设计。不同层级的功能和职责是不同的，"),a("strong",{attrs:{"data-nodeid":"6659"}},[t._v("错位的使用和设计，是让项目变得更加混乱的诱因之一")]),t._v("。")]),t._v(" "),a("p",{attrs:{"data-nodeid":"6509"}},[t._v("合理的设计是，底层部分保留对全局封装的影响范围，而项目层保留对页面层的影响能力，页面层保留对组件层的影响能力。")]),t._v(" "),a("p",{attrs:{"data-nodeid":"6510"}},[a("img",{attrs:{src:"https://s0.lgstatic.com/i/image6/M00/02/E5/CioPOWAeNr6AYnHYAAVEoQwNcDk580.png",alt:"前端基建 金句.png","data-nodeid":"6663"}})]),t._v(" "),a("p",{attrs:{"data-nodeid":"6511"}},[t._v("比如，我们在项目层提供一个基础请求库封装，在这一层可以提供默认发送 cookie 等（一定需要存在）的行为，同时通过配置 options.fetch 保留覆盖 globalThis.fetch 的能力，这样可以在 Node 等环境中，通过"),a("strong",{attrs:{"data-nodeid":"6669"}},[t._v("注入一个 node-fetch npm 库")]),t._v("的方式，支持 SSR 能力。")]),t._v(" "),a("p",{attrs:{"data-nodeid":"6512"}},[t._v("这里需要注意的是，我们一定要避免设计一个特别大的 Fetch 方法，通过拓展 options 把所有事情都做了，用 options 驱动一切行为，这比较容易让 Fetch 代码和逻辑变得复杂、难以理解，而且不利于 tree-shaking 和 code-spliting。")]),t._v(" "),a("p",{attrs:{"data-nodeid":"6513"}},[t._v("那么如何做到这种层次清晰的基础库呢？接下来，我们就从 axios 的设计分析寻找答案。")]),t._v(" "),a("h3",{attrs:{"data-nodeid":"6514"}},[t._v("axios 设计之美")]),t._v(" "),a("p",{attrs:{"data-nodeid":"6515"}},[t._v("axios 是一个被前端广泛使用的请求库，对应上述分层结构中，属于框架/类库层，我们来总结一下它的功能特点：")]),t._v(" "),a("ul",{attrs:{"data-nodeid":"6516"}},[a("li",{attrs:{"data-nodeid":"6517"}},[a("p",{attrs:{"data-nodeid":"6518"}},[t._v("在浏览器端，使用 XMLHttpRequest 发送请求；")])]),t._v(" "),a("li",{attrs:{"data-nodeid":"6519"}},[a("p",{attrs:{"data-nodeid":"6520"}},[t._v("支持 Node.js 端发送请求；")])]),t._v(" "),a("li",{attrs:{"data-nodeid":"6521"}},[a("p",{attrs:{"data-nodeid":"6522"}},[t._v("支持 Promise API，使用 Promise 风格语法；")])]),t._v(" "),a("li",{attrs:{"data-nodeid":"6523"}},[a("p",{attrs:{"data-nodeid":"6524"}},[t._v("支持请求和响应拦截；")])]),t._v(" "),a("li",{attrs:{"data-nodeid":"6525"}},[a("p",{attrs:{"data-nodeid":"6526"}},[t._v("支持自定义修改请求和返回内容；")])]),t._v(" "),a("li",{attrs:{"data-nodeid":"6527"}},[a("p",{attrs:{"data-nodeid":"6528"}},[t._v("支持请求取消；")])]),t._v(" "),a("li",{attrs:{"data-nodeid":"6529"}},[a("p",{attrs:{"data-nodeid":"6530"}},[t._v("默认支持 XSRF 防御。")])])]),t._v(" "),a("p",{attrs:{"data-nodeid":"6531"}},[t._v("下面，我们主要从拦截器思想、适配器思想、安全思想三方面展开，分析 axios 设计的可取之处。")]),t._v(" "),a("h4",{attrs:{"data-nodeid":"6532"}},[t._v("拦截器思想")]),t._v(" "),a("p",{attrs:{"data-nodeid":"6533"}},[t._v("拦截器思想是 axios 带来的最具启发性的思想之一。它赋予了"),a("strong",{attrs:{"data-nodeid":"6688"}},[t._v("分层开发时借助拦截行为，注入自定义能力的功能")]),t._v("。简单来说，axios 的拦截器主要由：任务注册 → 任务编排 → 任务调度（执行）三步组成。")]),t._v(" "),a("p",{attrs:{"data-nodeid":"6534"}},[t._v("我们先看任务注册，在请求发出前，可以使用"),a("code",{attrs:{"data-backticks":"1","data-nodeid":"6690"}},[t._v("axios.interceptors.request.use")]),t._v("方法注入拦截逻辑，比如：")]),t._v(" "),a("pre",{staticClass:"lang-java",attrs:{"data-nodeid":"6535"}},[a("code",{attrs:{"data-language":"java"}},[t._v("axios.interceptors.request.use(function (config) {\n    "),a("span",{staticClass:"hljs-comment"},[t._v("// 请求发送前做一些事情，比如添加 headers")]),t._v("\n    "),a("span",{staticClass:"hljs-keyword"},[t._v("return")]),t._v(" config;\n  }, function (error) {\n    "),a("span",{staticClass:"hljs-comment"},[t._v("// 请求出现错误时，处理逻辑")]),t._v("\n    "),a("span",{staticClass:"hljs-keyword"},[t._v("return")]),t._v(" Promise.reject(error);\n  });\n")])]),t._v(" "),a("p",{attrs:{"data-nodeid":"6536"}},[t._v("在请求返回后，用"),a("code",{attrs:{"data-backticks":"1","data-nodeid":"6693"}},[t._v("axios.interceptors.response.use")]),t._v("方法注入拦截逻辑，比如：")]),t._v(" "),a("pre",{staticClass:"lang-java",attrs:{"data-nodeid":"6537"}},[a("code",{attrs:{"data-language":"java"}},[t._v("axios.interceptors.response.use(function (response) {\n    "),a("span",{staticClass:"hljs-comment"},[t._v("// 响应返回 2xx 时，做一些操作，比如响应状态码为 401 时，自动跳转到登录页")]),t._v("\n    "),a("span",{staticClass:"hljs-keyword"},[t._v("return")]),t._v(" response;\n  }, function (error) {\n    "),a("span",{staticClass:"hljs-comment"},[t._v("// 响应返回 2xx 外响应码时，错误处理逻辑")]),t._v("\n    "),a("span",{staticClass:"hljs-keyword"},[t._v("return")]),t._v(" Promise.reject(error);\n  });\n")])]),t._v(" "),a("p",{attrs:{"data-nodeid":"6538"}},[t._v("任务注册部分的源码实现也不复杂：")]),t._v(" "),a("pre",{staticClass:"lang-java",attrs:{"data-nodeid":"6539"}},[a("code",{attrs:{"data-language":"java"}},[a("span",{staticClass:"hljs-comment"},[t._v("// lib/core/Axios.js")]),t._v("\n"),a("span",{staticClass:"hljs-function"},[t._v("function "),a("span",{staticClass:"hljs-title"},[t._v("Axios")]),a("span",{staticClass:"hljs-params"},[t._v("(instanceConfig)")]),t._v(" ")]),t._v("{\n  "),a("span",{staticClass:"hljs-keyword"},[t._v("this")]),t._v(".defaults = instanceConfig;\n  "),a("span",{staticClass:"hljs-keyword"},[t._v("this")]),t._v(".interceptors = {\n    request: "),a("span",{staticClass:"hljs-keyword"},[t._v("new")]),t._v(" InterceptorManager(),\n    response: "),a("span",{staticClass:"hljs-keyword"},[t._v("new")]),t._v(" InterceptorManager()\n  };\n}\n"),a("span",{staticClass:"hljs-comment"},[t._v("// lib/core/InterceptorManager.js")]),t._v("\n"),a("span",{staticClass:"hljs-function"},[t._v("function "),a("span",{staticClass:"hljs-title"},[t._v("InterceptorManager")]),a("span",{staticClass:"hljs-params"},[t._v("()")]),t._v(" ")]),t._v("{\n  "),a("span",{staticClass:"hljs-keyword"},[t._v("this")]),t._v(".handlers = [];\n}\nInterceptorManager.prototype.use = "),a("span",{staticClass:"hljs-function"},[t._v("function "),a("span",{staticClass:"hljs-title"},[t._v("use")]),a("span",{staticClass:"hljs-params"},[t._v("(fulfilled, rejected)")]),t._v(" ")]),t._v("{\n  "),a("span",{staticClass:"hljs-keyword"},[t._v("this")]),t._v(".handlers.push({\n    fulfilled: fulfilled,\n    rejected: rejected\n  });\n  "),a("span",{staticClass:"hljs-comment"},[t._v("// 返回当前的索引，用于移除已注册的拦截器")]),t._v("\n  "),a("span",{staticClass:"hljs-keyword"},[t._v("return")]),t._v(" "),a("span",{staticClass:"hljs-keyword"},[t._v("this")]),t._v(".handlers.length - "),a("span",{staticClass:"hljs-number"},[t._v("1")]),t._v(";\n};\n")])]),t._v(" "),a("p",{attrs:{"data-nodeid":"6540"}},[t._v("如上代码，我们定义的请求/响应拦截器，会在每一个 axios 实例的 Interceptors 属性中维护，"),a("code",{attrs:{"data-backticks":"1","data-nodeid":"6697"}},[t._v("this.interceptors.request")]),t._v("和"),a("code",{attrs:{"data-backticks":"1","data-nodeid":"6699"}},[t._v("this.interceptors.response")]),t._v("也都是一个 InterceptorManager 实例，该实例的"),a("code",{attrs:{"data-backticks":"1","data-nodeid":"6701"}},[t._v("handlers")]),t._v("属性"),a("strong",{attrs:{"data-nodeid":"6707"}},[t._v("以数组的形式")]),t._v("存储了使用方定义的一个个拦截器逻辑。")]),t._v(" "),a("p",{attrs:{"data-nodeid":"6541"}},[t._v("注册了任务，我们再来看看任务编排时是如何将拦截器串联起来，并在任务调度阶段执行各个拦截器的。如下源码：")]),t._v(" "),a("div",{staticClass:"language-js extra-class"},[a("pre",{pre:!0,attrs:{class:"language-js"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// lib/core/Axios.js")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Axios")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("prototype"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function-variable function"}},[t._v("request")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("request")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("config")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  config "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("mergeConfig")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("defaults"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" config"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// ...")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("var")]),t._v(" chain "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("dispatchRequest"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("undefined")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("var")]),t._v(" promise "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" Promise"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("resolve")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("config"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 任务编排")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("interceptors"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("request"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("forEach")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("unshiftRequestInterceptors")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("interceptor")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    chain"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("unshift")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("interceptor"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("fulfilled"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" interceptor"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("rejected"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("interceptors"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("response"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("forEach")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("pushResponseInterceptors")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("interceptor")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    chain"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("push")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("interceptor"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("fulfilled"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" interceptor"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("rejected"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 任务调度")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("while")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("chain"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("length"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    promise "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" promise"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("then")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("chain"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("shift")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" chain"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("shift")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" promise"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),a("p",{attrs:{"data-nodeid":"6543"}},[t._v("我们通过"),a("code",{attrs:{"data-backticks":"1","data-nodeid":"6710"}},[t._v("chain")]),t._v("数组来编排调度任务，"),a("code",{attrs:{"data-backticks":"1","data-nodeid":"6712"}},[t._v("dispatchRequest")]),t._v("方法实际执行请求的发送，编排过程实现："),a("strong",{attrs:{"data-nodeid":"6721"}},[t._v("在实际发送请求的方法")]),a("code",{attrs:{"data-backticks":"1","data-nodeid":"6717"}},[t._v("dispatchRequest")]),t._v("前插入请求拦截器，在"),a("code",{attrs:{"data-backticks":"1","data-nodeid":"6719"}},[t._v("dispatchRequest")]),t._v("方法后，插入响应拦截器。")]),t._v(" "),a("p",{attrs:{"data-nodeid":"6544"}},[t._v("任务调度其实就是通过一个 While 循环，通过一个 Promise 实例，遍历迭代"),a("code",{attrs:{"data-backticks":"1","data-nodeid":"6723"}},[t._v("chain")]),t._v("数组方法，并基于 Promise 回调特性，将各个拦截器串联执行起来。")]),t._v(" "),a("p",{attrs:{"data-nodeid":"6545"}},[t._v("我们通过下图，来加深理解：")]),t._v(" "),a("p",{attrs:{"data-nodeid":"6546"}},[a("img",{attrs:{src:"https://s0.lgstatic.com/i/image/M00/94/9E/CgqCHmAY6WuAA9A_AAEfckV_ZjM495.png",alt:"Drawing 1.png","data-nodeid":"6728"}})]),t._v(" "),a("h4",{attrs:{"data-nodeid":"6547"}},[t._v("适配器思想")]),t._v(" "),a("p",{attrs:{"data-nodeid":"6548"}},[t._v("前文提到了 axios 同时支持 Node.js 环境和浏览器环境发送请求，在浏览器中我们可以选用 XMLHttpRequest 或 Fetch 方法发送请求，但是在 Node.js 中，需要通过 HTTP 模块发送请求。对此，axiso 是如何设计实现的呢？")]),t._v(" "),a("p",{attrs:{"data-nodeid":"6549"}},[t._v("为了支持适配不同环境，axios 实现了适配器：Adapter，具体实现在"),a("code",{attrs:{"data-backticks":"1","data-nodeid":"6732"}},[t._v("dispatchRequest")]),t._v("方法中：")]),t._v(" "),a("div",{staticClass:"language-js extra-class"},[a("pre",{pre:!0,attrs:{class:"language-js"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// lib/core/dispatchRequest.js")]),t._v("\nmodule"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function-variable function"}},[t._v("exports")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("dispatchRequest")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("config")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// ...")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("var")]),t._v(" adapter "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" config"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("adapter "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("||")]),t._v(" defaults"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("adapter"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("adapter")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("config"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("then")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("onAdapterResolution")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("response")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// ...")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" response"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("onAdapterRejection")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("reason")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// ...")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" Promise"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("reject")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("reason"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),a("p",{attrs:{"data-nodeid":"6551"}},[t._v("如上代码，axios 支持使用方实现自己的 Adapter，自定义不同环境中的请求实现方式，也提供了默认的 Adapter。默认 Adapter 逻辑代码如下：")]),t._v(" "),a("pre",{staticClass:"lang-java",attrs:{"data-nodeid":"6552"}},[a("code",{attrs:{"data-language":"java"}},[a("span",{staticClass:"hljs-function"},[t._v("function "),a("span",{staticClass:"hljs-title"},[t._v("getDefaultAdapter")]),a("span",{staticClass:"hljs-params"},[t._v("()")]),t._v(" ")]),t._v("{\n  "),a("span",{staticClass:"hljs-keyword"},[t._v("var")]),t._v(" adapter;\n  "),a("span",{staticClass:"hljs-keyword"},[t._v("if")]),t._v(" (typeof XMLHttpRequest !== "),a("span",{staticClass:"hljs-string"},[t._v("'undefined'")]),t._v(") {\n    "),a("span",{staticClass:"hljs-comment"},[t._v("// 浏览器端使用 XMLHttpRequest 方法")]),t._v("\n    adapter = require("),a("span",{staticClass:"hljs-string"},[t._v("'./adapters/xhr'")]),t._v(");\n  } "),a("span",{staticClass:"hljs-keyword"},[t._v("else")]),t._v(" "),a("span",{staticClass:"hljs-keyword"},[t._v("if")]),t._v(" (typeof process !== "),a("span",{staticClass:"hljs-string"},[t._v("'undefined'")]),t._v(" &&\n    Object.prototype.toString.call(process) === "),a("span",{staticClass:"hljs-string"},[t._v("'[object process]'")]),t._v(") {\n    "),a("span",{staticClass:"hljs-comment"},[t._v("// Node.js 端，使用 HTTP 模块")]),t._v("\n    adapter = require("),a("span",{staticClass:"hljs-string"},[t._v("'./adapters/http'")]),t._v(");\n  }\n  "),a("span",{staticClass:"hljs-keyword"},[t._v("return")]),t._v(" adapter;\n}\n")])]),t._v(" "),a("p",{attrs:{"data-nodeid":"6553"}},[t._v("一个 Adapter 需要返回一个 Promise 实例（这是因为"),a("strong",{attrs:{"data-nodeid":"6740"}},[t._v("axios 内部通过 Promise 链式调用完成请求调度")]),t._v("），我们分别看看在浏览器端和 Node.js 端具体 Adapter 实现逻辑：")]),t._v(" "),a("div",{staticClass:"language-js extra-class"},[a("pre",{pre:!0,attrs:{class:"language-js"}},[a("code",[t._v("module"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function-variable function"}},[t._v("exports")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("xhrAdapter")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("config")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("new")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Promise")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("dispatchXhrRequest")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("resolve"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" reject")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("var")]),t._v(" requestData "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" config"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("data"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("var")]),t._v(" requestHeaders "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" config"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("headers"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("var")]),t._v(" request "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("new")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("XMLHttpRequest")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("var")]),t._v(" fullPath "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("buildFullPath")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("config"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("baseURL"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" config"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("url"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    request"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("open")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("config"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("method"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("toUpperCase")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("buildURL")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("fullPath"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" config"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("params"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" config"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("paramsSerializer"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("true")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n    "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// Listen for ready state")]),t._v("\n    request"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function-variable function"}},[t._v("onreadystatechange")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("handleLoad")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n     "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// ....")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// Handle browser request cancellation (as opposed to a manual cancellation)")]),t._v("\n    request"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function-variable function"}},[t._v("onabort")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("handleAbort")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// ...")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// Handle low level network errors")]),t._v("\n    request"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function-variable function"}},[t._v("onerror")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("handleError")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// ...")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// Handle timeout")]),t._v("\n    request"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function-variable function"}},[t._v("ontimeout")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("handleTimeout")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// ...")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// ...")]),t._v("\n\n    request"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("send")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("requestData"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),a("p",{attrs:{"data-nodeid":"6555"}},[t._v("如上代码，就是一个典型的使用 XMLHttpRequest 发送请求的实现内容。在 Node.js 端的实现，精简后代码如下：")]),t._v(" "),a("div",{staticClass:"language-js extra-class"},[a("pre",{pre:!0,attrs:{class:"language-js"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("var")]),t._v(" http "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("require")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'http'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("/*eslint consistent-return:0*/")]),t._v("\nmodule"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function-variable function"}},[t._v("exports")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("httpAdapter")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("config")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("new")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Promise")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("dispatchHttpRequest")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("resolvePromise"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" rejectPromise")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("var")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function-variable function"}},[t._v("resolve")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("resolve")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("value")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("resolvePromise")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("value"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("var")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function-variable function"}},[t._v("reject")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("reject")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("value")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("rejectPromise")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("value"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("var")]),t._v(" data "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" config"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("data"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("var")]),t._v(" headers "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" config"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("headers"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("var")]),t._v(" options "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// ...")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("var")]),t._v(" transport "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" http"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("var")]),t._v(" req "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" http"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("request")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("options"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("handleResponse")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("res")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// ...")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// Handle errors")]),t._v("\n    req"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("on")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'error'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("handleRequestError")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("err")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// ...")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// Send the request")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("utils"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("isStream")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("data"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n      data"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("on")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'error'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("handleStreamError")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("err")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("reject")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("enhanceError")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("err"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" config"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("null")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" req"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("pipe")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("req"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("else")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n      req"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("end")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("data"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),a("p",{attrs:{"data-nodeid":"6557"}},[t._v("上述代码主要是调用 Node.js HTTP 模块，进行请求的发送和处理，当然，真实源码实现还需要考虑 HTTPS 以及 Redirect 等问题，这里我们不再展开。")]),t._v(" "),a("p",{attrs:{"data-nodeid":"6558"}},[t._v("讲到这里，可能你会问，什么场景下，才会需要自定义 Adapter 进行请求发送呢？比如"),a("strong",{attrs:{"data-nodeid":"6748"}},[t._v("在测试阶段或特殊环境")]),t._v("中，我们可以 mock 请求：")]),t._v(" "),a("pre",{staticClass:"lang-java",attrs:{"data-nodeid":"6559"}},[a("code",{attrs:{"data-language":"java"}},[a("span",{staticClass:"hljs-keyword"},[t._v("if")]),t._v(" (isEnv === "),a("span",{staticClass:"hljs-string"},[t._v("'ui-test'")]),t._v(") {\n adapter = require("),a("span",{staticClass:"hljs-string"},[t._v("'axios-mock-adapter'")]),t._v(")\n}\n")])]),t._v(" "),a("p",{attrs:{"data-nodeid":"6560"}},[t._v("实现一个自定义的 Adapter 也并不困难，说到底它也只是一个 Node.js 模块，导出一个 Promise 实例即可：")]),t._v(" "),a("pre",{staticClass:"lang-java",attrs:{"data-nodeid":"6561"}},[a("code",{attrs:{"data-language":"java"}},[a("span",{staticClass:"hljs-keyword"},[t._v("module")]),t._v("."),a("span",{staticClass:"hljs-keyword"},[t._v("exports")]),t._v(" = "),a("span",{staticClass:"hljs-function"},[t._v("function "),a("span",{staticClass:"hljs-title"},[t._v("myAdapter")]),a("span",{staticClass:"hljs-params"},[t._v("(config)")]),t._v(" ")]),t._v("{\n  "),a("span",{staticClass:"hljs-comment"},[t._v("// ...")]),t._v("\n  "),a("span",{staticClass:"hljs-keyword"},[t._v("return")]),t._v(" "),a("span",{staticClass:"hljs-keyword"},[t._v("new")]),t._v(" Promise(function(resolve, reject) {\n    "),a("span",{staticClass:"hljs-comment"},[t._v("// ...")]),t._v("\n    sendRequest(resolve, reject, response);\n    "),a("span",{staticClass:"hljs-comment"},[t._v("// ....")]),t._v("\n  });\n}\n")])]),t._v(" "),a("p",{attrs:{"data-nodeid":"6562"}},[t._v("相信你学会了这些内容，就对 "),a("a",{attrs:{href:"https://github.com/ctimmerm/axios-mock-adapter","data-nodeid":"6753"}},[t._v("axios-mock-adapter")]),t._v(" 这个库的实现原理了然于胸了。")]),t._v(" "),a("h4",{attrs:{"data-nodeid":"6563"}},[t._v("安全思想")]),t._v(" "),a("p",{attrs:{"data-nodeid":"6564"}},[t._v("说到请求，自然关联着安全问题。在本小节最后部分，我们对 axios 中的一些安全机制进行解析，涉及相关攻击手段：CSRF。")]),t._v(" "),a("blockquote",{attrs:{"data-nodeid":"6565"}},[a("p",{attrs:{"data-nodeid":"6566"}},[t._v("Cross—Site Request Forgery，攻击者盗用了你的身份，以你的名义发送恶意请求，对服务器来说，这个请求是完全合法的，但是却完成了攻击者期望的一个操作，比如以你的名义发送邮件、发消息，盗取你的账号，添加系统管理员，甚至购买商品、虚拟货币转账等。")])]),t._v(" "),a("p",{attrs:{"data-nodeid":"6567"}},[t._v("在 axios 中，主要依赖双重 cookie 的方式防御 CSRF。具体来说，对于攻击者，获取用户 cookie 是比较困难的，因此，"),a("strong",{attrs:{"data-nodeid":"6763"}},[t._v("我们可以在请求中携带一个 cookie 值，来保证请求的安全性")]),t._v("。这里我们将相关流程梳理为：")]),t._v(" "),a("ul",{attrs:{"data-nodeid":"6568"}},[a("li",{attrs:{"data-nodeid":"6569"}},[a("p",{attrs:{"data-nodeid":"6570"}},[t._v("用户访问页面，后端向请求域中注入一个 cookie，一般该 cookie 值为加密随机字符串；")])]),t._v(" "),a("li",{attrs:{"data-nodeid":"6571"}},[a("p",{attrs:{"data-nodeid":"6572"}},[t._v("在前端通过 Ajax 请求数据时，取出上述 cookie，添加到 URL 参数或者请求 header 中；")])]),t._v(" "),a("li",{attrs:{"data-nodeid":"6573"}},[a("p",{attrs:{"data-nodeid":"6574"}},[t._v("后端接口验证请求中携带的 cookie 值是否合法，不合法（不一致），则拒绝请求。")])])]),t._v(" "),a("p",{attrs:{"data-nodeid":"6575"}},[t._v("我们看 axios 源码：")]),t._v(" "),a("pre",{staticClass:"lang-java",attrs:{"data-nodeid":"6576"}},[a("code",{attrs:{"data-language":"java"}},[a("span",{staticClass:"hljs-comment"},[t._v("// lib/defaults.js")]),t._v("\n"),a("span",{staticClass:"hljs-keyword"},[t._v("var")]),t._v(" defaults = {\n  adapter: getDefaultAdapter(),\n  "),a("span",{staticClass:"hljs-comment"},[t._v("// ...")]),t._v("\n  xsrfCookieName: "),a("span",{staticClass:"hljs-string"},[t._v("'XSRF-TOKEN'")]),t._v(",\n  xsrfHeaderName: "),a("span",{staticClass:"hljs-string"},[t._v("'X-XSRF-TOKEN'")]),t._v(",\n};\n")])]),t._v(" "),a("p",{attrs:{"data-nodeid":"6577"}},[t._v("在这里，axios 默认配置了默认"),a("code",{attrs:{"data-backticks":"1","data-nodeid":"6769"}},[t._v("xsrfCookieName")]),t._v("和"),a("code",{attrs:{"data-backticks":"1","data-nodeid":"6771"}},[t._v("xsrfHeaderName")]),t._v("，实际开发中可以按具体情况传入配置。在具体请求时，以"),a("code",{attrs:{"data-backticks":"1","data-nodeid":"6773"}},[t._v("lib/adapters/xhr.js")]),t._v("为例：")]),t._v(" "),a("pre",{staticClass:"lang-java",attrs:{"data-nodeid":"6578"}},[a("code",{attrs:{"data-language":"java"}},[a("span",{staticClass:"hljs-comment"},[t._v("// 添加 xsrf header")]),t._v("\n"),a("span",{staticClass:"hljs-keyword"},[t._v("if")]),t._v(" (utils.isStandardBrowserEnv()) {\n  "),a("span",{staticClass:"hljs-keyword"},[t._v("var")]),t._v(" xsrfValue = (config.withCredentials || isURLSameOrigin(fullPath)) && config.xsrfCookieName ?\n    cookies.read(config.xsrfCookieName) :\n    undefined;\n  "),a("span",{staticClass:"hljs-keyword"},[t._v("if")]),t._v(" (xsrfValue) {\n    requestHeaders[config.xsrfHeaderName] = xsrfValue;\n  }\n}\n")])]),t._v(" "),a("p",{attrs:{"data-nodeid":"6579"}},[t._v("由此可见，对一个成熟请求库的设计来说，安全防范这个话题永不过时。")]),t._v(" "),a("h3",{attrs:{"data-nodeid":"6580"}},[t._v("总结")]),t._v(" "),a("p",{attrs:{"data-nodeid":"6581"}},[t._v("本讲我们在开篇分析了代码设计、代码分层的方方面面，一个好的设计一定是层次明晰，各司其职的，一个好的设计也会直接帮助业务开发提升效率。封装和设计，是编程领域亘古不变的经典话题，需要每名开发者下沉到业务开发中体会、思考。")]),t._v(" "),a("p",{attrs:{"data-nodeid":"6582"}},[t._v("本小节的后半部分，我们从源码入手，分析了 axios 的优秀设计思想。即便你在业务中没有使用过 axios，但对于 axios 的学习始终是必要且重要的。")]),t._v(" "),a("p",{attrs:{"data-nodeid":"6583"}},[t._v("主要内容总结如下：")]),t._v(" "),a("p",{attrs:{"data-nodeid":"6584"}},[a("img",{attrs:{src:"https://s0.lgstatic.com/i/image2/M01/0C/8A/Cip5yGAY6X6ASgWfAAEY6D_f_OM734.png",alt:"Drawing 2.png","data-nodeid":"6782"}})]),t._v(" "),a("p",{staticClass:"te-preview-highlight",attrs:{"data-nodeid":"6585"}},[t._v("最后，给大家布置一个思考题：axios 支持"),a("a",{attrs:{href:"https://github.com/axios/axios#cancellation","data-nodeid":"6786"}},[t._v("请求取消能力")]),t._v("，这是如何实现的呢？欢迎在留言区和我分享你的观点。下一讲，我们将继续学习代码设计这一话题，通过对比 Koa 和 Redux，聚焦中间件化和插件化理念。我们下一讲再见。")]),t._v(" "),a("hr"),t._v(" "),a("h3",{attrs:{id:"精选评论"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#精选评论"}},[t._v("#")]),t._v(" 精选评论")]),t._v(" "),a("h5",{attrs:{id:"用户4723"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#用户4723"}},[t._v("#")]),t._v(" **用户4723")]),t._v(" "),a("blockquote",[a("p",[t._v("通过传递config配置cancelToken的形式，来取消的。判断有传cancelToken，在promise链式调用的dispatchRequest抛出错误，在adapter中request.abort()取消请求，使promise走向rejected，被用户捕获取消信息。具体分析之前写过一篇《学习 axios 源码整体架构，打造属于自己的请求库》链接："),a("a",{attrs:{href:"https://lxchuan12.gitee.io/axios/",target:"_blank",rel:"noopener noreferrer"}},[t._v("https://lxchuan12.gitee.io/axios/"),a("OutboundLink")],1)])]),t._v(" "),a("h5",{attrs:{id:"勇"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#勇"}},[t._v("#")]),t._v(" *勇")]),t._v(" "),a("blockquote",[a("p",[t._v("axios 通过在config中传入一个cancelToken, cancelToken.promise 实际为一个PENDING状态的promise实例，当用户调用cancel方法，会使该promise 实例由PENDING状态变为RESOLVE状态，触发监听函数onCanceled，调用request.abort()，取消xhr调用")])]),t._v(" "),a("h5",{attrs:{id:"贤"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#贤"}},[t._v("#")]),t._v(" **贤")]),t._v(" "),a("blockquote",[a("p",[t._v("哈哈, 我搞的项目就是 options 驱动一切...")])]),t._v(" "),a("h5",{attrs:{id:"明"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#明"}},[t._v("#")]),t._v(" **明")]),t._v(" "),a("blockquote",[a("p",[t._v("合理的设计是，底层部分保留对全局封装的影响范围，而项目层保留对页面层的影响能力，页面层保留对组件层的影响能力。这里的 XXX 保留对 xxx 的影响能力怎么理解？")])]),t._v(" "),a("h6",{attrs:{id:"讲师回复"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#讲师回复"}},[t._v("#")]),t._v("     讲师回复")]),t._v(" "),a("blockquote",[a("p",[t._v("    就是底层可以「修改和干预」上层，而上层只能依赖底层，不可以修改底层")])])])}),[],!1,null,null,null);a.default=e.exports}}]);