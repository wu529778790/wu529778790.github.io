(window.webpackJsonp=window.webpackJsonp||[]).push([[158],{492:function(t,s,a){"use strict";a.r(s);var e=a(4),n=Object(e.a)({},(function(){var t=this,s=t._self._c;return s("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[s("p",{attrs:{"data-nodeid":"39436"}},[t._v("通过上一讲的内容，相信你已经了解了现代化构建流程和处理内容。这一讲，我将结合 Webpack 为主的成熟方案现阶段的“不足”，从源码实现角度带你分析 Vite 的设计哲学，同时为“解析 Webpack 源码，实现自己的构建工具”一讲内容打下基础，循序渐进，最终你将能够开发一个自己的构建工具。")]),t._v(" "),s("h3",{attrs:{"data-nodeid":"39437"}},[t._v("Vite 的“横空出世”")]),t._v(" "),s("p",{attrs:{"data-nodeid":"39438"}},[t._v("Vite 是由 Vue 作者尤雨溪开发的 Web 开发工具，尤雨溪在微博上推广时对 Vite 做了简短介绍：")]),t._v(" "),s("blockquote",{attrs:{"data-nodeid":"39439"}},[s("p",{attrs:{"data-nodeid":"39440"}},[t._v("Vite，一个基于浏览器原生 ES imports 的开发服务器。利用浏览器去解析 imports，在服务器端按需编译返回，完全跳过了打包这个概念，服务器随起随用。同时不仅有 Vue 文件支持，还搞定了热更新，而且热更新的速度不会随着模块增多而变慢。针对生产环境则可以把同一份代码用 Rollup 打包。虽然现在还比较粗糙，但这个方向我觉得是有潜力的，做得好可以彻底解决改一行代码等半天热更新的问题。")])]),t._v(" "),s("p",{attrs:{"data-nodeid":"39441"}},[t._v("从这段话中我们能够提炼一些关键点：")]),t._v(" "),s("ul",{attrs:{"data-nodeid":"39442"}},[s("li",{attrs:{"data-nodeid":"39443"}},[s("p",{attrs:{"data-nodeid":"39444"}},[t._v("Vite 基于 ESM，因此实现了快速启动和即时模块热更新能力；")])]),t._v(" "),s("li",{attrs:{"data-nodeid":"39445"}},[s("p",{attrs:{"data-nodeid":"39446"}},[t._v("Vite 在服务端实现了按需编译。")])])]),t._v(" "),s("p",{attrs:{"data-nodeid":"39447"}},[t._v("经验丰富的开发者通过上述介绍，似乎就能给出 Vite 的基本流程，甚至可以说得更直白一些："),s("strong",{attrs:{"data-nodeid":"39585"}},[t._v("Vite 在开发环境下并没有打包和构建过程")]),t._v("。")]),t._v(" "),s("p",{attrs:{"data-nodeid":"39448"}},[t._v("开发者在代码中写到的 ESM 导入语法会直接发送给服务器，而服务器也直接将 ESM 模块内容运行处理后，下发给浏览器。接着，现代浏览器通过解析 script module，对每一个 import 到的模块进行 HTTP 请求，服务器继续对这些 HTTP 请求进行处理并响应。")]),t._v(" "),s("h3",{attrs:{"data-nodeid":"39449"}},[t._v("Vite 实现原理解读")]),t._v(" "),s("p",{attrs:{"data-nodeid":"39450"}},[t._v("Vite 思想比较容易理解，实现起来也并不复杂。接下来，我们就对 Vite 源码进行分析，帮助你更好地体会它的设计哲学和实现技巧。")]),t._v(" "),s("p",{attrs:{"data-nodeid":"39451"}},[t._v("首先，我们打造一个学习环境，创建一个基于 Vite 的应用，并启动：")]),t._v(" "),s("pre",{staticClass:"lang-java",attrs:{"data-nodeid":"39452"}},[s("code",{attrs:{"data-language":"java"}},[t._v("npm init vite-app vite-app\ncd vite-app\nnpm install\nnpm run dev\n")])]),t._v(" "),s("p",{attrs:{"data-nodeid":"39453"}},[t._v("得到以下目录结构和页面内容：")]),t._v(" "),s("p",{attrs:{"data-nodeid":"39454"}},[s("img",{attrs:{src:"https://s0.lgstatic.com/i/image/M00/8C/18/Ciqc1F_ltOCAMzS3AAHqGo5sIeo562.png",alt:"Lark20201225-174521.png","data-nodeid":"39593"}})]),t._v(" "),s("p",{attrs:{"data-nodeid":"39455"}},[s("img",{attrs:{src:"https://s0.lgstatic.com/i/image2/M01/03/A7/Cip5yF_gX_iAUku7AAK-5yeYi0A500.png",alt:"Drawing 1.png","data-nodeid":"39596"}})]),t._v(" "),s("p",{attrs:{"data-nodeid":"39456"}},[t._v("其中浏览器请求："),s("code",{attrs:{"data-backticks":"1","data-nodeid":"39598"}},[t._v("http://localhost:3000/")]),t._v("，得到的内容即是我们应用项目中的 index.html 内容。")]),t._v(" "),s("p",{attrs:{"data-nodeid":"39457"}},[t._v("在项目 packaga.json 中，我们看到：")]),t._v(" "),s("pre",{staticClass:"lang-java",attrs:{"data-nodeid":"39458"}},[s("code",{attrs:{"data-language":"java"}},[s("span",{staticClass:"hljs-string"},[t._v('"scripts"')]),t._v(": {\n    "),s("span",{staticClass:"hljs-string"},[t._v('"dev"')]),t._v(": "),s("span",{staticClass:"hljs-string"},[t._v('"vite"')]),t._v(",\n    "),s("span",{staticClass:"hljs-comment"},[t._v("// ...")]),t._v("\n },\n")])]),t._v(" "),s("p",{attrs:{"data-nodeid":"39459"}},[t._v("找到 Vite 源码中，"),s("a",{attrs:{href:"https://github.com/vitejs/vite/blob/master/src/node/cli.ts#L66","data-nodeid":"39604"}},[t._v("命令行实现部分：")])]),t._v(" "),s("pre",{staticClass:"lang-java",attrs:{"data-nodeid":"39460"}},[s("code",{attrs:{"data-language":"java"}},[s("span",{staticClass:"hljs-keyword"},[t._v("if")]),t._v(" (!options.command || options.command === "),s("span",{staticClass:"hljs-string"},[t._v("'serve'")]),t._v(") {\n runServe(options)\n} "),s("span",{staticClass:"hljs-keyword"},[t._v("else")]),t._v(" "),s("span",{staticClass:"hljs-keyword"},[t._v("if")]),t._v(" (options.command === "),s("span",{staticClass:"hljs-string"},[t._v("'build'")]),t._v(") {\n runBuild(options)\n} "),s("span",{staticClass:"hljs-keyword"},[t._v("else")]),t._v(" "),s("span",{staticClass:"hljs-keyword"},[t._v("if")]),t._v(" (options.command === "),s("span",{staticClass:"hljs-string"},[t._v("'optimize'")]),t._v(") {\n runOptimize(options)\n} "),s("span",{staticClass:"hljs-keyword"},[t._v("else")]),t._v(" {\n console.error(chalk.red(`unknown command: ${options.command}`))\n process.exit("),s("span",{staticClass:"hljs-number"},[t._v("1")]),t._v(")\n}\n")])]),t._v(" "),s("p",{attrs:{"data-nodeid":"39461"}},[t._v("上面代码，根据不同的命令行命令，执行不同的入口函数。")]),t._v(" "),s("p",{attrs:{"data-nodeid":"39462"}},[t._v("在开发模式下，Vite 通过 runServe 方法，启动了一个 koaServer，来实现对浏览器请求的响应，"),s("a",{attrs:{href:"https://github.com/vitejs/vite/blob/c3ef4f64ec09c6916f4e6b9764362a23843b98b6/src/node/cli.ts#L131","data-nodeid":"39609"}},[t._v("runServer 实现")]),t._v("如下：")]),t._v(" "),s("pre",{staticClass:"lang-java",attrs:{"data-nodeid":"39463"}},[s("code",{attrs:{"data-language":"java"}},[s("span",{staticClass:"hljs-keyword"},[t._v("const")]),t._v(" server = require("),s("span",{staticClass:"hljs-string"},[t._v("'./server'")]),t._v(").createServer(options)\n")])]),t._v(" "),s("p",{attrs:{"data-nodeid":"39464"}},[s("a",{attrs:{href:"https://github.com/vitejs/vite/blob/c3ef4f64ec09c6916f4e6b9764362a23843b98b6/src/node/server/index.ts#L50","data-nodeid":"39613"}},[t._v("createServer 方法实现")]),t._v("，我们可以精简为以下内容：")]),t._v(" "),s("div",{staticClass:"language-js extra-class"},[s("pre",{pre:!0,attrs:{class:"language-js"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("export")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("createServer")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token parameter"}},[s("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("config")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" ServerConfig")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" Server "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    root "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" process"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("cwd")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    configureServer "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    resolvers "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    alias "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    transforms "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    vueCustomBlockTransforms "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    optimizeDeps "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    enableEsbuild "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("true")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" config\n  "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 创建 Koa 实例")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" app "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("new")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Koa")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("State"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" Context"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" server "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("resolveServer")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("config"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" app"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("callback")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" resolver "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("createResolver")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("root"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" resolvers"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" alias"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 相关上下文信息 ")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("context")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" ServerPluginContext "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    root"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    app"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    server"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    resolver"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    config"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("port")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" config"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("port "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("||")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("3000")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 一个简单中间件，扩充 context 上下文内容")]),t._v("\n  app"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("use")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("ctx"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" next")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    Object"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("assign")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("ctx"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" context"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    ctx"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("read "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("cachedRead")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("bind")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("null")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" ctx"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("next")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" resolvedPlugins "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// ...")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\nresolvedPlugins"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("forEach")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("m")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" m "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&&")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("m")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("context"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" listen "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" server"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("listen")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("bind")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("server"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\nserver"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("listen "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("async")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token parameter"}},[s("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("port")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" number"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("...")]),t._v("args"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" any"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")])]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("optimizeDeps"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("auto "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!==")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("false")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("await")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("require")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'../optimizer'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("optimizeDeps")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("config"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" listener "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("listen")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("port"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("...")]),t._v("args"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\ncontext"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("port "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" server"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("address")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("port\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" listener\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("as")]),t._v(" any\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" server\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),s("p",{attrs:{"data-nodeid":"39466"}},[t._v("浏览器在访问"),s("code",{attrs:{"data-backticks":"1","data-nodeid":"39616"}},[t._v("http://localhost:3000/")]),t._v("后，得到了主体为：")]),t._v(" "),s("pre",{staticClass:"lang-java",attrs:{"data-nodeid":"39467"}},[s("code",{attrs:{"data-language":"java"}},[t._v('<body>\n  <di v id="app"></div>\n  <script type="module" src="/src/main.js"><\/script>\n</body>\n')])]),t._v(" "),s("p",{attrs:{"data-nodeid":"39468"}},[t._v("的内容。")]),t._v(" "),s("p",{attrs:{"data-nodeid":"39469"}},[t._v("依据 ESM 规范在浏览器 script 标签中的实现，对于"),s("code",{attrs:{"data-backticks":"1","data-nodeid":"39620"}},[t._v('<script type="module" src="./bar.js"><\/script>')]),t._v("内容："),s("strong",{attrs:{"data-nodeid":"39626"}},[t._v("当出现 script 标签 type 属性为 module 时，浏览器将会请求模块相应内容")]),t._v("。")]),t._v(" "),s("p",{attrs:{"data-nodeid":"39470"}},[t._v("另一种 ESM 规范在浏览器 script 标签中的实现为：")]),t._v(" "),s("pre",{staticClass:"lang-java",attrs:{"data-nodeid":"39471"}},[s("code",{attrs:{"data-language":"java"}},[t._v('<script type="module">\n  import { bar } from \'./bar.js‘\n<\/script>\n')])]),t._v(" "),s("p",{attrs:{"data-nodeid":"39472"}},[t._v("浏览器会发起 HTTP 请求，请求 HTTP Server 托管的 bar.js。")]),t._v(" "),s("p",{attrs:{"data-nodeid":"39473"}},[t._v("我们可以看到，经过 Vite Server 处理 http://localhost:3000/src/main.js 请求后，最终返回了：")]),t._v(" "),s("p",{attrs:{"data-nodeid":"39474"}},[s("img",{attrs:{src:"https://s0.lgstatic.com/i/image/M00/8C/18/Ciqc1F_ltQGAaQZkAAXD68sxUe4161.png",alt:"Lark20201225-174524.png","data-nodeid":"39632"}})]),t._v(" "),s("p",{attrs:{"data-nodeid":"39475"}},[t._v("返回内容和我们项目中的 ./src/main.js 略有差别：")]),t._v(" "),s("pre",{staticClass:"lang-java",attrs:{"data-nodeid":"39476"}},[s("code",{attrs:{"data-language":"java"}},[s("span",{staticClass:"hljs-keyword"},[t._v("import")]),t._v(" { createApp } from "),s("span",{staticClass:"hljs-string"},[t._v("'vue'")]),t._v("\n"),s("span",{staticClass:"hljs-keyword"},[t._v("import")]),t._v(" App from "),s("span",{staticClass:"hljs-string"},[t._v("'./App.vue'")]),t._v("\n"),s("span",{staticClass:"hljs-keyword"},[t._v("import")]),t._v(" "),s("span",{staticClass:"hljs-string"},[t._v("'./index.css'")]),t._v("\n")])]),t._v(" "),s("p",{attrs:{"data-nodeid":"39477"}},[t._v("现在变为：")]),t._v(" "),s("pre",{staticClass:"lang-java",attrs:{"data-nodeid":"39478"}},[s("code",{attrs:{"data-language":"java"}},[s("span",{staticClass:"hljs-keyword"},[t._v("import")]),t._v(" { createApp } from "),s("span",{staticClass:"hljs-string"},[t._v("'/@modules/vue.js'")]),t._v("\n"),s("span",{staticClass:"hljs-keyword"},[t._v("import")]),t._v(" App from "),s("span",{staticClass:"hljs-string"},[t._v("'/src/App.vue'")]),t._v("\n"),s("span",{staticClass:"hljs-keyword"},[t._v("import")]),t._v(" "),s("span",{staticClass:"hljs-string"},[t._v("'/src/index.css?import'")]),t._v("\n")])]),t._v(" "),s("p",{attrs:{"data-nodeid":"39479"}},[t._v("这里我们拆成两部分来看。")]),t._v(" "),s("p",{attrs:{"data-nodeid":"39480"}},[t._v("其中"),s("code",{attrs:{"data-backticks":"1","data-nodeid":"39637"}},[t._v("import { createApp } from 'vue'")]),t._v("改为"),s("code",{attrs:{"data-backticks":"1","data-nodeid":"39639"}},[t._v("import { createApp } from '/@modules/vue.js'")]),t._v("，原因很明显："),s("strong",{attrs:{"data-nodeid":"39656"}},[t._v('import 对应的路径只支持 "/""./"或者 "../" 开头的内容，直接使用模块名 import，会立即报错')]),t._v("。")]),t._v(" "),s("p",{attrs:{"data-nodeid":"39481"}},[t._v("所以在 Vite Server 处理请求时，通过 serverPluginModuleRewrite 这个中间件来给 import from 'A' 的 A 添加 /@module/ 前缀为 from '/@modules/A'，"),s("a",{attrs:{href:"https://github.com/vitejs/vite/blob/master/src/node/server/index.ts#L97","data-nodeid":"39668"}},[t._v("源码部分对应")]),t._v("：")]),t._v(" "),s("pre",{staticClass:"lang-java",attrs:{"data-nodeid":"39482"}},[s("code",{attrs:{"data-language":"java"}},[s("span",{staticClass:"hljs-keyword"},[t._v("const")]),t._v(" resolvedPlugins = [\n  "),s("span",{staticClass:"hljs-comment"},[t._v("// ...")]),t._v("\n  moduleRewritePlugin,\n  "),s("span",{staticClass:"hljs-comment"},[t._v("// ...")]),t._v("\n]\nresolvedPlugins.forEach((m) => m && m(context))\n")])]),t._v(" "),s("p",{attrs:{"data-nodeid":"39483"}},[t._v("而 moduleRewritePlugin 插件的"),s("a",{attrs:{href:"https://github.com/vitejs/vite/blob/c3ef4f64ec09c6916f4e6b9764362a23843b98b6/src/node/server/serverPluginModuleRewrite.ts#L48","data-nodeid":"39673"}},[t._v("实现")]),t._v("也并不困难，主要通过 "),s("a",{attrs:{href:"https://github.com/vitejs/vite/blob/c3ef4f64ec09c6916f4e6b9764362a23843b98b6/src/node/server/serverPluginModuleRewrite.ts#L120","data-nodeid":"39677"}},[t._v("rewriteImports 方法")]),t._v("，来执行 "),s("a",{attrs:{href:"https://github.com/vitejs/vite/blob/c3ef4f64ec09c6916f4e6b9764362a23843b98b6/src/node/server/serverPluginModuleRewrite.ts#L259","data-nodeid":"39681"}},[t._v("resolveImport 方法")]),t._v("，并进行改写。这里已经添加了相关源码链接，我们不再一一展开，你可以在课后进一步学习。")]),t._v(" "),s("p",{attrs:{"data-nodeid":"39484"}},[t._v("整个过程和调用链路较长，我对 Vite 处理 import 方法做一个简单总结：")]),t._v(" "),s("ul",{attrs:{"data-nodeid":"39485"}},[s("li",{attrs:{"data-nodeid":"39486"}},[s("p",{attrs:{"data-nodeid":"39487"}},[t._v("在 koa 中间件里获取请求 path 对应的 body 内容；")])]),t._v(" "),s("li",{attrs:{"data-nodeid":"39488"}},[s("p",{attrs:{"data-nodeid":"39489"}},[t._v("通过 "),s("a",{attrs:{href:"https://github.com/guybedford/es-module-lexer","data-nodeid":"39688"}},[t._v("es-module-lexer")]),t._v(" 解析资源 AST，并拿到 import 的内容；")])]),t._v(" "),s("li",{attrs:{"data-nodeid":"39490"}},[s("p",{attrs:{"data-nodeid":"39491"}},[t._v("如果判断 import 的资源是绝对路径，即可认为该资源为 npm 模块，并返回处理后的资源路径。比如上述代码中，vue → /@modules/vue。")])])]),t._v(" "),s("p",{attrs:{"data-nodeid":"39492"}},[t._v("对于形如："),s("code",{attrs:{"data-backticks":"1","data-nodeid":"39692"}},[t._v("import App from './App.vue'")]),t._v("和"),s("code",{attrs:{"data-backticks":"1","data-nodeid":"39694"}},[t._v("import './index.css'")]),t._v("的处理，与上述情况类似：")]),t._v(" "),s("ul",{attrs:{"data-nodeid":"39493"}},[s("li",{attrs:{"data-nodeid":"39494"}},[s("p",{attrs:{"data-nodeid":"39495"}},[t._v("在 koa 中间件里获取请求 path 对应的 body 内容；")])]),t._v(" "),s("li",{attrs:{"data-nodeid":"39496"}},[s("p",{attrs:{"data-nodeid":"39497"}},[t._v("通过 "),s("a",{attrs:{href:"https://github.com/guybedford/es-module-lexer","data-nodeid":"39700"}},[t._v("es-module-lexer")]),t._v(" 解析资源 AST，并拿到 import 的内容；")])]),t._v(" "),s("li",{attrs:{"data-nodeid":"39498"}},[s("p",{attrs:{"data-nodeid":"39499"}},[t._v("如果判断 import 的资源是相对路径，即可认为该资源为项目应用中资源，并返回处理后的资源路径。比如上述代码中，./App.vue → /src/App.vue。")])])]),t._v(" "),s("p",{attrs:{"data-nodeid":"39500"}},[t._v("接下来浏览器根据 main.js 的内容，分别请求：")]),t._v(" "),s("pre",{staticClass:"lang-java",attrs:{"data-nodeid":"39501"}},[s("code",{attrs:{"data-language":"java"}},[t._v("/"),s("span",{staticClass:"hljs-meta"},[t._v("@modules")]),t._v("/vue.js\n/src/App.vue\n/src/index.css?"),s("span",{staticClass:"hljs-keyword"},[t._v("import")]),t._v("\n")])]),t._v(" "),s("p",{attrs:{"data-nodeid":"39502"}},[t._v("对于 /@module/ 类请求较为容易，我们只需要完成下面三步：")]),t._v(" "),s("ul",{attrs:{"data-nodeid":"39503"}},[s("li",{attrs:{"data-nodeid":"39504"}},[s("p",{attrs:{"data-nodeid":"39505"}},[t._v("在 koa 中间件里获取请求 path 对应的 body 内容；")])]),t._v(" "),s("li",{attrs:{"data-nodeid":"39506"}},[s("p",{attrs:{"data-nodeid":"39507"}},[t._v("判断路径是否以 /@module/ 开头，如果是，取出包名（这里为 vue.js）；")])]),t._v(" "),s("li",{attrs:{"data-nodeid":"39508"}},[s("p",{attrs:{"data-nodeid":"39509"}},[t._v("去 node_modules 文件中找到对应的 npm 库，并返回内容。")])])]),t._v(" "),s("p",{attrs:{"data-nodeid":"39510"}},[t._v("上述步骤在 Vite 中使用 serverPluginModuleResolve 中间件实现，点击这里可以访问"),s("a",{attrs:{href:"https://github.com/vitejs/vite/blob/c3ef4f64ec09c6916f4e6b9764362a23843b98b6/src/node/server/serverPluginModuleResolve.ts#L22","data-nodeid":"39713"}},[t._v("对应源码")]),t._v("。")]),t._v(" "),s("p",{attrs:{"data-nodeid":"39511"}},[t._v("接着，就是对 /src/App.vue 类请求进行处理，这就涉及 Vite 服务器的编译能力了。")]),t._v(" "),s("p",{attrs:{"data-nodeid":"39512"}},[t._v("我们先看结果，对比项目中的 App.vue，浏览器请求得到的结果显然出现了大变样：")]),t._v(" "),s("p",{attrs:{"data-nodeid":"39513"}},[s("img",{attrs:{src:"https://s0.lgstatic.com/i/image/M00/8B/C6/Ciqc1F_gYEGAL6S2AASUUhepUGQ785.png",alt:"Drawing 3.png","data-nodeid":"39719"}})]),t._v(" "),s("p",{attrs:{"data-nodeid":"39514"}},[t._v("实际上，App.vue 这样的单文件组件对应 script、style 和 template，在经过 Vite Server 处理时，服务端对 script、style 和 template 三部分分别处理，对应中间件为 "),s("a",{attrs:{href:"https://github.com/vitejs/vite/blob/c3ef4f64ec09c6916f4e6b9764362a23843b98b6/src/node/server/serverPluginVue.ts","data-nodeid":"39723"}},[t._v("serverPluginVue")]),t._v("。这个中间件的实现很简单，即"),s("strong",{attrs:{"data-nodeid":"39733"}},[t._v("对 .vue 文件请求进行处理，通过 parseSFC 方法解析单文件组件，并通过 compileSFCMain 方法将单文件组件拆分")]),t._v("为形如上图内容，对应中间件关键内容可在源码 vuePlugin 中找到。源码中，涉及 "),s("a",{attrs:{href:"https://github.com/vitejs/vite/blob/c3ef4f64ec09c6916f4e6b9764362a23843b98b6/src/node/server/serverPluginVue.ts#L377","data-nodeid":"39731"}},[t._v("parseSFC")]),t._v(" 具体所做的事情，是调用 @vue/compiler-sfc 进行单文件组件解析。精简为我自己的逻辑，帮助你理解：")]),t._v(" "),s("pre",{staticClass:"lang-java",attrs:{"data-nodeid":"39515"}},[s("code",{attrs:{"data-language":"java"}},[s("span",{staticClass:"hljs-keyword"},[t._v("if")]),t._v(" (!query.type) {\n  ctx.body = `\n    "),s("span",{staticClass:"hljs-keyword"},[t._v("const")]),t._v(" __script = ${descriptor.script.content.replace("),s("span",{staticClass:"hljs-string"},[t._v("'export default '")]),t._v(", "),s("span",{staticClass:"hljs-string"},[t._v("''")]),t._v(")}\n    "),s("span",{staticClass:"hljs-comment"},[t._v("// 单文件组件中，对于 style 部分的编译，编译为对应 style 样式的 import 请求")]),t._v("\n    ${descriptor.styles.length ? `"),s("span",{staticClass:"hljs-keyword"},[t._v("import")]),t._v(" "),s("span",{staticClass:"hljs-string"},[t._v('"${url}?type=style"')]),t._v("` : "),s("span",{staticClass:"hljs-string"},[t._v("''")]),t._v("}\n    "),s("span",{staticClass:"hljs-comment"},[t._v("// 单文件组件中，对于 template 部分的编译，编译为对应 template 样式的 import 请求")]),t._v("\n    "),s("span",{staticClass:"hljs-keyword"},[t._v("import")]),t._v(" { render as __render } from "),s("span",{staticClass:"hljs-string"},[t._v('"${url}?type=template"')]),t._v("\n    "),s("span",{staticClass:"hljs-comment"},[t._v("// 渲染 template 的内容")]),t._v("\n    __script.render = __render;\n    export "),s("span",{staticClass:"hljs-keyword"},[t._v("default")]),t._v(" __script;\n  `;\n}\n")])]),t._v(" "),s("p",{attrs:{"data-nodeid":"39516"}},[t._v("总而言之，每一个 .vue 单文件组件都被拆分成多个请求。比如对应上面场景，浏览器接收到 App.vue 对应的实际内容后，发出 HelloWorld.vue 以及 App.vue?type=template 的请求（通过 type 这个 query 来表示是 template 还是 style）。koa server 进行分别处理并返回，这些请求依然分别被上面提到的 serverPluginVue 中间件处理：对于 template 的请求，服务使用 @vue/compiler-dom 进行编译 template 并返回内容。")]),t._v(" "),s("p",{attrs:{"data-nodeid":"39517"}},[t._v("精简为我自己的逻辑，帮助你理解：")]),t._v(" "),s("pre",{staticClass:"lang-java",attrs:{"data-nodeid":"39518"}},[s("code",{attrs:{"data-language":"java"}},[s("span",{staticClass:"hljs-keyword"},[t._v("if")]),t._v(" (query.type === "),s("span",{staticClass:"hljs-string"},[t._v("'template'")]),t._v(") {\n "),s("span",{staticClass:"hljs-keyword"},[t._v("const")]),t._v(" template = descriptor.template;\n "),s("span",{staticClass:"hljs-keyword"},[t._v("const")]),t._v(" render = require("),s("span",{staticClass:"hljs-string"},[t._v("'@vue/compiler-dom'")]),t._v(").compile(template.content, {\n   mode: "),s("span",{staticClass:"hljs-string"},[t._v("'module'")]),t._v(",\n }).code;\n ctx.type = "),s("span",{staticClass:"hljs-string"},[t._v("'application/javascript'")]),t._v(";\n ctx.body = render;\n}\n")])]),t._v(" "),s("p",{attrs:{"data-nodeid":"39519"}},[t._v("对于上面提到的 http://localhost:3000/src/index.css?import 请求稍微特殊，需通过 serverPluginVue 来实现解析：")]),t._v(" "),s("pre",{staticClass:"lang-java",attrs:{"data-nodeid":"39520"}},[s("code",{attrs:{"data-language":"java"}},[s("span",{staticClass:"hljs-comment"},[t._v("// style 类型请求")]),t._v("\n"),s("span",{staticClass:"hljs-keyword"},[t._v("if")]),t._v(" (query.type === "),s("span",{staticClass:"hljs-string"},[t._v("'style'")]),t._v(") {\n  "),s("span",{staticClass:"hljs-keyword"},[t._v("const")]),t._v(" index = Number(query.index)\n  "),s("span",{staticClass:"hljs-keyword"},[t._v("const")]),t._v(" styleBlock = descriptor.styles[index]\n  "),s("span",{staticClass:"hljs-keyword"},[t._v("if")]),t._v(" (styleBlock.src) {\n    filePath = "),s("span",{staticClass:"hljs-function"},[t._v("await "),s("span",{staticClass:"hljs-title"},[t._v("resolveSrcImport")]),s("span",{staticClass:"hljs-params"},[t._v("(root, styleBlock, ctx, resolver)")]),t._v("\n  }\n  "),s("span",{staticClass:"hljs-keyword"},[t._v("const")]),t._v(" id ")]),t._v("= hash_sum(publicPath)\n  "),s("span",{staticClass:"hljs-comment"},[t._v("// 调用 compileSFCStyle 方法编译当文件组件样式部分")]),t._v("\n  "),s("span",{staticClass:"hljs-keyword"},[t._v("const")]),t._v(" result = "),s("span",{staticClass:"hljs-function"},[t._v("await "),s("span",{staticClass:"hljs-title"},[t._v("compileSFCStyle")]),s("span",{staticClass:"hljs-params"},[t._v("(\n    root,\n    styleBlock,\n    index,\n    filePath,\n    publicPath,\n    config\n  )")]),t._v("\n  ctx.type ")]),t._v("= "),s("span",{staticClass:"hljs-string"},[t._v("'js'")]),t._v("\n  "),s("span",{staticClass:"hljs-comment"},[t._v("// 返回样式内容")]),t._v("\n  ctx.body = codegenCss(`${id}-${index}`, result.code, result.modules)\n  "),s("span",{staticClass:"hljs-keyword"},[t._v("return")]),t._v(" etagCacheCheck(ctx)\n}\n")])]),t._v(" "),s("p",{attrs:{"data-nodeid":"39521"}},[t._v("调用 "),s("a",{attrs:{href:"https://github.com/vitejs/vite/blob/38f811c5b077f437ffff072276531e8f75953e94/src/node/server/serverPluginCss.ts","data-nodeid":"39740"}},[t._v("serverPluginCss")]),t._v(" 中间件的 codegenCss 方法：")]),t._v(" "),s("pre",{staticClass:"lang-java",attrs:{"data-nodeid":"39522"}},[s("code",{attrs:{"data-language":"java"}},[s("span",{staticClass:"hljs-function"},[t._v("export function "),s("span",{staticClass:"hljs-title"},[t._v("codegenCss")]),s("span",{staticClass:"hljs-params"},[t._v("(\n  id: string,\n  css: string,\n  modules?: Record<string, string>\n)")]),t._v(": string ")]),t._v("{\n  "),s("span",{staticClass:"hljs-comment"},[t._v("// 样式代码模板")]),t._v("\n  let code =\n    `"),s("span",{staticClass:"hljs-keyword"},[t._v("import")]),t._v(" { updateStyle } from "),s("span",{staticClass:"hljs-string"},[t._v('"${clientPublicPath}"')]),t._v("\\n` +\n    `"),s("span",{staticClass:"hljs-keyword"},[t._v("const")]),t._v(" css = ${JSON.stringify(css)}\\n` +\n    `updateStyle(${JSON.stringify(id)}, css)\\n`\n  "),s("span",{staticClass:"hljs-keyword"},[t._v("if")]),t._v(" (modules) {\n    code += dataToEsm(modules, { namedExports: "),s("span",{staticClass:"hljs-keyword"},[t._v("true")]),t._v(" })\n  } "),s("span",{staticClass:"hljs-keyword"},[t._v("else")]),t._v(" {\n    code += `export "),s("span",{staticClass:"hljs-keyword"},[t._v("default")]),t._v(" css`\n  }\n  "),s("span",{staticClass:"hljs-keyword"},[t._v("return")]),t._v(" code\n}\n")])]),t._v(" "),s("p",{attrs:{"data-nodeid":"39523"}},[t._v("该方法会在浏览器中执行 updateStyle 方法，"),s("a",{attrs:{href:"https://github.com/vitejs/vite/blob/c3ef4f64ec09c6916f4e6b9764362a23843b98b6/src/client/client.ts#L170","data-nodeid":"39745"}},[t._v("源码")]),t._v("如下：")]),t._v(" "),s("pre",{staticClass:"lang-java",attrs:{"data-nodeid":"39524"}},[s("code",{attrs:{"data-language":"java"}},[s("span",{staticClass:"hljs-keyword"},[t._v("const")]),t._v(" supportsConstructedSheet = (() => {\n  "),s("span",{staticClass:"hljs-keyword"},[t._v("try")]),t._v(" {\n    "),s("span",{staticClass:"hljs-comment"},[t._v("// 生成 CSSStyleSheet 实例，试探是否支持 ConstructedSheet")]),t._v("\n    "),s("span",{staticClass:"hljs-keyword"},[t._v("new")]),t._v(" CSSStyleSheet()\n    "),s("span",{staticClass:"hljs-keyword"},[t._v("return")]),t._v(" "),s("span",{staticClass:"hljs-keyword"},[t._v("true")]),t._v("\n  } "),s("span",{staticClass:"hljs-keyword"},[t._v("catch")]),t._v(" (e) {}\n  "),s("span",{staticClass:"hljs-keyword"},[t._v("return")]),t._v(" "),s("span",{staticClass:"hljs-keyword"},[t._v("false")]),t._v("\n})()\n"),s("span",{staticClass:"hljs-function"},[t._v("export function "),s("span",{staticClass:"hljs-title"},[t._v("updateStyle")]),s("span",{staticClass:"hljs-params"},[t._v("(id: string, content: string)")]),t._v(" ")]),t._v("{\n  let style = sheetsMap.get(id)\n  "),s("span",{staticClass:"hljs-keyword"},[t._v("if")]),t._v(" (supportsConstructedSheet && !content.includes("),s("span",{staticClass:"hljs-string"},[t._v("'@import'")]),t._v(")) {\n    "),s("span",{staticClass:"hljs-keyword"},[t._v("if")]),t._v(" (style && !(style "),s("span",{staticClass:"hljs-keyword"},[t._v("instanceof")]),t._v(" CSSStyleSheet)) {\n      removeStyle(id)\n      style = undefined\n    }\n    "),s("span",{staticClass:"hljs-keyword"},[t._v("if")]),t._v(" (!style) {\n      "),s("span",{staticClass:"hljs-comment"},[t._v("// 生成 CSSStyleSheet 实例")]),t._v("\n      style = "),s("span",{staticClass:"hljs-keyword"},[t._v("new")]),t._v(" CSSStyleSheet()\n      style.replaceSync(content)\n      document.adoptedStyleSheets = [...document.adoptedStyleSheets, style]\n    } "),s("span",{staticClass:"hljs-keyword"},[t._v("else")]),t._v(" {\n      style.replaceSync(content)\n    }\n  } "),s("span",{staticClass:"hljs-keyword"},[t._v("else")]),t._v(" {\n    "),s("span",{staticClass:"hljs-keyword"},[t._v("if")]),t._v(" (style && !(style "),s("span",{staticClass:"hljs-keyword"},[t._v("instanceof")]),t._v(" HTMLStyleElement)) {\n      removeStyle(id)\n      style = undefined\n    }\n    "),s("span",{staticClass:"hljs-keyword"},[t._v("if")]),t._v(" (!style) {\n      "),s("span",{staticClass:"hljs-comment"},[t._v("// 生成新的 style 标签并插入到 document 挡住")]),t._v("\n      style = document.createElement("),s("span",{staticClass:"hljs-string"},[t._v("'style'")]),t._v(")\n      style.setAttribute("),s("span",{staticClass:"hljs-string"},[t._v("'type'")]),t._v(", "),s("span",{staticClass:"hljs-string"},[t._v("'text/css'")]),t._v(")\n      style.innerHTML = content\n      document.head.appendChild(style)\n    } "),s("span",{staticClass:"hljs-keyword"},[t._v("else")]),t._v(" {\n      style.innerHTML = content\n    }\n  }\n  sheetsMap.set(id, style)\n}\n")])]),t._v(" "),s("p",{attrs:{"data-nodeid":"39525"}},[t._v("最终完成在浏览器中插入样式。")]),t._v(" "),s("p",{attrs:{"data-nodeid":"39526"}},[t._v("至此，我们解析并列举了较多源码内容。以上内容需要你跟着思路，一步步梳理，我也强烈建议你打开 Vite 源码自己动手剖析。如果看到这里你仍然也有些“云里雾里”，不要心急，结合我下面这个图示，再次进行阅读，相信会更有收获。")]),t._v(" "),s("p",{attrs:{"data-nodeid":"39527"}},[t._v("Vite 这种 bundleless 方案的运行原理图：")]),t._v(" "),s("p",{attrs:{"data-nodeid":"39528"}},[s("img",{attrs:{src:"https://s0.lgstatic.com/i/image2/M01/03/FB/Cip5yF_ltUqAV2zLAADo9NOnOvk745.png",alt:"Lark20201225-174527.png","data-nodeid":"39752"}})]),t._v(" "),s("p",{attrs:{"data-nodeid":"39529"}},[s("img",{attrs:{src:"https://s0.lgstatic.com/i/image/M00/8C/18/Ciqc1F_ltVCAEgT6AAERxP80SRw964.png",alt:"Lark20201225-174517.png","data-nodeid":"39755"}})]),t._v(" "),s("p",{attrs:{"data-nodeid":"39530"}},[t._v("接下来我们再做一些更细节的总结。")]),t._v(" "),s("ul",{attrs:{"data-nodeid":"39531"}},[s("li",{attrs:{"data-nodeid":"39532"}},[s("p",{attrs:{"data-nodeid":"39533"}},[t._v("Vite 利用浏览器原生支持 ESM 这一特性，省略了对模块的打包，也就不需要生成 bundle，因此初次启动更快，HMR 特性友好。")])]),t._v(" "),s("li",{attrs:{"data-nodeid":"39534"}},[s("p",{attrs:{"data-nodeid":"39535"}},[t._v("Vite 开发模式下，通过启动 koa 服务器，在服务端完成模块的改写（比如单文件的解析编译等）和请求处理，实现真正的按需编译。")])]),t._v(" "),s("li",{attrs:{"data-nodeid":"39536"}},[s("p",{attrs:{"data-nodeid":"39537"}},[t._v("Vite Server 所有逻辑基本都依赖中间件实现。这些中间件，拦截请求之后，完成了如下内容：")]),t._v(" "),s("ul",{attrs:{"data-nodeid":"39538"}},[s("li",{attrs:{"data-nodeid":"39539"}},[s("p",{attrs:{"data-nodeid":"39540"}},[t._v("处理 ESM 语法，比如将业务代码中的 import 第三方依赖路径转为浏览器可识别的依赖路径；")])]),t._v(" "),s("li",{attrs:{"data-nodeid":"39541"}},[s("p",{attrs:{"data-nodeid":"39542"}},[t._v("对 .ts、.vue 等文件进行即时编译；")])]),t._v(" "),s("li",{attrs:{"data-nodeid":"39543"}},[s("p",{attrs:{"data-nodeid":"39544"}},[t._v("对 Sass/Less 的需要预编译的模块进行编译；")])]),t._v(" "),s("li",{attrs:{"data-nodeid":"39545"}},[s("p",{attrs:{"data-nodeid":"39546"}},[t._v("和浏览器端建立 socket 连接，实现 HMR。")])])])])]),t._v(" "),s("h4",{attrs:{"data-nodeid":"39547"}},[t._v("Vite HMR 实现原理")]),t._v(" "),s("p",{attrs:{"data-nodeid":"39548"}},[t._v("Vite 的打包命令使用了 Rollup 进行，这里并没有什么特别之处，我们不再展开讲解。而 Vite 的 HMR 特性，主要是围绕着：")]),t._v(" "),s("ul",{attrs:{"data-nodeid":"39549"}},[s("li",{attrs:{"data-nodeid":"39550"}},[s("p",{attrs:{"data-nodeid":"39551"}},[t._v("通过 watcher 监听文件改动")])]),t._v(" "),s("li",{attrs:{"data-nodeid":"39552"}},[s("p",{attrs:{"data-nodeid":"39553"}},[t._v("通过 server 端编译资源，并推送新模块内容给浏览器")])]),t._v(" "),s("li",{attrs:{"data-nodeid":"39554"}},[s("p",{attrs:{"data-nodeid":"39555"}},[t._v("浏览器收到新的模块内容，执行框架层面的 rerender/reload")])])]),t._v(" "),s("p",{attrs:{"data-nodeid":"39556"}},[t._v("三步进行。")]),t._v(" "),s("p",{attrs:{"data-nodeid":"39557"}},[t._v("当浏览器请求 HTML 页面时，服务端通过 "),s("a",{attrs:{href:"https://github.com/vitejs/vite/blob/master/src/node/server/serverPluginHtml.ts","data-nodeid":"39773"}},[t._v("serverPluginHtml")]),t._v(" 插件向 HTML 内容注入一段脚本。如下图所示，我们可以看到， index.html 中就有一段引入 /vite/client 代码，进行 WebSocket 的注册和监听。")]),t._v(" "),s("p",{attrs:{"data-nodeid":"39558"}},[s("img",{attrs:{src:"https://s0.lgstatic.com/i/image/M00/8B/C7/Ciqc1F_gZk-AeTAnAAK2AAgChPQ413.png",alt:"Drawing 6.png","data-nodeid":"39777"}})]),t._v(" "),s("p",{attrs:{"data-nodeid":"39559"}},[s("img",{attrs:{src:"https://s0.lgstatic.com/i/image/M00/8B/D2/CgqCHl_gZlWAHmvqAAgRairyZ98357.png",alt:"Drawing 7.png","data-nodeid":"39780"}})]),t._v(" "),s("p",{attrs:{"data-nodeid":"39560"}},[t._v("对于 /vite/client 请求的处理，服务端由 "),s("a",{attrs:{href:"https://github.com/vitejs/vite/blob/a47429dabea12e8aa5f4a21209846aaf857d5be0/src/node/server/serverPluginClient.ts","data-nodeid":"39784"}},[t._v("serverPluginClient")]),t._v(" 插件进行处理：")]),t._v(" "),s("pre",{staticClass:"lang-java",attrs:{"data-nodeid":"39561"}},[s("code",{attrs:{"data-language":"java"}},[t._v("export "),s("span",{staticClass:"hljs-keyword"},[t._v("const")]),t._v(" clientPlugin: ServerPlugin = ({ app, config }) => {\n  "),s("span",{staticClass:"hljs-keyword"},[t._v("const")]),t._v(" clientCode = fs\n    .readFileSync(clientFilePath, "),s("span",{staticClass:"hljs-string"},[t._v("'utf-8'")]),t._v(")\n    .replace(`__MODE__`, JSON.stringify(config.mode || "),s("span",{staticClass:"hljs-string"},[t._v("'development'")]),t._v("))\n    .replace(\n      `__DEFINES__`,\n      JSON.stringify({\n        ...defaultDefines,\n        ...config.define\n      })\n    )\n  "),s("span",{staticClass:"hljs-comment"},[t._v("// 相应中间件处理")]),t._v("\n  app.use(async (ctx, next) => {\n    "),s("span",{staticClass:"hljs-keyword"},[t._v("if")]),t._v(" (ctx.path === clientPublicPath) {\n      ctx.type = "),s("span",{staticClass:"hljs-string"},[t._v("'js'")]),t._v("\n      ctx.status = "),s("span",{staticClass:"hljs-number"},[t._v("200")]),t._v("\n      "),s("span",{staticClass:"hljs-comment"},[t._v("// 返回具体内容")]),t._v("\n      ctx.body = clientCode.replace(`__PORT__`, ctx.port.toString())\n    } "),s("span",{staticClass:"hljs-keyword"},[t._v("else")]),t._v(" {\n      "),s("span",{staticClass:"hljs-comment"},[t._v("// 兼容历史逻辑，并进行错误提示")]),t._v("\n      "),s("span",{staticClass:"hljs-keyword"},[t._v("if")]),t._v(" (ctx.path === legacyPublicPath) {\n        console.error(\n          chalk.red(\n            `[vite] client "),s("span",{staticClass:"hljs-keyword"},[t._v("import")]),t._v(" path has changed from "),s("span",{staticClass:"hljs-string"},[t._v('"/vite/hmr"')]),t._v(" to "),s("span",{staticClass:"hljs-string"},[t._v('"/vite/client"')]),t._v(". ` +\n              `please update your code accordingly.`\n          )\n        )\n      }\n      "),s("span",{staticClass:"hljs-keyword"},[t._v("return")]),t._v(" next()\n    }\n  })\n}\n")])]),t._v(" "),s("p",{attrs:{"data-nodeid":"39562"}},[t._v("返回的 /vite/src/client/client.js 代码在浏览器端主要通过 WebSocket 监听了一些更新的类型（vue 组件更新/vue template 更新/vue style 更新/css 更新/css 移除/js 更新/页面 roload），分别进行处理。")]),t._v(" "),s("p",{attrs:{"data-nodeid":"39563"}},[t._v("在服务端，通过 "),s("a",{attrs:{href:"https://www.npmjs.com/package/chokidar","data-nodeid":"39790"}},[t._v("chokidar")]),t._v(" 创建了一个监听文件改动的 watcher 来监听文件改动：")]),t._v(" "),s("pre",{staticClass:"lang-java",attrs:{"data-nodeid":"39564"}},[s("code",{attrs:{"data-language":"java"}},[s("span",{staticClass:"hljs-keyword"},[t._v("const")]),t._v(" watcher = chokidar.watch(root, {\n ignored: [/node_modules/, /\\.git/],\n "),s("span",{staticClass:"hljs-comment"},[t._v("// #610")]),t._v("\n awaitWriteFinish: {\n   stabilityThreshold: "),s("span",{staticClass:"hljs-number"},[t._v("100")]),t._v(",\n   pollInterval: "),s("span",{staticClass:"hljs-number"},[t._v("10")]),t._v("\n }\n}) as HMRWatcher\n")])]),t._v(" "),s("p",{attrs:{"data-nodeid":"39565"}},[t._v("并通过 "),s("a",{attrs:{href:"https://github.com/vitejs/vite/blob/master/src/node/server/serverPluginHmr.ts","data-nodeid":"39795"}},[t._v("serverPluginHmr")]),t._v(" 发布变动，通知浏览器。")]),t._v(" "),s("p",{attrs:{"data-nodeid":"39566"}},[t._v("更多源码不再一一贴出。这里我总结了一张流程图供你参考：")]),t._v(" "),s("p",{attrs:{"data-nodeid":"39809"}},[s("img",{attrs:{src:"https://s0.lgstatic.com/i/image2/M01/03/FD/CgpVE1_ltm6AN8nCAAMSQ8AjILg631.png",alt:"Lark20201225-175233.png","data-nodeid":"39813"}})]),t._v(" "),s("div",{attrs:{"data-nodeid":"39810"}},[s("p",{staticStyle:{"text-align":"center"}},[t._v("Vite 实现 HMR 流程图")])]),t._v(" "),s("h3",{attrs:{"data-nodeid":"39569"}},[t._v("总结")]),t._v(" "),s("p",{attrs:{"data-nodeid":"39570"}},[t._v("这一讲我们聚焦 Vite 实现，分析了如何利用 ESM，构建一个 bundleless 风格的现代化开发工程方案。源码内容较多，也涉及一定工程化架构设计内容，但 Vite 实现流程清晰，易读性高，是源码阅读类很好的资源。")]),t._v(" "),s("p",{attrs:{"data-nodeid":"39571"}},[t._v("事实上，Vite 依赖优化的灵感来自 "),s("a",{attrs:{href:"https://www.snowpack.dev/","data-nodeid":"39806"}},[t._v("Snowpack")]),t._v("，这类 bundleless 工具也代表着一种新趋势、新方向。我认为，技术功底是很重要的一方面，而技术敏感度的培养也非常关键。希望与你共勉！")]),t._v(" "),s("p",{attrs:{"data-nodeid":"39572"}},[t._v("到此，新编译工具理念——Vite 我们就介绍到这里。接下来我们将进入代码降级编译环节的学习，我们下一讲再见。")]),t._v(" "),s("hr"),t._v(" "),s("h3",{attrs:{id:"精选评论"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#精选评论"}},[t._v("#")]),t._v(" 精选评论")]),t._v(" "),s("h5",{attrs:{id:"龙"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#龙"}},[t._v("#")]),t._v(" **龙")]),t._v(" "),s("blockquote",[s("p",[t._v("老师我想问下 Vite 是怎么保证 dev 环境和生产环境，最后得到的结果是一样的啊，会不会出现 dev 看到的是一种现象，生产环境看到的是另一种现象还有如果我同时 import 两个 js 文件，这两个文件的加载执行顺序会有先后吗？是必须前一个加载完成后，才会去 import 另外一个吗？")])]),t._v(" "),s("h6",{attrs:{id:"讲师回复"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#讲师回复"}},[t._v("#")]),t._v("     讲师回复")]),t._v(" "),s("blockquote",[s("p",[t._v("    不是的，请求不一定是串行关系，这个可以自己动手试验一下")])]),t._v(" "),s("h5",{attrs:{id:"龙-2"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#龙-2"}},[t._v("#")]),t._v(" **龙")]),t._v(" "),s("blockquote",[s("p",[t._v("老师我有几个疑惑点 1 Vite 是怎么保证本地环境运行出的结果和最后生产环境是一致的啊 2 我在一个 js 文件中，同时有两个 import，这个 js 就会导致发送两个请求，是不是只有等一个请求发送接收到返回以后，才回去发送下一个请求，是一种同步的行为")])]),t._v(" "),s("h6",{attrs:{id:"讲师回复-2"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#讲师回复-2"}},[t._v("#")]),t._v("     讲师回复")]),t._v(" "),s("blockquote",[s("p",[t._v("    不是的，请求不一定是串行关系，这个可以自己动手试验一下")])]),t._v(" "),s("h5",{attrs:{id:"勇"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#勇"}},[t._v("#")]),t._v(" **勇")]),t._v(" "),s("blockquote",[s("p",[s("a",{attrs:{href:"mailto:vite@2.x"}},[t._v("vite@2.x")]),t._v("不使用 koa 来创建服务和管理中间件了，而是使用 connect。是处于什么考虑呢？TJ 不维护 Koa 了哇")])]),t._v(" "),s("h6",{attrs:{id:"讲师回复-3"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#讲师回复-3"}},[t._v("#")]),t._v("     讲师回复")]),t._v(" "),s("blockquote",[s("p",[t._v("    这是目前看到最好的问题之一，不过提问者应该更进一步，提升自己解决问题，找到答案的能力。具体原因在 "),s("a",{attrs:{href:"https://github.com/vitejs/vite/blob/91dbb017091c175a54bcd1c93a69f8458d1bde8d/docs/guide/migration.md#for-plugin-authors",target:"_blank",rel:"noopener noreferrer"}},[t._v("https://github.com/vitejs/vite/blob/91dbb017091c175a54bcd1c93a69f8458d1bde8d/docs/guide/migration.md#for-plugin-authors"),s("OutboundLink")],1),t._v(" 中有所体现了其实，简单总结一下是 "),s("a",{attrs:{href:"mailto:vite@2.x"}},[t._v("vite@2.x")]),t._v(" 主要是用基于 hooks 的插件，对于 koa 中间件的需求大幅度减少，从依赖成本上看，old school 的 connect 即可方便轻巧满足需求了")])]),t._v(" "),s("h5",{attrs:{id:"锋"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#锋"}},[t._v("#")]),t._v(" *锋")]),t._v(" "),s("blockquote",[s("p",[t._v("什么时候更新呀")])]),t._v(" "),s("h6",{attrs:{id:"编辑回复"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#编辑回复"}},[t._v("#")]),t._v("     编辑回复")]),t._v(" "),s("blockquote",[s("p",[t._v("    每周一、三更新哈~")])]),t._v(" "),s("h5",{attrs:{id:"_8621"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_8621"}},[t._v("#")]),t._v(" **8621")]),t._v(" "),s("blockquote",[s("p",[t._v("第一个提出 bundleless 理念的人，绝对是十分善于思考的人。")])]),t._v(" "),s("h5",{attrs:{id:"勇-2"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#勇-2"}},[t._v("#")]),t._v(" **勇")]),t._v(" "),s("blockquote",[s("p",[t._v("SnowPack 和 Vite 的区别主要是对打包的处理吗？Vite 是使用 Rollup 来 build，Vite 还是使用 Webpack 来完成 build。后续会对这两者的区别展开讲解吗？")])]),t._v(" "),s("h6",{attrs:{id:"讲师回复-4"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#讲师回复-4"}},[t._v("#")]),t._v("     讲师回复")]),t._v(" "),s("blockquote",[s("p",[t._v("    对于 SnowPack 和 Vite 的发展路线其实是比较有趣的话题，也会随着时间演进有所变化。可以与我保持联系，随时沟通")])]),t._v(" "),s("h5",{attrs:{id:"_0231"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_0231"}},[t._v("#")]),t._v(" **0231")]),t._v(" "),s("blockquote",[s("p",[t._v("大佬太强了，大佬是参考了相关文章进行的学习，还是直接梳理源码进行的分析")])]),t._v(" "),s("h6",{attrs:{id:"讲师回复-5"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#讲师回复-5"}},[t._v("#")]),t._v("     讲师回复")]),t._v(" "),s("blockquote",[s("p",[t._v("    知识获取方式：看源码，看官网，去 github 提 issue/pr，多参与国际社区讨论，国内毕竟面比较有限")])]),t._v(" "),s("h5",{attrs:{id:"贤"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#贤"}},[t._v("#")]),t._v(" **贤")]),t._v(" "),s("blockquote",[s("p",[t._v("学到了, 都没听说过 Vite, 我是不是太菜了 😂")])]),t._v(" "),s("h6",{attrs:{id:"编辑回复-2"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#编辑回复-2"}},[t._v("#")]),t._v("     编辑回复")]),t._v(" "),s("blockquote",[s("p",[t._v("    不是哦，学习是个持久的过程，每个知识都是从无到有。现在掌握也不晚呐~")])]),t._v(" "),s("h5",{attrs:{id:"cxl"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#cxl"}},[t._v("#")]),t._v(" cxl")]),t._v(" "),s("blockquote",[s("p",[t._v("请问下老师，react 有 bundless 吗")])]),t._v(" "),s("h6",{attrs:{id:"讲师回复-6"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#讲师回复-6"}},[t._v("#")]),t._v("     讲师回复")]),t._v(" "),s("blockquote",[s("p",[t._v("    有的，vite 可以改造支持，另外建议找一下 snowpack 的 react 方案")])])])}),[],!1,null,null,null);s.default=n.exports}}]);