(window.webpackJsonp=window.webpackJsonp||[]).push([[163],{501:function(a,t,s){"use strict";s.r(t);var e=s(4),n=Object(e.a)({},(function(){var a=this,t=a._self._c;return t("ContentSlotsDistributor",{attrs:{"slot-key":a.$parent.slotKey}},[t("p",{attrs:{"data-nodeid":"7591"}},[a._v("前端生态有着与生俱来的混乱和与之抗衡的秩序，有着新生力量的崛起以及随之而来的规范约束。在这个背景下，正面来看，欣欣向荣的前端生态带来了广阔的发展前景，但也造成了一些困扰。比如，我们都经历过在前端基础设施建设中，被各种冗杂的配置项困扰，一不小心就是 Error，步履蹒跚。也许我们可以通过搜索引擎暂时解决问题，但是恍恍惚惚、难以洞悉问题本源。")]),a._v(" "),t("p",{attrs:{"data-nodeid":"7592"}},[a._v("另一方面，前端生态的重要一环是公共库。公共库的模块化规范、编译标准，甚至压缩方式都有讲究，同时公共库与使用它们的业务项目也要密切配合，这样才能打造一个顺滑的基建结果。请你仔细审视手上的项目，编译构建过程是否做到了最高效，产出代码是否达到了最高级别的安全保障，是否做到了性能体验的最佳实践？")]),a._v(" "),t("p",{attrs:{"data-nodeid":"7593"}},[a._v("这一讲，就让我们从公共库的角度出发，梳理当前前端生态，最终还原一个趋近完美的公共库设计标准。")]),a._v(" "),t("h3",{attrs:{"data-nodeid":"7594"}},[a._v("从一个公共库处理的问题，谈如何做好“扫雷人”")]),a._v(" "),t("p",{attrs:{"data-nodeid":"7595"}},[a._v("这一部分，让我们以一篇网红文章“"),t("a",{attrs:{href:"https://juejin.im/post/6856815533749338125","data-nodeid":"7749"}},[a._v("报告老板，我们的 H5 页面在 iOS 11 系统上白屏了！")]),a._v("”开始，我先简单梳理和总结一下文章内容：")]),a._v(" "),t("ul",{attrs:{"data-nodeid":"7596"}},[t("li",{attrs:{"data-nodeid":"7597"}},[t("p",{attrs:{"data-nodeid":"7598"}},[a._v("笔者发现某些机型上出现页面白屏情况；")])]),a._v(" "),t("li",{attrs:{"data-nodeid":"7599"}},[t("p",{attrs:{"data-nodeid":"7600"}},[a._v("出现在报错页面上的信息非常明显，即当前浏览器不支持"),t("code",{attrs:{"data-backticks":"1","data-nodeid":"7753"}},[a._v("...")]),a._v("扩展运算符；")])]),a._v(" "),t("li",{attrs:{"data-nodeid":"7601"}},[t("p",{attrs:{"data-nodeid":"7602"}},[a._v("出错的代码（使用了扩展运算符的代码）属于某个公共库代码，它没有使用 Babel 插件进行降级处理，因此线上源代码出现了"),t("code",{attrs:{"data-backticks":"1","data-nodeid":"7756"}},[a._v("...")]),a._v("扩展运算符。")])])]),a._v(" "),t("p",{attrs:{"data-nodeid":"7603"}},[a._v("现在问题找到了，或许直接将出现问题的公共库代码用 Babel 进行编译降级就可以了，但问题似乎还会更加复杂。在文中环境下，需要在"),t("code",{attrs:{"data-backticks":"1","data-nodeid":"7759"}},[a._v("vue.config.js")]),a._v("中加入对问题公共库"),t("code",{attrs:{"data-backticks":"1","data-nodeid":"7761"}},[a._v("module-name/library-name")]),a._v("的 Babel 编译流程：")]),a._v(" "),t("pre",{staticClass:"lang-java",attrs:{"data-nodeid":"7604"}},[t("code",{attrs:{"data-language":"java"}},[a._v("transpileDependencies: [\n  "),t("span",{staticClass:"hljs-string"},[a._v("'module-name/library-name'")]),a._v(" "),t("span",{staticClass:"hljs-comment"},[a._v("// 出现问题的那个库")]),a._v("\n],\n")])]),a._v(" "),t("p",{attrs:{"data-nodeid":"7605"}},[a._v("vue-cli 对"),t("a",{attrs:{href:"https://cli.vuejs.org/zh/config/#transpiledependencies","data-nodeid":"7766"}},[a._v("transpileDependencies")]),a._v(" 也有如下说明：")]),a._v(" "),t("blockquote",{attrs:{"data-nodeid":"7606"}},[t("p",{attrs:{"data-nodeid":"7607"}},[a._v("默认情况下 babel-loader 会忽略所有"),t("code",{attrs:{"data-backticks":"1","data-nodeid":"7769"}},[a._v("node_modules")]),a._v("中的文件。如果你想要通过 Babel 显式转译一个依赖，可以在这个选项中列出来。")])]),a._v(" "),t("p",{attrs:{"data-nodeid":"7608"}},[a._v("按照上述操作，却得到了新的报错："),t("code",{attrs:{"data-backticks":"1","data-nodeid":"7772"}},[a._v("Uncaught TypeError: Cannot assign to read only property 'exports' of object '#<Object>'")]),a._v("。究其原因，"),t("code",{attrs:{"data-backticks":"1","data-nodeid":"7774"}},[a._v("module-name/library-name")]),a._v("这个库对外输出的是 CommonJS 类型源码，而项目基础设施中 babel-transform-runtime 在编译时增加的 helper 代码，使用的是 import 引入。"),t("strong",{attrs:{"data-nodeid":"7780"}},[a._v("最终编译结果出现了 ESM 包含 CommonJS 的情况，是不会被 Webpack 处理的")]),a._v("。")]),a._v(" "),t("p",{attrs:{"data-nodeid":"7609"}},[a._v("出现问题的原因总结如下：")]),a._v(" "),t("ul",{attrs:{"data-nodeid":"7610"}},[t("li",{attrs:{"data-nodeid":"7611"}},[t("p",{attrs:{"data-nodeid":"7612"}},[a._v("plugin-transform-runtime 会根据 sourceType 选择注入 import 或者 require，sourceType 的默认值是 module，就会默认注入 import；")])]),a._v(" "),t("li",{attrs:{"data-nodeid":"7613"}},[t("p",{attrs:{"data-nodeid":"7614"}},[a._v("Webpack 不会处理包含 import/export 的文件中的 module.exports 导出，所以需要让 Babel 自动判断 sourceType，根据文件内是否存在 import/export 来决定注入什么样的代码。")])])]),a._v(" "),t("p",{attrs:{"data-nodeid":"7615"}},[a._v("为了适配上述问题，Babel 设置了"),t("code",{attrs:{"data-backticks":"1","data-nodeid":"7785"}},[a._v("sourceType")]),a._v("属性，"),t("code",{attrs:{"data-backticks":"1","data-nodeid":"7787"}},[a._v("sourceType：unambiguous")]),a._v("表示 Babel 会根据文件上下文（比如是否含有 import/export）来决定是否按照 ESM 语法处理文件。")]),a._v(" "),t("p",{attrs:{"data-nodeid":"7616"}},[a._v("这时候就需要配置 Babel 内容了：")]),a._v(" "),t("pre",{staticClass:"lang-java",attrs:{"data-nodeid":"7617"}},[t("code",{attrs:{"data-language":"java"}},[t("span",{staticClass:"hljs-keyword"},[a._v("module")]),a._v("."),t("span",{staticClass:"hljs-keyword"},[a._v("exports")]),a._v(" = {\n  ...  "),t("span",{staticClass:"hljs-comment"},[a._v("// 省略的配置")]),a._v("\n  sourceType: "),t("span",{staticClass:"hljs-string"},[a._v("'unambiguous'")]),a._v(",\n  ...  "),t("span",{staticClass:"hljs-comment"},[a._v("// 省略的配置")]),a._v("\n}\n")])]),a._v(" "),t("p",{attrs:{"data-nodeid":"7618"}},[a._v("但是这种做法在工程上并不推荐，上述更改方式对所有编译文件都生效，但也"),t("strong",{attrs:{"data-nodeid":"7801"}},[a._v("增加了编译成本")]),a._v("（因为设置"),t("code",{attrs:{"data-backticks":"1","data-nodeid":"7795"}},[a._v("sourceType：unambiguous")]),a._v("后，编译时需要做的事情更多），还有个"),t("a",{attrs:{href:"https://babeljs.io/docs/en/options#sourcetype","data-nodeid":"7799"}},[a._v("潜在问题")]),a._v("：")]),a._v(" "),t("blockquote",{attrs:{"data-nodeid":"7619"}},[t("p",{attrs:{"data-nodeid":"7620"}},[a._v("Unambiguous can be quite useful in contexts where the type is unknown, but it can lead to false matches because it's perfectly valid to have a module file that does not use import/export statements.")])]),a._v(" "),t("p",{attrs:{"data-nodeid":"7621"}},[a._v("翻译过来，就是说并不是所有的 ESM 模块（这里指使用 ESNext 特性的文件）都含有 import/export，因此即便某个待编译文件属于 ESM 模块，也可能被 Babel 错误地判断为 CommonJS 模块而引发误判。")]),a._v(" "),t("p",{attrs:{"data-nodeid":"7622"}},[a._v("基于这一点，一个更合适的做法是：只对目标第三方库"),t("code",{attrs:{"data-backticks":"1","data-nodeid":"7807"}},[a._v("'module-name/library-name'")]),a._v("使用"),t("code",{attrs:{"data-backticks":"1","data-nodeid":"7809"}},[a._v("sourceType：unambiguous")]),a._v("，这时，Babel "),t("a",{attrs:{href:"https://babeljs.io/docs/en/options#overrides","data-nodeid":"7813"}},[a._v("overrides 属性")]),a._v("就派上用场了：")]),a._v(" "),t("blockquote",{attrs:{"data-nodeid":"7623"}},[t("p",{attrs:{"data-nodeid":"7624"}},[a._v('Allows users to provide an array of options that will be merged into the current configuration one at a time. This feature is best used alongside the "test"/"include"/"exclude" options to provide conditions for which an override should apply.')])]),a._v(" "),t("p",{attrs:{"data-nodeid":"7625"}},[a._v("具体使用方式：")]),a._v(" "),t("pre",{staticClass:"lang-java",attrs:{"data-nodeid":"7626"}},[t("code",{attrs:{"data-language":"java"}},[t("span",{staticClass:"hljs-keyword"},[a._v("module")]),a._v("."),t("span",{staticClass:"hljs-keyword"},[a._v("exports")]),a._v(" = {\n\t...  "),t("span",{staticClass:"hljs-comment"},[a._v("// 省略的配置")]),a._v("\n\toverrides: [\n\t\t{ include: "),t("span",{staticClass:"hljs-string"},[a._v("'./node_modules/module-name/library-name/name.common.js'")]),a._v(",  "),t("span",{staticClass:"hljs-comment"},[a._v("// 使用的第三方库")]),a._v("\n\t\tsourceType: "),t("span",{staticClass:"hljs-string"},[a._v("'unambiguous'")]),a._v("\n\t\t}\n\t], \n\t ...  "),t("span",{staticClass:"hljs-comment"},[a._v("// 省略的配置")]),a._v("\n};\n")])]),a._v(" "),t("p",{attrs:{"data-nodeid":"7627"}},[a._v("至此，这个“iOS 11 系统白屏”问题就算告一段落了。我整理了解决路线，如下图所示：")]),a._v(" "),t("p",{attrs:{"data-nodeid":"7628"}},[t("img",{attrs:{src:"https://s0.lgstatic.com/i/image2/M01/04/A5/CgpVE1_0NWKAaju0AAMFDVpRq7Y221.png",alt:"Lark20210105-174532.png","data-nodeid":"7832"}})]),a._v(" "),t("p",{attrs:{"data-nodeid":"7629"}},[a._v("我们回过头再来看这个问题，实际上"),t("strong",{attrs:{"data-nodeid":"7838"}},[a._v("业务方对线上测试回归不彻底")]),a._v("是造成问题的直接原因，但问题其实出现在一个公共库上，因而前端生态的混乱和复杂也许是更本质的原因。这里涉及两方面问题：")]),a._v(" "),t("ul",{attrs:{"data-nodeid":"7630"}},[t("li",{attrs:{"data-nodeid":"7631"}},[t("p",{attrs:{"data-nodeid":"7632"}},[a._v("作为公共库，我应该如何构建编译代码，让业务方更有保障地使用？")])]),a._v(" "),t("li",{attrs:{"data-nodeid":"7633"}},[t("p",{attrs:{"data-nodeid":"7634"}},[a._v("作为使用者，我应该如何处理第三方公共库，是否还需要对其进行额外编译和处理？")])])]),a._v(" "),t("p",{attrs:{"data-nodeid":"7635"}},[a._v("被动地发现问题、解决问题只会让我们被“牵着鼻子走”——这不是我们的目的。我们应该从更底层拆解问题，下面我们就来看看更底层的内容。")]),a._v(" "),t("h3",{attrs:{"data-nodeid":"7636"}},[a._v("应用项目构建和公共库构建的差异")]),a._v(" "),t("p",{attrs:{"data-nodeid":"7637"}},[a._v("首先我们要认清应用项目构建和公共库构建的差别。作为前端团队，我们构建了很多应用项目，对于一个应用项目来说，“只要能在需要兼容的环境中跑起来”就达到了基本目的。而对于一个公共库来说，我们的公共库可能被各种环境所引用或需要支持各种兼容需求，因此"),t("strong",{attrs:{"data-nodeid":"7848"}},[a._v("公共库就要兼顾性能和易用性，要注重质量和广泛度")]),a._v("。由此看来，公共库理论上构建机制就更加复杂。")]),a._v(" "),t("p",{attrs:{"data-nodeid":"7638"}},[a._v("说到底，如果你能够设计好一个公共库，那么通常也能使用好一个公共库。因此，下面我们重点讨论如何设计并产出一个企业级公共库，以及如何在业务中更好地配合使用。")]),a._v(" "),t("h3",{attrs:{"data-nodeid":"7639"}},[a._v("制定一个企业级公共库的设计原则")]),a._v(" "),t("p",{attrs:{"data-nodeid":"7640"}},[a._v("这里说的企业级公共库主要是指在企业内复用的公共库，它可以被发布到 npm 上进行社区共享，也可以在企业内的私有 npm 中限定范围地共享。总之，企业级公共库是需要在业务中被使用的。我认为一个企业级公共库的设计原则应该包括以下几点。")]),a._v(" "),t("ol",{attrs:{"data-nodeid":"7641"}},[t("li",{attrs:{"data-nodeid":"7642"}},[t("p",{attrs:{"data-nodeid":"7643"}},[t("strong",{attrs:{"data-nodeid":"7856"}},[a._v("对于开发者共创公共库，最大化确保开发体验")]),a._v("：")])])]),a._v(" "),t("ul",{attrs:{"data-nodeid":"7644"}},[t("li",{attrs:{"data-nodeid":"7645"}},[t("p",{attrs:{"data-nodeid":"7646"}},[a._v("最快地搭建调试和开发环境")])]),a._v(" "),t("li",{attrs:{"data-nodeid":"7647"}},[t("p",{attrs:{"data-nodeid":"7648"}},[a._v("安全地发版维护")])])]),a._v(" "),t("ol",{attrs:{start:"2","data-nodeid":"7649"}},[t("li",{attrs:{"data-nodeid":"7650"}},[t("p",{attrs:{"data-nodeid":"7651"}},[t("strong",{attrs:{"data-nodeid":"7863"}},[a._v("对于使用者，最大化确保使用体验")]),a._v("：")])])]),a._v(" "),t("ul",{attrs:{"data-nodeid":"7652"}},[t("li",{attrs:{"data-nodeid":"7653"}},[t("p",{attrs:{"data-nodeid":"7654"}},[a._v("公共库文档建设完善")])]),a._v(" "),t("li",{attrs:{"data-nodeid":"7655"}},[t("p",{attrs:{"data-nodeid":"7656"}},[a._v("公共库质量有保障")])]),a._v(" "),t("li",{attrs:{"data-nodeid":"7657"}},[t("p",{attrs:{"data-nodeid":"7658"}},[a._v("接入和使用负担最小")])])]),a._v(" "),t("p",{attrs:{"data-nodeid":"7659"}},[a._v("基于上述原则，在团队里，设计一个公共库前，你需要考虑：")]),a._v(" "),t("ul",{attrs:{"data-nodeid":"7660"}},[t("li",{attrs:{"data-nodeid":"7661"}},[t("p",{attrs:{"data-nodeid":"7662"}},[a._v("自研公共库还是使用社区已有轮子；")])]),a._v(" "),t("li",{attrs:{"data-nodeid":"7663"}},[t("p",{attrs:{"data-nodeid":"7664"}},[a._v("公共库的运行环境是什么，这将决定公共库的编译构建目标；")])]),a._v(" "),t("li",{attrs:{"data-nodeid":"7665"}},[t("p",{attrs:{"data-nodeid":"7666"}},[a._v("公共库是偏向业务还是业务 free，这将决定公共库的职责和边界。")])])]),a._v(" "),t("p",{attrs:{"data-nodeid":"7667"}},[a._v("上述内容并非纯理论原则，而是直接决定了公共库实现的技术选型。比如，为了实现更完善的文档建设，尤其是 UI 组件类文档，可以考虑部署静态组件展示站点，进行组件展示以及用法说明。更智能、工程化的内容，我们可以考虑使用类似 "),t("a",{attrs:{href:"https://github.com/jsdoc/jsdoc","data-nodeid":"7874"}},[a._v("JSDoc")]),a._v(" 来实现 JavaScript API 文档生成，组件类公共库可以考虑 "),t("a",{attrs:{href:"https://storybook.js.org/","data-nodeid":"7878"}},[a._v("Storybook")]),a._v(" 或者 "),t("a",{attrs:{href:"http://styleguides.io/","data-nodeid":"7882"}},[a._v("Styleguides")]),a._v(" 作为标准接入方案。")]),a._v(" "),t("p",{attrs:{"data-nodeid":"7668"}},[a._v("再比如，我们的"),t("strong",{attrs:{"data-nodeid":"7889"}},[a._v("公共库适配环境")]),a._v("是什么？一般来讲可能需要兼容：浏览器/Node.js/同构环境等。不同环境对应了不同的编译和打包标准，这就需要你进行思考：如果目标是浏览器环境，那么如何才能充分实现性能最优解？如帮助业务方实现 tree-shaking 等优化技术。")]),a._v(" "),t("p",{attrs:{"data-nodeid":"7669"}},[a._v("同时，为了减轻业务使用负担，作为企业级公共库，以及对应使用这些企业级公共库的应用项目，可以指定标准规范的 babel-preset，保证编译产出的统一。这样一来，业务项目（即使用公共库方）可以以统一的接入标准引入。")]),a._v(" "),t("p",{attrs:{"data-nodeid":"7670"}},[a._v("下面是我基于对目前前端生态的理解，草拟的一份 babel-preset（该 preset 设计方案具有时效性）。请继续阅读下文，我们来对 @lucas/babel-preset 一探究竟。")]),a._v(" "),t("h3",{attrs:{"data-nodeid":"7671"}},[a._v("制定一个统一标准化 babel-preset")]),a._v(" "),t("p",{attrs:{"data-nodeid":"7672"}},[a._v("企业中，所有公共库或应用项目都使用一套 @lucas/babel-xxx-preset，按照 @lucas/babel-xxx-preset 的编译要求进行编译，这样业务使用时，接入标准统一。")]),a._v(" "),t("p",{attrs:{"data-nodeid":"7673"}},[a._v("原则上讲，这样的统一化能够有效避免本文开头的“线上问题”。同时这个 @lucas/babel-preset 应该能够适应各种项目需求，比如使用 TypeScript/Flow 等扩展语法的项目。")]),a._v(" "),t("p",{attrs:{"data-nodeid":"7674"}},[a._v("这里给出一份设计方案，供你参考和讨论。")]),a._v(" "),t("ol",{attrs:{"data-nodeid":"7675"}},[t("li",{attrs:{"data-nodeid":"7676"}},[t("p",{attrs:{"data-nodeid":"7677"}},[a._v("支持 NODE_ENV = 'development' | 'production' | 'test' 三种环境，并有对应的优化。")])]),a._v(" "),t("li",{attrs:{"data-nodeid":"7678"}},[t("p",{attrs:{"data-nodeid":"7679"}},[a._v("配置插件默认不开启 Babel"),t("code",{attrs:{"data-backticks":"1","data-nodeid":"7916"}},[a._v("loose: true")]),a._v("配置，让插件的行为尽可能地遵循规范，但对有较严重性能损耗或有兼容性问题的情况保留修改入口。")])]),a._v(" "),t("li",{attrs:{"data-nodeid":"7680"}},[t("p",{attrs:{"data-nodeid":"7681"}},[a._v("这份设计方案落地后产出，应该"),t("strong",{attrs:{"data-nodeid":"7923"}},[a._v("支持应用编译和公共库编译")]),a._v("，即可以按照 @lucas/babel-preset/app，@lucas/babel-preset/dependencies 和 @lucas/babel-preset/library，@lucas/babel-preset/library/compact 进行区分使用（具体不同预设集合的角色，下面会详细展开）。")])])]),a._v(" "),t("p",{attrs:{"data-nodeid":"7682"}},[a._v("@lucas/babel-preset/app，@lucas/babel-preset/dependencies 都可以作为编译应用项目的预设使用，但他们也有所差别，具体如下：")]),a._v(" "),t("ul",{attrs:{"data-nodeid":"7683"}},[t("li",{attrs:{"data-nodeid":"7684"}},[t("p",{attrs:{"data-nodeid":"7685"}},[a._v("@lucas/babel-preset/app 负责编译除"),t("code",{attrs:{"data-backticks":"1","data-nodeid":"7926"}},[a._v("node_modules")]),a._v("外的业务代码；")])]),a._v(" "),t("li",{attrs:{"data-nodeid":"7686"}},[t("p",{attrs:{"data-nodeid":"7687"}},[a._v("@lucas/babel-preset/dependencies 编译"),t("code",{attrs:{"data-backticks":"1","data-nodeid":"7929"}},[a._v("node_modules")]),a._v("第三方代码；")])]),a._v(" "),t("li",{attrs:{"data-nodeid":"7688"}},[t("p",{attrs:{"data-nodeid":"7689"}},[a._v("@lucas/babel-preset/library 和 @lucas/babel-preset/library/compact 作为编译公共库使用的预设，他们也有所差别，@lucas/babel-preset/library 按照当前 Node 环境编译输出代码，而 @lucas/babel-preset/library/compact 会编译降级为 ES5。")])])]),a._v(" "),t("ol",{attrs:{start:"4","data-nodeid":"7690"}},[t("li",{attrs:{"data-nodeid":"7691"}},[t("p",{attrs:{"data-nodeid":"7692"}},[a._v("对于企业级公共库，建议使用标准 ES 特性发布；对 tree-shaking 有强烈需求的库，应同时发布 ES module 格式代码。")])]),a._v(" "),t("li",{attrs:{"data-nodeid":"7693"}},[t("p",{attrs:{"data-nodeid":"7694"}},[a._v("对于企业级公共库，发布的代码不包含 polyfills，由使用方统一处理。")])]),a._v(" "),t("li",{attrs:{"data-nodeid":"7695"}},[t("p",{attrs:{"data-nodeid":"7696"}},[a._v("对于应用编译，使用 @babel/preset-env 同时编译应用代码与第三方库代码。")])]),a._v(" "),t("li",{attrs:{"data-nodeid":"7697"}},[t("p",{attrs:{"data-nodeid":"7698"}},[a._v("对于应用编译，需要对"),t("code",{attrs:{"data-backticks":"1","data-nodeid":"7936"}},[a._v("node_modules")]),a._v("进行编译，并且为"),t("code",{attrs:{"data-backticks":"1","data-nodeid":"7938"}},[a._v("node_modules")]),a._v("配置"),t("code",{attrs:{"data-backticks":"1","data-nodeid":"7940"}},[a._v("sourceType: 'unambiguous'")]),a._v("，以确保第三方依赖包中的 CommonJS 模块能够被正确处理。")])]),a._v(" "),t("li",{attrs:{"data-nodeid":"7699"}},[t("p",{attrs:{"data-nodeid":"7700"}},[a._v("对于应用编译，启用 plugin-transform-runtime，避免同样的 helper 代码被重复注入多个文件，以缩减打包后文件的体积。同时自动注入 regenerator-runtime，避免污染全局变量。")])]),a._v(" "),t("li",{attrs:{"data-nodeid":"7701"}},[t("p",{attrs:{"data-nodeid":"7702"}},[a._v("注入绝对路径引用的 @babel/runtime 包中对应的 helper，以确保能够引用到正确版本的 @babel/runtime 包中的文件。")])])]),a._v(" "),t("p",{attrs:{"data-nodeid":"7703"}},[a._v("此外，第三方库可能通过 dependencies 依赖自己的 @babel/runtime，而 @babel/runtime 不同版本之间不能确保兼容 (比如 6.x 和 7.x 之间)，这就需要确保我们为"),t("code",{attrs:{"data-backticks":"1","data-nodeid":"7945"}},[a._v("node_modules")]),a._v("内代码经过 Babel 编译注入 runtime 时使用正确路径的 @babel/runtime 包。")]),a._v(" "),t("p",{attrs:{"data-nodeid":"7704"}},[a._v("基于以上设计，对于 CSR 应用的 Babel 编译流程，预计业务方使用预设为：")]),a._v(" "),t("pre",{staticClass:"lang-java",attrs:{"data-nodeid":"7705"}},[t("code",{attrs:{"data-language":"java"}},[t("span",{staticClass:"hljs-comment"},[a._v("// webpack.config.js")]),a._v("\n"),t("span",{staticClass:"hljs-keyword"},[a._v("module")]),a._v("."),t("span",{staticClass:"hljs-keyword"},[a._v("exports")]),a._v(" = {\n  presets: ["),t("span",{staticClass:"hljs-string"},[a._v("'@lucas/babel-preset/app'")]),a._v("],\n}\n"),t("span",{staticClass:"hljs-comment"},[a._v("// 相关 webpack 配置")]),a._v("\n"),t("span",{staticClass:"hljs-keyword"},[a._v("module")]),a._v("."),t("span",{staticClass:"hljs-keyword"},[a._v("exports")]),a._v(" = {\n  "),t("span",{staticClass:"hljs-keyword"},[a._v("module")]),a._v(": {\n    rules: [\n      {\n        test: /\\.js$/,\n        oneOf: [\n          {\n            exclude: /node_modules/,\n            loader: "),t("span",{staticClass:"hljs-string"},[a._v("'babel-loader'")]),a._v(",\n            options: {\n              cacheDirectory: "),t("span",{staticClass:"hljs-keyword"},[a._v("true")]),a._v(",\n            },\n          },\n          {\n            loader: "),t("span",{staticClass:"hljs-string"},[a._v("'babel-loader'")]),a._v(",\n            options: {\n              cacheDirectory: "),t("span",{staticClass:"hljs-keyword"},[a._v("true")]),a._v(",\n              configFile: "),t("span",{staticClass:"hljs-keyword"},[a._v("false")]),a._v(",\n              "),t("span",{staticClass:"hljs-comment"},[a._v("// 使用我们的 preset")]),a._v("\n              presets: ["),t("span",{staticClass:"hljs-string"},[a._v("'@lucas/babel-preset/dependencies'")]),a._v("],\n              compact: "),t("span",{staticClass:"hljs-keyword"},[a._v("false")]),a._v(",\n            },\n          },\n        ],\n      },\n    ],\n  },\n}\n")])]),a._v(" "),t("p",{attrs:{"data-nodeid":"7706"}},[a._v("我们可以看到，上述使用方式按照"),t("code",{attrs:{"data-backticks":"1","data-nodeid":"7949"}},[a._v("node_modules")]),a._v("进行了区分，对于"),t("code",{attrs:{"data-backticks":"1","data-nodeid":"7951"}},[a._v("node_modules")]),a._v("我们开启 cacheDirectory 缓存。对于应用，我们直接使用 babel-loader 进行编译，并使用"),t("code",{attrs:{"data-backticks":"1","data-nodeid":"7953"}},[a._v("@lucas/babel-preset/dependencies")]),a._v("这个 Babel preset，其内容为：")]),a._v(" "),t("pre",{staticClass:"lang-java",attrs:{"data-nodeid":"7707"}},[t("code",{attrs:{"data-language":"java"}},[t("span",{staticClass:"hljs-keyword"},[a._v("const")]),a._v(" path = require("),t("span",{staticClass:"hljs-string"},[a._v("'path'")]),a._v(")\n"),t("span",{staticClass:"hljs-keyword"},[a._v("const")]),a._v(" {declare} = require("),t("span",{staticClass:"hljs-string"},[a._v("'@babel/helper-plugin-utils'")]),a._v(")\n"),t("span",{staticClass:"hljs-keyword"},[a._v("const")]),a._v(" getAbsoluteRuntimePath = () => {\n  "),t("span",{staticClass:"hljs-keyword"},[a._v("return")]),a._v(" path.dirname(require.resolve("),t("span",{staticClass:"hljs-string"},[a._v("'@babel/runtime/package.json'")]),a._v("))\n}\n"),t("span",{staticClass:"hljs-keyword"},[a._v("module")]),a._v("."),t("span",{staticClass:"hljs-keyword"},[a._v("exports")]),a._v(" = ({\n  targets,\n  ignoreBrowserslistConfig = "),t("span",{staticClass:"hljs-keyword"},[a._v("false")]),a._v(",\n  forceAllTransforms = "),t("span",{staticClass:"hljs-keyword"},[a._v("false")]),a._v(",\n  transformRuntime = "),t("span",{staticClass:"hljs-keyword"},[a._v("true")]),a._v(",\n  absoluteRuntime = "),t("span",{staticClass:"hljs-keyword"},[a._v("false")]),a._v(",\n  supportsDynamicImport = "),t("span",{staticClass:"hljs-keyword"},[a._v("false")]),a._v(",\n} = {}) => {\n  "),t("span",{staticClass:"hljs-keyword"},[a._v("return")]),a._v(" declare(\n    (\n      api,\n      {modules = "),t("span",{staticClass:"hljs-string"},[a._v("'auto'")]),a._v(", absoluteRuntimePath = getAbsoluteRuntimePath()},\n    ) => {\n      api.assertVersion("),t("span",{staticClass:"hljs-number"},[a._v("7")]),a._v(")\n      "),t("span",{staticClass:"hljs-comment"},[a._v("// 返回配置内容")]),a._v("\n      "),t("span",{staticClass:"hljs-keyword"},[a._v("return")]),a._v(" {\n        "),t("span",{staticClass:"hljs-comment"},[a._v("// https://github.com/webpack/webpack/issues/4039#issuecomment-419284940")]),a._v("\n        sourceType: "),t("span",{staticClass:"hljs-string"},[a._v("'unambiguous'")]),a._v(",\n        exclude: /"),t("span",{staticClass:"hljs-meta"},[a._v("@babel")]),a._v("\\/runtime/,\n        presets: [\n          [\n            require("),t("span",{staticClass:"hljs-string"},[a._v("'@babel/preset-env'")]),a._v(")."),t("span",{staticClass:"hljs-keyword"},[a._v("default")]),a._v(",\n            {\n              "),t("span",{staticClass:"hljs-comment"},[a._v("// 统一 @babel/preset-env 配置")]),a._v("\n              useBuiltIns: "),t("span",{staticClass:"hljs-keyword"},[a._v("false")]),a._v(",\n              modules,\n              targets,\n              ignoreBrowserslistConfig,\n              forceAllTransforms,\n              exclude: ["),t("span",{staticClass:"hljs-string"},[a._v("'transform-typeof-symbol'")]),a._v("],\n            },\n          ],\n        ],\n        plugins: [\n          transformRuntime && [\n            require("),t("span",{staticClass:"hljs-string"},[a._v("'@babel/plugin-transform-runtime'")]),a._v(")."),t("span",{staticClass:"hljs-keyword"},[a._v("default")]),a._v(",\n            {\n              absoluteRuntime: absoluteRuntime ? absoluteRuntimePath : "),t("span",{staticClass:"hljs-keyword"},[a._v("false")]),a._v(",\n            },\n          ],\n          require("),t("span",{staticClass:"hljs-string"},[a._v("'@babel/plugin-syntax-dynamic-import'")]),a._v(")."),t("span",{staticClass:"hljs-keyword"},[a._v("default")]),a._v(",\n          !supportsDynamicImport &&\n            !api.caller(caller => caller && caller.supportsDynamicImport) &&\n            require("),t("span",{staticClass:"hljs-string"},[a._v("'babel-plugin-dynamic-import-node'")]),a._v("),\n          [\n            require("),t("span",{staticClass:"hljs-string"},[a._v("'@babel/plugin-proposal-object-rest-spread'")]),a._v(")."),t("span",{staticClass:"hljs-keyword"},[a._v("default")]),a._v(",\n            {loose: "),t("span",{staticClass:"hljs-keyword"},[a._v("true")]),a._v(", useBuiltIns: "),t("span",{staticClass:"hljs-keyword"},[a._v("true")]),a._v("},\n          ],\n        ].filter(Boolean),\n        env: {\n          test: {\n            presets: [\n              [\n                require("),t("span",{staticClass:"hljs-string"},[a._v("'@babel/preset-env'")]),a._v(")."),t("span",{staticClass:"hljs-keyword"},[a._v("default")]),a._v(",\n                {\n                  useBuiltIns: "),t("span",{staticClass:"hljs-keyword"},[a._v("false")]),a._v(",\n                  targets: {node: "),t("span",{staticClass:"hljs-string"},[a._v("'current'")]),a._v("},\n                  ignoreBrowserslistConfig: "),t("span",{staticClass:"hljs-keyword"},[a._v("true")]),a._v(",\n                  exclude: ["),t("span",{staticClass:"hljs-string"},[a._v("'transform-typeof-symbol'")]),a._v("],\n                },\n              ],\n            ],\n            plugins: [\n              [\n                require("),t("span",{staticClass:"hljs-string"},[a._v("'@babel/plugin-transform-runtime'")]),a._v(")."),t("span",{staticClass:"hljs-keyword"},[a._v("default")]),a._v(",\n                {\n                  absoluteRuntime: absoluteRuntimePath,\n                },\n              ],\n              require("),t("span",{staticClass:"hljs-string"},[a._v("'babel-plugin-dynamic-import-node'")]),a._v("),\n            ],\n          },\n        },\n      }\n    },\n  )\n}\n")])]),a._v(" "),t("p",{attrs:{"data-nodeid":"7708"}},[a._v("基于以上设计，对于 SSR 应用的编译流程（需要编译适配 Node.js 环境）使用方法为：")]),a._v(" "),t("pre",{staticClass:"lang-java",attrs:{"data-nodeid":"7709"}},[t("code",{attrs:{"data-language":"java"}},[t("span",{staticClass:"hljs-comment"},[a._v("// webpack.config.js")]),a._v("\n"),t("span",{staticClass:"hljs-keyword"},[a._v("const")]),a._v(" target = process.env.BUILD_TARGET "),t("span",{staticClass:"hljs-comment"},[a._v("// 'web' | 'node'")]),a._v("\n"),t("span",{staticClass:"hljs-keyword"},[a._v("module")]),a._v("."),t("span",{staticClass:"hljs-keyword"},[a._v("exports")]),a._v(" = {\n  target,\n  "),t("span",{staticClass:"hljs-keyword"},[a._v("module")]),a._v(": {\n    rules: [\n      {\n        test: /\\.js$/,\n        oneOf: [\n          {\n            exclude: /node_modules/,\n            loader: "),t("span",{staticClass:"hljs-string"},[a._v("'babel-loader'")]),a._v(",\n            options: {\n              cacheDirectory: "),t("span",{staticClass:"hljs-keyword"},[a._v("true")]),a._v(",\n              presets: [["),t("span",{staticClass:"hljs-string"},[a._v("'@lucas/babel-preset/app'")]),a._v(", {target}]],\n            },\n          },\n          {\n            loader: "),t("span",{staticClass:"hljs-string"},[a._v("'babel-loader'")]),a._v(",\n            options: {\n              cacheDirectory: "),t("span",{staticClass:"hljs-keyword"},[a._v("true")]),a._v(",\n              configFile: "),t("span",{staticClass:"hljs-keyword"},[a._v("false")]),a._v(",\n              presets: [["),t("span",{staticClass:"hljs-string"},[a._v("'@lucas/babel-preset/dependencies'")]),a._v(", {target}]],\n              compact: "),t("span",{staticClass:"hljs-keyword"},[a._v("false")]),a._v(",\n            },\n          },\n        ],\n      },\n    ],\n  },\n}\n")])]),a._v(" "),t("p",{attrs:{"data-nodeid":"7710"}},[a._v("我们同样按照"),t("code",{attrs:{"data-backticks":"1","data-nodeid":"7957"}},[a._v("node_modules")]),a._v("进行了区分，对于"),t("code",{attrs:{"data-backticks":"1","data-nodeid":"7959"}},[a._v("node_modules")]),a._v("第三方依赖，使用"),t("code",{attrs:{"data-backticks":"1","data-nodeid":"7961"}},[a._v("@lucas/babel-preset/dependencies")]),a._v("预设，同时传入"),t("code",{attrs:{"data-backticks":"1","data-nodeid":"7963"}},[a._v("target")]),a._v("参数。对于非"),t("code",{attrs:{"data-backticks":"1","data-nodeid":"7965"}},[a._v("node_modules")]),a._v("的业务代码，使用"),t("code",{attrs:{"data-backticks":"1","data-nodeid":"7967"}},[a._v("@lucas/babel-preset/app")]),a._v("这个预设，同时设定相应环境 target，"),t("code",{attrs:{"data-backticks":"1","data-nodeid":"7969"}},[a._v("@lucas/babel-preset/app")]),a._v("内容为：")]),a._v(" "),t("pre",{staticClass:"lang-java",attrs:{"data-nodeid":"7711"}},[t("code",{attrs:{"data-language":"java"}},[t("span",{staticClass:"hljs-keyword"},[a._v("const")]),a._v(" path = require("),t("span",{staticClass:"hljs-string"},[a._v("'path'")]),a._v(")\n"),t("span",{staticClass:"hljs-keyword"},[a._v("const")]),a._v(" {declare} = require("),t("span",{staticClass:"hljs-string"},[a._v("'@babel/helper-plugin-utils'")]),a._v(")\n"),t("span",{staticClass:"hljs-keyword"},[a._v("const")]),a._v(" getAbsoluteRuntimePath = () => {\n  "),t("span",{staticClass:"hljs-keyword"},[a._v("return")]),a._v(" path.dirname(require.resolve("),t("span",{staticClass:"hljs-string"},[a._v("'@babel/runtime/package.json'")]),a._v("))\n}\n"),t("span",{staticClass:"hljs-keyword"},[a._v("module")]),a._v("."),t("span",{staticClass:"hljs-keyword"},[a._v("exports")]),a._v(" = ({\n  targets,\n  ignoreBrowserslistConfig = "),t("span",{staticClass:"hljs-keyword"},[a._v("false")]),a._v(",\n  forceAllTransforms = "),t("span",{staticClass:"hljs-keyword"},[a._v("false")]),a._v(",\n  transformRuntime = "),t("span",{staticClass:"hljs-keyword"},[a._v("true")]),a._v(",\n  absoluteRuntime = "),t("span",{staticClass:"hljs-keyword"},[a._v("false")]),a._v(",\n  supportsDynamicImport = "),t("span",{staticClass:"hljs-keyword"},[a._v("false")]),a._v(",\n} = {}) => {\n  "),t("span",{staticClass:"hljs-keyword"},[a._v("return")]),a._v(" declare(\n    (\n      api,\n      {\n        modules = "),t("span",{staticClass:"hljs-string"},[a._v("'auto'")]),a._v(",\n        absoluteRuntimePath = getAbsoluteRuntimePath(),\n        react = "),t("span",{staticClass:"hljs-keyword"},[a._v("true")]),a._v(",\n        presetReactOptions = {},\n      },\n    ) => {\n      api.assertVersion("),t("span",{staticClass:"hljs-number"},[a._v("7")]),a._v(")\n      "),t("span",{staticClass:"hljs-keyword"},[a._v("return")]),a._v(" {\n        presets: [\n          [\n            require("),t("span",{staticClass:"hljs-string"},[a._v("'@babel/preset-env'")]),a._v(")."),t("span",{staticClass:"hljs-keyword"},[a._v("default")]),a._v(",\n            {\n              useBuiltIns: "),t("span",{staticClass:"hljs-keyword"},[a._v("false")]),a._v(",\n              modules,\n              targets,\n              ignoreBrowserslistConfig,\n              forceAllTransforms,\n              exclude: ["),t("span",{staticClass:"hljs-string"},[a._v("'transform-typeof-symbol'")]),a._v("],\n            },\n          ],\n          react && [\n            require("),t("span",{staticClass:"hljs-string"},[a._v("'@babel/preset-react'")]),a._v(")."),t("span",{staticClass:"hljs-keyword"},[a._v("default")]),a._v(",\n            {useBuiltIns: "),t("span",{staticClass:"hljs-keyword"},[a._v("true")]),a._v(", runtime: "),t("span",{staticClass:"hljs-string"},[a._v("'automatic'")]),a._v(", ...presetReactOptions},\n          ],\n        ].filter(Boolean),\n        plugins: [\n          transformRuntime && [\n            require("),t("span",{staticClass:"hljs-string"},[a._v("'@babel/plugin-transform-runtime'")]),a._v(")."),t("span",{staticClass:"hljs-keyword"},[a._v("default")]),a._v(",\n            {\n              useESModules: "),t("span",{staticClass:"hljs-string"},[a._v("'auto'")]),a._v(",\n              absoluteRuntime: absoluteRuntime ? absoluteRuntimePath : "),t("span",{staticClass:"hljs-keyword"},[a._v("false")]),a._v(",\n            },\n          ],\n          "),t("span",{staticClass:"hljs-comment"},[a._v("// https://github.com/facebook/create-react-app/issues/4263")]),a._v("\n          [\n            require("),t("span",{staticClass:"hljs-string"},[a._v("'@babel/plugin-proposal-class-properties'")]),a._v(")."),t("span",{staticClass:"hljs-keyword"},[a._v("default")]),a._v(",\n            {loose: "),t("span",{staticClass:"hljs-keyword"},[a._v("true")]),a._v("},\n          ],\n          require("),t("span",{staticClass:"hljs-string"},[a._v("'@babel/plugin-syntax-dynamic-import'")]),a._v(")."),t("span",{staticClass:"hljs-keyword"},[a._v("default")]),a._v(",\n          !supportsDynamicImport &&\n            !api.caller(caller => caller && caller.supportsDynamicImport) &&\n            require("),t("span",{staticClass:"hljs-string"},[a._v("'babel-plugin-dynamic-import-node'")]),a._v("),\n          [\n            require("),t("span",{staticClass:"hljs-string"},[a._v("'@babel/plugin-proposal-object-rest-spread'")]),a._v(")."),t("span",{staticClass:"hljs-keyword"},[a._v("default")]),a._v(",\n            {loose: "),t("span",{staticClass:"hljs-keyword"},[a._v("true")]),a._v(", useBuiltIns: "),t("span",{staticClass:"hljs-keyword"},[a._v("true")]),a._v("},\n          ],\n          require("),t("span",{staticClass:"hljs-string"},[a._v("'@babel/plugin-proposal-nullish-coalescing-operator'")]),a._v(")."),t("span",{staticClass:"hljs-keyword"},[a._v("default")]),a._v(",\n          require("),t("span",{staticClass:"hljs-string"},[a._v("'@babel/plugin-proposal-optional-chaining'")]),a._v(")."),t("span",{staticClass:"hljs-keyword"},[a._v("default")]),a._v(",\n        ].filter(Boolean),\n        env: {\n          development: {\n            presets: [\n              react && [\n                require("),t("span",{staticClass:"hljs-string"},[a._v("'@babel/preset-react'")]),a._v(")."),t("span",{staticClass:"hljs-keyword"},[a._v("default")]),a._v(",\n                {\n                  useBuiltIns: "),t("span",{staticClass:"hljs-keyword"},[a._v("true")]),a._v(",\n                  development: "),t("span",{staticClass:"hljs-keyword"},[a._v("true")]),a._v(",\n                  runtime: "),t("span",{staticClass:"hljs-string"},[a._v("'automatic'")]),a._v(",\n                  ...presetReactOptions,\n                },\n              ],\n            ].filter(Boolean),\n          },\n          test: {\n            presets: [\n              [\n                require("),t("span",{staticClass:"hljs-string"},[a._v("'@babel/preset-env'")]),a._v(")."),t("span",{staticClass:"hljs-keyword"},[a._v("default")]),a._v(",\n                {\n                  useBuiltIns: "),t("span",{staticClass:"hljs-keyword"},[a._v("false")]),a._v(",\n                  targets: {node: "),t("span",{staticClass:"hljs-string"},[a._v("'current'")]),a._v("},\n                  ignoreBrowserslistConfig: "),t("span",{staticClass:"hljs-keyword"},[a._v("true")]),a._v(",\n                  exclude: ["),t("span",{staticClass:"hljs-string"},[a._v("'transform-typeof-symbol'")]),a._v("],\n                },\n              ],\n              react && [\n                require("),t("span",{staticClass:"hljs-string"},[a._v("'@babel/preset-react'")]),a._v(")."),t("span",{staticClass:"hljs-keyword"},[a._v("default")]),a._v(",\n                {\n                  useBuiltIns: "),t("span",{staticClass:"hljs-keyword"},[a._v("true")]),a._v(",\n                  development: "),t("span",{staticClass:"hljs-keyword"},[a._v("true")]),a._v(",\n                  runtime: "),t("span",{staticClass:"hljs-string"},[a._v("'automatic'")]),a._v(",\n                  ...presetReactOptions,\n                },\n              ],\n            ].filter(Boolean),\n            plugins: [\n              [\n                require("),t("span",{staticClass:"hljs-string"},[a._v("'@babel/plugin-transform-runtime'")]),a._v(")."),t("span",{staticClass:"hljs-keyword"},[a._v("default")]),a._v(",\n                {\n                  useESModules: "),t("span",{staticClass:"hljs-string"},[a._v("'auto'")]),a._v(",\n                  absoluteRuntime: absoluteRuntimePath,\n                },\n              ],\n              require("),t("span",{staticClass:"hljs-string"},[a._v("'babel-plugin-dynamic-import-node'")]),a._v("),\n            ],\n          },\n        },\n      }\n    },\n  )\n}\n")])]),a._v(" "),t("p",{attrs:{"data-nodeid":"7712"}},[a._v("而对于一个公共库，使用方式为：")]),a._v(" "),t("pre",{staticClass:"lang-java",attrs:{"data-nodeid":"7713"}},[t("code",{attrs:{"data-language":"java"}},[t("span",{staticClass:"hljs-comment"},[a._v("// babel.config.js")]),a._v("\n"),t("span",{staticClass:"hljs-keyword"},[a._v("module")]),a._v("."),t("span",{staticClass:"hljs-keyword"},[a._v("exports")]),a._v(" = {\n  presets: ["),t("span",{staticClass:"hljs-string"},[a._v("'@lucas/babel-preset/library'")]),a._v("],\n}\n")])]),a._v(" "),t("p",{attrs:{"data-nodeid":"7714"}},[a._v("对应"),t("code",{attrs:{"data-backticks":"1","data-nodeid":"7973"}},[a._v("@lucas/babel-preset/library")]),a._v("内容为：")]),a._v(" "),t("pre",{staticClass:"lang-java",attrs:{"data-nodeid":"7715"}},[t("code",{attrs:{"data-language":"java"}},[t("span",{staticClass:"hljs-keyword"},[a._v("const")]),a._v(" create = require("),t("span",{staticClass:"hljs-string"},[a._v("'../app/create'")]),a._v(")\n"),t("span",{staticClass:"hljs-keyword"},[a._v("module")]),a._v("."),t("span",{staticClass:"hljs-keyword"},[a._v("exports")]),a._v(" = create({\n  targets: {node: "),t("span",{staticClass:"hljs-string"},[a._v("'current'")]),a._v("},\n  ignoreBrowserslistConfig: "),t("span",{staticClass:"hljs-keyword"},[a._v("true")]),a._v(",\n  supportsDynamicImport: "),t("span",{staticClass:"hljs-keyword"},[a._v("true")]),a._v(",\n})\n")])]),a._v(" "),t("p",{attrs:{"data-nodeid":"7716"}},[a._v("这里的预设会将公共库按照当前 Node.js 环境标准编译。如果需要将该公共库编译降级到 ES5，需要使用"),t("code",{attrs:{"data-backticks":"1","data-nodeid":"7976"}},[a._v("@lucas/babel-preset/library/compact")]),a._v("内容为：")]),a._v(" "),t("pre",{staticClass:"lang-java",attrs:{"data-nodeid":"7717"}},[t("code",{attrs:{"data-language":"java"}},[t("span",{staticClass:"hljs-keyword"},[a._v("const")]),a._v(" create = require("),t("span",{staticClass:"hljs-string"},[a._v("'../app/create'")]),a._v(")\n"),t("span",{staticClass:"hljs-keyword"},[a._v("module")]),a._v("."),t("span",{staticClass:"hljs-keyword"},[a._v("exports")]),a._v(" = create({\n  ignoreBrowserslistConfig: "),t("span",{staticClass:"hljs-keyword"},[a._v("true")]),a._v(",\n  supportsDynamicImport: "),t("span",{staticClass:"hljs-keyword"},[a._v("true")]),a._v(",\n})\n")])]),a._v(" "),t("p",{attrs:{"data-nodeid":"7718"}},[a._v("这里的"),t("code",{attrs:{"data-backticks":"1","data-nodeid":"7979"}},[a._v("../app/create.js")]),a._v("即为上述"),t("code",{attrs:{"data-backticks":"1","data-nodeid":"7981"}},[a._v("@lucas/babel-preset/app")]),a._v("内容。")]),a._v(" "),t("p",{attrs:{"data-nodeid":"7719"}},[a._v("我们通过图示来表述整体架构：")]),a._v(" "),t("p",{attrs:{"data-nodeid":"7720"}},[t("img",{attrs:{src:"https://s0.lgstatic.com/i/image/M00/8C/C6/CgqCHl_0Bs2AS-oEABN0rwjVVsY144.png",alt:"Drawing 1.png","data-nodeid":"7986"}})]),a._v(" "),t("p",{attrs:{"data-nodeid":"7721"}},[a._v("需要说明以下内容。")]),a._v(" "),t("p",{attrs:{"data-nodeid":"7722"}},[t("strong",{attrs:{"data-nodeid":"8011"}},[a._v("1. @lucas/babel-preset/app：")]),t("br"),a._v("\n应用项目使用，编译项目代码。SSR 项目可以配置参数 target: 'web' | 'node'。"),t("strong",{attrs:{"data-nodeid":"8012"}},[a._v("默认支持 JSX 语法，并支持一些常用的语法提案")]),a._v("(如 class properties)。")]),a._v(" "),t("ul",{attrs:{"data-nodeid":"7723"}},[t("li",{attrs:{"data-nodeid":"7724"}},[t("p",{attrs:{"data-nodeid":"7725"}},[a._v("web：开启全部 transforms")])]),a._v(" "),t("li",{attrs:{"data-nodeid":"7726"}},[t("p",{attrs:{"data-nodeid":"7727"}},[a._v("node：编译到 node: 'current'")])])]),a._v(" "),t("p",{attrs:{"data-nodeid":"7728"}},[t("strong",{attrs:{"data-nodeid":"8042"}},[a._v("2. @lucas/babel-preset/dependencies")]),a._v("：应用项目使用，编译 node_modules。SSR 项目可以配置参数 target: 'web' | 'node'。"),t("strong",{attrs:{"data-nodeid":"8043"}},[a._v("只支持当前 ES 规范包含的语法，不包含 JSX 语法及提案中的语法支持")]),a._v("。")]),a._v(" "),t("ul",{attrs:{"data-nodeid":"7729"}},[t("li",{attrs:{"data-nodeid":"7730"}},[t("p",{attrs:{"data-nodeid":"7731"}},[a._v("web：开启全部 transforms")])]),a._v(" "),t("li",{attrs:{"data-nodeid":"7732"}},[t("p",{attrs:{"data-nodeid":"7733"}},[a._v("node：编译到 node: 'current'")])])]),a._v(" "),t("p",{attrs:{"data-nodeid":"7734"}},[t("strong",{attrs:{"data-nodeid":"8065"}},[a._v("3. @lucas/babel-preset/library：")]),a._v(" 公共库项目使用。用于 prepare 阶段的 Babel 编译。(如 ./src 通过 Babel 编译到 ./lib)。"),t("strong",{attrs:{"data-nodeid":"8066"}},[a._v("默认支持 JSX 语法，并支持一些常用的语法提案")]),a._v("(如 class properties)。编译到 node: 'current'。如果需要将 library 编译为 ES5，需要使用 @lucas/babel-preset/library/compat；library 打包编译为 UMD，使用 @lucas/babel-preset/app。")]),a._v(" "),t("p",{attrs:{"data-nodeid":"7735"}},[a._v("上述设计，我参考了"),t("a",{attrs:{href:"https://github.com/facebook/create-react-app/blob/master/packages/babel-preset-react-app/create.js","data-nodeid":"8070"}},[a._v("facebook/create-react-app")]),a._v("部分内容，建议你阅读源码，并结合注释理解其细节，比如"),t("a",{attrs:{href:"https://github.com/facebook/create-react-app/blob/master/packages/babel-preset-react-app/create.js#L87","data-nodeid":"8074"}},[a._v("对于 transform-typeof-symbol 的编译")]),a._v("：")]),a._v(" "),t("pre",{staticClass:"lang-java",attrs:{"data-nodeid":"7736"}},[t("code",{attrs:{"data-language":"java"}},[a._v("(isEnvProduction || isEnvDevelopment) && [\n    "),t("span",{staticClass:"hljs-comment"},[a._v("// 最新稳定的 ECMAScript 特性")]),a._v("\n    require("),t("span",{staticClass:"hljs-string"},[a._v("'@babel/preset-env'")]),a._v(")."),t("span",{staticClass:"hljs-keyword"},[a._v("default")]),a._v(",\n    {\n      useBuiltIns: "),t("span",{staticClass:"hljs-string"},[a._v("'entry'")]),a._v(",\n      corejs: "),t("span",{staticClass:"hljs-number"},[a._v("3")]),a._v(",\n      "),t("span",{staticClass:"hljs-comment"},[a._v("// 排除 transform-typeof-symbol，这会让编译过慢")]),a._v("\n      exclude: ["),t("span",{staticClass:"hljs-string"},[a._v("'transform-typeof-symbol'")]),a._v("],\n    },\n  ],\n")])]),a._v(" "),t("p",{attrs:{"data-nodeid":"7737"}},[a._v("在使用"),t("code",{attrs:{"data-backticks":"1","data-nodeid":"8077"}},[a._v("@babel/preset-env")]),a._v("时，使用了"),t("code",{attrs:{"data-backticks":"1","data-nodeid":"8079"}},[a._v("useBuiltIns: 'entry'")]),a._v("设置 polyfills，同时将"),t("code",{attrs:{"data-backticks":"1","data-nodeid":"8081"}},[a._v("@babel/plugin-transform-typeof-symbol")]),a._v("排除在外，这是因为"),t("code",{attrs:{"data-backticks":"1","data-nodeid":"8083"}},[a._v("@babel/plugin-transform-typeof-symbol")]),a._v("会劫持 typeof 特性，使得代码运行时变慢。相关讨论可参见 "),t("a",{attrs:{href:"https://github.com/facebook/create-react-app/pull/5278","data-nodeid":"8087"}},[a._v("issue")]),a._v("。")]),a._v(" "),t("p",{attrs:{"data-nodeid":"7738"}},[a._v("最后，这里的预设规范并不代表完全的最佳实践，而是以 React 技术栈风格，统一一个企业级公共库和接入准则，Babel 编译预设可以按照实际项目和企业的需要进行设计，这里更多是一个启迪的作用。")]),a._v(" "),t("h3",{attrs:{"data-nodeid":"7739"}},[a._v("总结")]),a._v(" "),t("p",{attrs:{"data-nodeid":"7740"}},[a._v("这一讲我们从一个“线上问题”出发，剖析了公共库和应用方的不同编译理念，并通过设计一个万能 Babel 预设，阐明了公共库的编译和应用的使用需要密切配合，才能在当前前端生态中保障一个更合理的基础建设根基。相关知识并未完结，我们将在下一讲中，从零打造一个公共库来实践说明相关理论。")]),a._v(" "),t("p",{staticClass:"te-preview-highlight",attrs:{"data-nodeid":"7741"}},[t("img",{attrs:{src:"https://s0.lgstatic.com/i/image2/M01/04/A4/Cip5yF_0OaOAPb48AAf5-twsvFI497.png",alt:"前端基建 金句.png","data-nodeid":"8094"}})]),a._v(" "),t("hr"),a._v(" "),t("h3",{attrs:{id:"精选评论"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#精选评论"}},[a._v("#")]),a._v(" 精选评论")]),a._v(" "),t("h5",{attrs:{id:"鹏"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#鹏"}},[a._v("#")]),a._v(" *鹏：")]),a._v(" "),t("blockquote",[t("p",[a._v("看完两眼一抹黑，懵逼了。 对babel零基础的应该先从哪下手？")])]),a._v(" "),t("h6",{attrs:{id:"讲师回复"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#讲师回复"}},[a._v("#")]),a._v("     讲师回复：")]),a._v(" "),t("blockquote",[t("p",[a._v("    官网和社区资料")])]),a._v(" "),t("h5",{attrs:{id:"用户7560"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#用户7560"}},[a._v("#")]),a._v(" **用户7560：")]),a._v(" "),t("blockquote",[t("p",[a._v("为啥感觉这些东西没用过呢， 我们用的preset是 @babel/preset-env这个东西")])]),a._v(" "),t("h6",{attrs:{id:"讲师回复-2"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#讲师回复-2"}},[a._v("#")]),a._v("     讲师回复：")]),a._v(" "),t("blockquote",[t("p",[a._v("    都是 @babel/preset-env，里面配置有所区别")])]),a._v(" "),t("h5",{attrs:{id:"_0216"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_0216"}},[a._v("#")]),a._v(" **0216：")]),a._v(" "),t("blockquote",[t("p",[a._v("老师讲的太好了，公共库开发体验有什么好的办法吗？最近就在写一个ui库，和业务方不是monorepo，就遇到了调试问题，现在用的方法是 nodemon 监控ui库文件变化，然后使用 yalc publish，业务方则用 yalc add modules 实现热更新调试。不过这个办法业务方取到的是编译后的 dist 文件，断点调试就很不方便")])]),a._v(" "),t("h6",{attrs:{id:"讲师回复-3"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#讲师回复-3"}},[a._v("#")]),a._v("     讲师回复：")]),a._v(" "),t("blockquote",[t("p",[a._v("    这么看一般使用 yarn/npm link 吧。这个问题不是 monorepo 的问题，是任何一个公共库都会遇见的问题。因此其实并不算一个问题，你作为库的开发者，应当保证发版后的可用性，而业务做或者不做相应的升级")])]),a._v(" "),t("h5",{attrs:{id:"_8621"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_8621"}},[a._v("#")]),a._v(" **8621：")]),a._v(" "),t("blockquote",[t("p",[a._v("这篇太难了，目前水平看不太懂，好困惑，等我再学习学习babel再来……😨")])]),a._v(" "),t("h6",{attrs:{id:"编辑回复"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#编辑回复"}},[a._v("#")]),a._v("     编辑回复：")]),a._v(" "),t("blockquote",[t("p",[a._v("    加油~")])]),a._v(" "),t("h5",{attrs:{id:"黎"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#黎"}},[a._v("#")]),a._v(" **黎：")]),a._v(" "),t("blockquote",[t("p",[a._v("我刚看完这篇就遇到了一个ios10.2的白屏问题，秒解决😀")])]),a._v(" "),t("h5",{attrs:{id:"黎-2"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#黎-2"}},[a._v("#")]),a._v(" **黎：")]),a._v(" "),t("blockquote",[t("p",[a._v("babel感觉自己很陌生，有什么好的学习资料吗？")])]),a._v(" "),t("h6",{attrs:{id:"讲师回复-4"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#讲师回复-4"}},[a._v("#")]),a._v("     讲师回复：")]),a._v(" "),t("blockquote",[t("p",[a._v("    官网，官网吃透，你就比我强~")])]),a._v(" "),t("h5",{attrs:{id:"darcy"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#darcy"}},[a._v("#")]),a._v(" Darcy：")]),a._v(" "),t("blockquote",[t("p",[a._v("期待新章节")])]),a._v(" "),t("h6",{attrs:{id:"编辑回复-2"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#编辑回复-2"}},[a._v("#")]),a._v("     编辑回复：")]),a._v(" "),t("blockquote",[t("p",[a._v("    周1/3更新哈，下一讲也干货满满！")])]),a._v(" "),t("h5",{attrs:{id:"俊"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#俊"}},[a._v("#")]),a._v(" *俊：")]),a._v(" "),t("blockquote",[t("p",[a._v("作为前端工程化的内容很好，迫不及待看完")])])])}),[],!1,null,null,null);t.default=n.exports}}]);